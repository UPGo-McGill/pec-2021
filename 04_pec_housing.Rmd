# The housing situation in Prince Edward County

<style type="text/css">
  body{
  font-family: Futura, Helvetica, Arial;
}
</style>

<br>

```{r setup, include = FALSE, echo = FALSE}

library(here)
source(here("R", "01_startup.R"))

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# Function for checking file modifications
mtime <- function(files) lapply(Sys.glob(files), function(x) file.info(x)$mtime)

# Set this to TRUE to output PDF figures
build_figures <- TRUE

```

```{r housing_objects, cache=TRUE, cache.lazy=FALSE}

qload(here("output", "home_sales.qsm"), nthreads = availableCores())
qload(here("output", "geometry.qsm"), nthreads = availableCores())

DA_housing <- 
  cancensus::get_census(
    dataset = "CA16", regions = list(CSD = c("3513020")), level = "DA",
    vectors = c("v_CA16_4836", "v_CA16_4838", "v_CA16_4837", "v_CA16_4901", 
                "v_CA16_4899", "v_CA16_4894", "v_CA16_6698", "v_CA16_6692", 
                "v_CA16_6725", "v_CA16_6719", "v_CA16_4896", "v_CA16_4892"),
    geo_format = "sf") %>% 
  st_transform(32618) %>% 
  select(-c(`Shape Area`:Households, CSD_UID:`Area (sq km)`)) %>% 
  set_names(c("dwellings", "GeoUID", "parent_tenure", "renter", "owner", "average_rent",
              "p_thirty_renter", "average_ho_cost", "average_value_dwellings", "p_thirty_owner", 
              "mobility_one_year", "parent_mobility_one_year", "mobility_five_years", 
              "parent_mobility_five_years", "geometry")) %>% 
  mutate(p_mobility_one_year = mobility_one_year/parent_mobility_one_year,
         p_mobility_five_years = mobility_five_years/parent_mobility_five_years,
         p_thirty_renter = p_thirty_renter / 100,
         p_thirty_owner = p_thirty_owner / 100) %>% 
  select(GeoUID, dwellings, renter, owner, average_rent, average_ho_cost, average_value_dwellings,
         p_thirty_renter, p_thirty_owner, p_mobility_one_year, p_mobility_five_years) %>% 
  as_tibble() %>% 
  st_as_sf(agr = "constant")

# Apply spatial interpolation to get census data by ward

EW_housing <- 
  DA_housing %>% 
  mutate(area = st_area(geometry)) %>% 
  st_set_agr("constant") %>% 
  mutate(thirty_renter = p_thirty_renter * renter,
         thirty_owner = p_thirty_owner * owner,
         mobility_one_year = p_mobility_one_year * dwellings,
         mobility_five_years = p_mobility_five_years * dwellings) %>% 
  select(GeoUID, dwellings, owner, renter, average_rent, average_ho_cost, average_value_dwellings,
         thirty_renter, thirty_owner, mobility_one_year, mobility_five_years, area)

avg_list <- str_subset(names(EW_housing), "average|p_") %>% 
  str_subset("total", negate = TRUE)

agg_list <-
  setdiff(names(EW_housing), c("GeoUID", "geometry", "area")) %>% 
  setdiff(avg_list)

round_list <- c("average_rent", "average_ho_cost", "average_value_dwellings", "dwellings", "renter", "owner")

EW_housing <- 
  EW %>% 
  select(ward) %>% 
  st_transform(32618) %>% 
  st_set_agr("constant") %>% 
  st_intersection(., EW_housing) %>% 
  mutate(area_prop = st_area(geometry) / area) %>% 
  mutate(across(all_of(agg_list), ~{.x * units::drop_units(area_prop)})) %>% 
  select(-GeoUID, -area, -area_prop) %>% 
  st_drop_geometry() %>% 
  group_by(ward) %>% 
  summarize(
    average_rent = weighted.mean(average_rent, renter, na.rm = TRUE),
    average_ho_cost = weighted.mean(average_ho_cost, owner, na.rm = TRUE),
    average_value_dwellings = weighted.mean(average_value_dwellings, owner, na.rm = TRUE),
    across(all_of(agg_list), sum, na.rm = TRUE)) %>% 
  mutate(p_thirty_renter = thirty_renter / renter,
         p_thirty_owner = thirty_owner / owner,
         p_mobility_one_year = mobility_one_year / dwellings,
         p_mobility_five_years = mobility_five_years / dwellings) %>% 
  select(-thirty_renter, -thirty_owner, -mobility_one_year, - mobility_five_years) %>% 
  mutate(across(all_of(round_list), ~round(., digit = 0))) %>% 
  left_join(., EW %>% select(ward), by = "ward") %>% 
  st_as_sf() %>% 
  st_transform(32618)

rm(agg_list, avg_list, round_list)

```

**TKTK**

<br>

## The housing context in Prince Edward County

In the past years, Prince Edward County's housing market experienced numerous changes. The rise of short-term rental platforms has put pressure on the county's housing stock, with housing units being dedicated to tourist accommodations on a full-time basis. Average rents have been increasing, and vacancy rates are remaining under unhealthy levels. The Covid-19 pandemic exacerbated challenges regarding housing affordability in the county by bringing in an influx of new buyers looking for a second home, in part due to remote work. The following section provides an assessment of the housing situation in the county for both homeowners and renters, with a specific focus on affordability and availability. The common definition of housing that is affordable for which the costs do not exceed 30% of the household's disposable income, or what the Canadian Mortgage and Housing Corporation defines as the shelter cost-income ratio (2020). Additionally, a healthy rental market is considered one in which the vacancy rate is of 3% of above (ACTO 2021).

## Being a homeowner in Prince Edward County

```{r para_1, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

p_thirty_owner_bloomfield <- 
  EW_housing %>% 
  st_drop_geometry %>% 
  arrange(desc(p_thirty_owner)) %>% 
  slice(1) %>% 
  pull(p_thirty_owner) %>%   
  scales::percent(accuracy = 0.1)

p_thirty_owner_athol <- 
  EW_housing %>% 
  st_drop_geometry %>% 
  arrange(p_thirty_owner) %>% 
  slice(1) %>% 
  pull(p_thirty_owner) %>%   
  scales::percent(accuracy = 0.1)

```

``` {r make_fig_1_1}

figure_1_1_fun <- function(regular = "", condensed = "") {
  
  left_map <- 
    DA_housing %>% 
    ggplot() +
    geom_sf(data = province, colour = "transparent", fill = "grey93") +
    geom_sf(aes(fill = p_thirty_owner), colour = "white") +
    geom_sf(data = water, fill = "white", colour = "transparent") +
    scale_fill_gradientn(colors = col_palette[c(5, 3, 4, 6)], 
                         na.value = "grey80",
                         limits = c(0.05, 0.25), oob = scales::squish, 
                         labels = scales::percent)  +
    guides(fill = guide_colourbar(title = "Percentage owner's\nhousing stress",
                                  title.vjust = 1)) + 
    gg_bbox(DA_housing) +
    theme_void() +
    theme(text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold",
                                      size = 7),
          legend.title.align = 0.9,
          legend.text = element_text(family = regular, size = 5),
          panel.border = element_rect(colour = "white", size = 2))
  
  right_map <- 
    EW_housing %>% 
    ggplot() +
    geom_sf(data = province, colour = "transparent", fill = "grey93") +
    geom_sf(aes(fill = p_thirty_owner), colour = "transparent") +
    geom_sf(data = water, fill = "white", colour = "transparent") +
    scale_fill_gradientn(colors = col_palette[c(5, 3, 4, 6)], 
                         na.value = "grey80",
                         limits = c(0.1, 0.2), oob = scales::squish, 
                         labels = scales::percent)  +
    guides(fill = guide_colourbar(title = "Percentage owner's\nhousing stress",
                                  title.vjust = 1)) + 
    gg_bbox(DA_housing) +
    theme_void() +
    theme(text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold",
                                      size = 7),
          legend.title.align = 0.9,
          legend.text = element_text(family = regular, size = 5),
          panel.border = element_rect(colour = "white", size = 2))
  
  left_map + right_map + plot_layout(guide = "collect") & 
    theme(legend.position = "bottom", legend.key.width = unit(1.8, "lines"))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_1.pdf"), 
         plot = figure_1_1_fun("Futura", "Futura Condensed"), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_1.pdf"))
}

```

From 2008 to 2018, the median home price in the county has almost doubled, going from $205K to $395K, an increase equivalent to seven times that of the increase in median household incomes (The County Foundation 2018). The influx of new homes in Prince Edward County is limited, with only 4.2% of housing units having been built between 2011-2016. By contrast, 61.0% of all homes in Prince Edward County were built prior to 1980. Based on the affordability measure above, 17.3% of homeowners are considered housing stressed. This percentage varies between ward, with Bloomfield having `r p_thirty_owner_bloomfield` of owners households spending more than 30% of their incomes on housing and Athol having the least housing-stressed households, with `r p_thirty_owner_athol`. Figure  \@ref(fig:fig-1-1) shows the geographic distribution of owner households in situation of housing stress by dissemination area (left) and by ward (right). The ward map displays a distinction between the level of housing stress between Western and Eastern wards.

``` {r fig-1-1, include = TRUE, fig.cap = '(ref:fig-1-1)', fig.align = "center"}

figure_1_1_fun()

```

(ref:fig-1-1) _Percentage of homeowners' housing stress by dissemination area (R) and ward (L)_

## The state of the real estate market in Prince Edward County

``` {r make_fig_1_2}

figure_1_2_fun <- function(regular = "", condensed = "") {
  
home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year_month = format(sale_date, "%Y-%m")) %>% 
  mutate(year_month = paste0(year_month, "-01")) %>% 
  mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
  group_by(year_month) %>% 
  summarize(n=n(), mean_sale = mean(sale_price, na.rm=TRUE)) %>% 
  ggplot() +
  geom_line(aes(year_month, n), color = col_palette[5], lwd=1)+
  scale_y_continuous(name = NULL, label = scales::comma) +
  scale_x_date(name = NULL, date_breaks = "1 year", minor_breaks = NULL,
               date_labels = c("2021", "2016", "2017", "2018", "2019", "2020"))+
  theme_minimal() +
  theme(legend.position = "bottom", panel.grid.minor.x = element_blank(),
        text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_2.pdf"), 
         plot = figure_1_2_fun("Futura", "Futura Condensed"), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_2.pdf"))
}

```

The following section provides an overview of the state of the homeownership market in the County. With a relatively stable number of housing units available, the county is experiencing additional pressure in the past few years, which cannot be measured through 2016 census data. Two external market forces, namely short-term rentals and secondary home purchases by households from urban areas, have caused property prices to increases. According to Charles Dowdall, the largest year-over-year increases in housing sale prices occurred in the June 2020-June 2021 period, with an increase of 79.9%. To conduct an analysis of the homeownership market, our team was provided by the Prince Edward County Real Estate Board with a dataset of every residential real estate transaction in the county from 2016, totaling 3,017 sales. Figure \@ref(fig:fig-1-2) below summarizes the number of residential real estate sales in the county, starting on 6 January 2016.

``` {r fig-1-2, include = TRUE, fig.cap = '(ref:fig-1-2)', fig.align = "center"}

figure_1_2_fun()

```

(ref:fig-1-2) _Monthly number of property sales in Prince Edward County_

```{r para_3, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

peak_housing_sale <- 
  home_sales %>% 
   st_drop_geometry() %>% 
   mutate(year_month = format(sale_date, "%Y-%m")) %>% 
   mutate(year_month = paste0(year_month, "-01")) %>% 
   mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
   group_by(year_month) %>% 
   summarize(n=n(), mean_sale = mean(sale_price, na.rm=TRUE)) %>% 
   arrange(desc(n)) %>% 
   slice(1) %>% 
   pull(n)

second_peak_housing_sale <- 
  home_sales %>% 
   st_drop_geometry() %>% 
   mutate(year_month = format(sale_date, "%Y-%m")) %>% 
   mutate(year_month = paste0(year_month, "-01")) %>% 
   mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
   group_by(year_month) %>% 
   summarize(n=n(), mean_sale = mean(sale_price, na.rm=TRUE)) %>% 
   arrange(desc(n)) %>% 
   slice(2) %>% 
   pull(n)

dec_2020_sale_price <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year_month = format(sale_date, "%Y-%m")) %>% 
  mutate(year_month = paste0(year_month, "-01")) %>% 
  mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
  group_by(year_month) %>% 
  summarize(n=n(), mean_sale = mean(sale_price, na.rm=TRUE)) %>% 
  arrange(desc(mean_sale)) %>% 
  slice(1) %>% 
  pull(mean_sale) %>% 
  round(digit = -2) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

home_sales_variation <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year_month = format(sale_date, "%Y-%m")) %>% 
  mutate(year_month = paste0(year_month, "-01")) %>% 
  mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
  group_by(year_month) %>% 
  summarize("Number of sales" = n(), "Average sale price" = mean(sale_price, na.rm=TRUE)) %>% 
  mutate(across(where(is.numeric), 
                function(x) slide_dbl(x, ~{(.x[13] - .x[1]) / .x[1]}, 
                                      .before = 12, .complete = FALSE))) %>% 
  pivot_longer(-year_month, names_to = "var", values_to = "value") %>% 
  group_by(var) %>% 
  mutate(value = slide_dbl(value, mean, .before = 0, .complete = TRUE)) %>% 
  ungroup() %>% 
  filter(year_month >= "2017-01-01")

yoy_sale_2021 <- 
  home_sales_variation %>% 
  filter(var == "Average sale price") %>% 
  arrange(desc(value)) %>% 
  slice(2) %>% 
  pull(value) %>% 
  scales::percent(0.1)

```

``` {r make_fig_1_3}

figure_1_3_fun <- function(regular = "", condensed = "") {
  
home_sales_variation %>% 
  ggplot(aes(year_month, value, colour = var)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  geom_line(lwd = 1, na.rm = TRUE) +
  scale_x_date(name = NULL) +
  scale_y_continuous(name = NULL, limits = c(-1, NA), 
                     labels = scales::percent) +
  scale_color_manual(name = NULL, values = col_palette[c(1, 3)]) +
  theme_minimal() +
  theme(legend.position = "bottom", panel.grid.minor.x = element_blank(),
        text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_3.pdf"), 
         plot = figure_1_3_fun("Futura", "Futura Condensed"), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_3.pdf"))
}

```

There is a high increase in the number of residential sales starting in the second half of 2020, with the peak of real estate sales being in July 2020, with a total of `r peak_housing_sale` property sales, followed by `r second_peak_housing_sale` in September of 2020. This peak in property sales has also been accompanied by large increases in average sale prices, with a peak average sale price in December 2020 of `r dec_2020_sale_price`. This number is a staggering year-over-year increase of `r yoy_sale_2021` compared to the same month the year before. Figure \@ref(fig:fig-1-3) summarizes the year-over-year changes in the number of sales and sale price per month.

``` {r fig-1-3, include = TRUE, fig.cap = '(ref:fig-1-3)', fig.align = "center"}

figure_1_3_fun()

```

(ref:fig-1-3) _Year-over-year changes in monthly real estate sales and average sale prices_

```{r para_4, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

list_ask_price <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year_month = format(sale_date, "%Y-%m")) %>% 
  mutate(year_month = paste0(year_month, "-01")) %>% 
  mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
  mutate(diff_price = sale_price - list_price) %>% 
  group_by(year_month) %>% 
  summarize(diff_price = mean(diff_price, na.rm=TRUE))

DOM <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year_month = format(sale_date, "%Y-%m")) %>% 
  mutate(year_month = paste0(year_month, "-01")) %>% 
  mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
  group_by(year_month) %>% 
  summarize(avg_DOM = mean(DOM, na.rm=TRUE))

DOM_2019 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  group_by(year) %>% 
  summarize(avg_DOM = round(mean(DOM, na.rm=TRUE), digit=0)) %>% 
  filter(year == 2019) %>% 
  pull(avg_dom)

DOM_2020 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  group_by(year) %>% 
  summarize(avg_DOM = round(mean(DOM, na.rm=TRUE), digit=0)) %>% 
  filter(year == 2020) %>% 
  pull(avg_dom)

DOM_2021 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  group_by(year) %>% 
  summarize(avg_DOM = round(mean(DOM, na.rm=TRUE), digit=0)) %>% 
  filter(year == 2021) %>% 
  pull(avg_dom)

diff_2020 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  mutate(diff_price = sale_price - list_price) %>% 
  group_by(year) %>% 
  summarize(diff_price = round(mean(diff_price, na.rm=TRUE), digit=-1)) %>% 
  filter(year == 2020) %>% 
  pull(diff_price) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

diff_2021 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  mutate(diff_price = sale_price - list_price) %>% 
  group_by(year) %>% 
  summarize(diff_price = round(mean(diff_price, na.rm=TRUE), digit=-1)) %>% 
  filter(year == 2021) %>% 
  pull(diff_price) %>% 
  prettyNum(",") %>% 
  paste0("$", .)


```

``` {r make_fig_1_4}

figure_1_4_fun <- function(regular = "", condensed = "") {
  
left_fig <- 
  DOM %>% 
  ggplot() +
  geom_line(aes(year_month, avg_DOM), color = col_palette[2], lwd=1)+
  scale_y_continuous(name = NULL, label = scales::comma) +
  scale_x_date(name = NULL, date_breaks = "1 year", minor_breaks = NULL,
               date_labels = c("2021", "2016", "2017", "2018", "2019", "2020"))+
  theme_minimal() +
  theme(legend.position = "bottom", panel.grid.minor.x = element_blank(), 
        text = element_text(family = regular))

right_fig <- 
  list_ask_price %>% 
  ggplot() +
  geom_line(aes(year_month, diff_price), color = col_palette[3], lwd=1)+
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  scale_y_continuous(name = NULL, label = scales::dollar) +
  scale_x_date(name = NULL, date_breaks = "1 year", minor_breaks = NULL,
               date_labels = c("2021", "2016", "2017", "2018", "2019", "2020"))+
  theme_minimal() +
  theme(legend.position = "bottom", panel.grid.minor.x = element_blank(), 
        text = element_text(family = regular))

  left_fig + right_fig + plot_layout(guide = "collect") & 
    theme(legend.position = "bottom", legend.key.width = unit(1.8, "lines"))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_4.pdf"), 
         plot = figure_1_4_fun("Futura", "Futura Condensed"), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_4.pdf"))
}

```

There are numerous proxies that can help us assess the state of the real estate market in a given geography in addition to yearly changes in the number of home sales and average sale prices.The number of days on the market and the difference between asking price and sale price are two indicators of a hot real estate market. Figure \@ref(fig:fig-1-4) shows both of those indicators. The that the average days on the market for the properties decreased in 2020 and even more so in 2021. The year with the highest average of days in the market is 2019 with `r DOM_2019` days. The following two years experienced declining averages, with properties in 2020 being sold after `r DOM_2020` days on average, and 2021 displaying the lowest average in the available data at `r DOM_2021` days. This speed in property sales is also accompanied by sale prices higher than the original asking prices starting late 2020. The only positive yearly average between the list price and the sale price is 2021 with `r diff_2021`, with 2020 having the smallest negative difference at `r diff_2020`

``` {r fig-1-4, include = TRUE, fig.cap = '(ref:fig-1-4)', fig.align = "center"}

figure_1_4_fun()

```

(ref:fig-1-4) _Monthly averages for days on the market (right) and difference between asking and sale prices (left)_



\newpage
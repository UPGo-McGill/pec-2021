# The housing situation in Prince Edward County

<style type="text/css">
  body{
  font-family: Futura, Helvetica, Arial;
}
</style>

<br>

```{r setup, include = FALSE, echo = FALSE}

library(here)
source(here("R", "01_startup.R"))

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# Function for checking file modifications
mtime <- function(files) lapply(Sys.glob(files), function(x) file.info(x)$mtime)

# Set this to TRUE to output PDF figures
build_figures <- TRUE

```

```{r housing_objects, cache=TRUE, cache.lazy=FALSE}

qload(here("output", "home_sales.qsm"), nthreads = availableCores())
qload(here("output", "geometry.qsm"), nthreads = availableCores())


DA_housing <- 
  cancensus::get_census(
    dataset = "CA16", regions = list(CSD = c("3513020")), level = "DA",
    vectors = c("v_CA16_4836", "v_CA16_4838", "v_CA16_4837", "v_CA16_4901", 
                "v_CA16_4899", "v_CA16_4894", "v_CA16_6698", "v_CA16_6692", 
                "v_CA16_6725", "v_CA16_6719", "v_CA16_4896", "v_CA16_4892",
                "v_CA16_4986", "v_CA16_4984"),
    geo_format = "sf") %>% 
  st_transform(32618) %>% 
  select(-c(`Shape Area`:Households, CSD_UID:`Area (sq km)`)) %>% 
  set_names(c("dwellings", "GeoUID", "parent_tenure", "renter", "owner", "average_rent",
              "p_thirty_renter", "average_ho_cost", "average_value_dwellings", "p_thirty_owner", 
              "mobility_one_year", "parent_mobility_one_year", "mobility_five_years", 
              "parent_mobility_five_years", "at_hh_inc", "parent_hh", "geometry")) %>% 
  mutate(p_mobility_one_year = mobility_one_year/parent_mobility_one_year,
         p_mobility_five_years = mobility_five_years/parent_mobility_five_years,
         p_thirty_renter = p_thirty_renter / 100,
         p_thirty_owner = p_thirty_owner / 100) %>% 
  select(GeoUID, dwellings, renter, owner, average_rent, average_ho_cost, average_value_dwellings,
         p_thirty_renter, p_thirty_owner, p_mobility_one_year, p_mobility_five_years, at_hh_inc, parent_hh) %>% 
  as_tibble() %>% 
  st_as_sf(agr = "constant")

# Apply spatial interpolation to get census data by ward

EW_housing <- 
  DA_housing %>% 
  mutate(area = st_area(geometry)) %>% 
  st_set_agr("constant") %>% 
  mutate(thirty_renter = p_thirty_renter * renter,
         thirty_owner = p_thirty_owner * owner,
         mobility_one_year = p_mobility_one_year * dwellings,
         mobility_five_years = p_mobility_five_years * dwellings) %>% 
  select(GeoUID, dwellings, owner, renter, average_rent, average_ho_cost, average_value_dwellings,
         thirty_renter, thirty_owner, mobility_one_year, mobility_five_years, at_hh_inc, parent_hh, area)

avg_list <- str_subset(names(EW_housing), "average|p_|inc") %>% 
  str_subset("total", negate = TRUE)

agg_list <-
  setdiff(names(EW_housing), c("GeoUID", "geometry", "area")) %>% 
  setdiff(avg_list)

round_list <- c("average_rent", "average_ho_cost", "average_value_dwellings", "dwellings", "renter", "owner")

EW_housing <- 
  EW %>% 
  select(ward) %>% 
  st_transform(32618) %>% 
  st_set_agr("constant") %>% 
  st_intersection(., EW_housing) %>% 
  mutate(area_prop = st_area(geometry) / area) %>% 
  mutate(across(all_of(agg_list), ~{.x * units::drop_units(area_prop)})) %>% 
  select(-GeoUID, -area, -area_prop) %>% 
  st_drop_geometry() %>% 
  group_by(ward) %>% 
  summarize(
    average_rent = weighted.mean(average_rent, renter, na.rm = TRUE),
    average_ho_cost = weighted.mean(average_ho_cost, owner, na.rm = TRUE),
    average_value_dwellings = weighted.mean(average_value_dwellings, owner, na.rm = TRUE),
    at_hh_inc = weighted.mean(at_hh_inc, parent_hh, na.rm = TRUE),
    across(all_of(agg_list), sum, na.rm = TRUE)) %>% 
  mutate(p_thirty_renter = thirty_renter / renter,
         p_thirty_owner = thirty_owner / owner,
         p_mobility_one_year = mobility_one_year / dwellings,
         p_mobility_five_years = mobility_five_years / dwellings) %>% 
  select(-thirty_renter, -thirty_owner, -mobility_one_year, - mobility_five_years, -parent_hh) %>% 
  mutate(across(all_of(round_list), ~round(., digit = 0))) %>% 
  left_join(., EW %>% select(ward), by = "ward") %>% 
  st_as_sf() %>% 
  st_transform(32618)

rm(agg_list, avg_list, round_list)

```

**TKTK**

<br>

## The housing context in Prince Edward County

In the past years, Prince Edward County's housing market experienced numerous changes. The rise of short-term rental platforms has put pressure on the county's housing stock, with housing units being dedicated to tourist accommodations on a full-time basis. Average rents have been increasing, and vacancy rates are remaining under unhealthy levels. The Covid-19 pandemic exacerbated challenges regarding housing affordability in the county by bringing in an influx of new buyers looking for a second home, in part due to remote work. The following section provides an assessment of the housing situation in the county for both homeowners and renters, with a specific focus on affordability and availability. The common definition of housing that is affordable for which the costs do not exceed 30% of the household's disposable income, or what the Canadian Mortgage and Housing Corporation defines as the shelter cost-income ratio (2020). Additionally, a healthy rental market is considered one in which the vacancy rate is of 3% of above (ACTO 2021).

## Being a homeowner in Prince Edward County

```{r para_1, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

p_thirty_owner_bloomfield <- 
  EW_housing %>% 
  st_drop_geometry %>% 
  arrange(desc(p_thirty_owner)) %>% 
  slice(1) %>% 
  pull(p_thirty_owner) %>%   
  scales::percent(accuracy = 0.1)

p_thirty_owner_athol <- 
  EW_housing %>% 
  st_drop_geometry %>% 
  arrange(p_thirty_owner) %>% 
  slice(1) %>% 
  pull(p_thirty_owner) %>%   
  scales::percent(accuracy = 0.1)

```

``` {r make_fig_1_1}

figure_1_1_fun <- function(regular = "", condensed = "") {
  
  left_map <- 
    DA_housing %>% 
    ggplot() +
    geom_sf(data = province, colour = "transparent", fill = "grey93") +
    geom_sf(aes(fill = p_thirty_owner), colour = "white") +
    geom_sf(data = water, fill = "white", colour = "transparent") +
    scale_fill_gradientn(colors = col_palette[c(5, 3, 4, 6)], 
                         na.value = "grey80",
                         limits = c(0.05, 0.25), oob = scales::squish, 
                         labels = scales::percent)  +
    guides(fill = guide_colourbar(title = "Percentage owner's\nhousing stress",
                                  title.vjust = 1)) + 
    gg_bbox(DA_housing) +
    theme_void() +
    theme(text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold",
                                      size = 7),
          legend.title.align = 0.9,
          legend.text = element_text(family = regular, size = 5),
          panel.border = element_rect(colour = "white", size = 2))
  
  right_map <- 
    EW_housing %>% 
    ggplot() +
    geom_sf(data = province, colour = "transparent", fill = "grey93") +
    geom_sf(aes(fill = p_thirty_owner), colour = "transparent") +
    geom_sf(data = water, fill = "white", colour = "transparent") +
    scale_fill_gradientn(colors = col_palette[c(5, 3, 4, 6)], 
                         na.value = "grey80",
                         limits = c(0.1, 0.2), oob = scales::squish, 
                         labels = scales::percent)  +
    guides(fill = guide_colourbar(title = "Percentage owner's\nhousing stress",
                                  title.vjust = 1)) + 
    gg_bbox(DA_housing) +
    theme_void() +
    theme(text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold",
                                      size = 7),
          legend.title.align = 0.9,
          legend.text = element_text(family = regular, size = 5),
          panel.border = element_rect(colour = "white", size = 2))
  
  left_map + right_map + plot_layout(guide = "collect") & 
    theme(legend.position = "bottom", legend.key.width = unit(1.8, "lines"))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_1.pdf"), 
         plot = figure_1_1_fun("Futura", "Futura Condensed"), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_1.pdf"))
}

```

From 2008 to 2018, the median home price in the county has almost doubled, going from $205K to $395K, an increase equivalent to seven times that of the increase in median household incomes (The County Foundation 2018). The influx of new homes in Prince Edward County is limited, with only 4.2% of housing units having been built between 2011-2016. By contrast, 61.0% of all homes in Prince Edward County were built prior to 1980. Based on the affordability measure above, 17.3% of homeowners are considered housing stressed. This percentage varies between ward, with Bloomfield having `r p_thirty_owner_bloomfield` of owners households spending more than 30% of their incomes on housing and Athol having the least housing-stressed households, with `r p_thirty_owner_athol`. Figure  \@ref(fig:fig-1-1) shows the geographic distribution of owner households in situation of housing stress by dissemination area (left) and by ward (right). The ward map displays a distinction between the level of housing stress between Western and Eastern wards.

``` {r fig-1-1, include = TRUE, fig.cap = '(ref:fig-1-1)', fig.align = "center"}

figure_1_1_fun()

```

(ref:fig-1-1) _Percentage of homeowners' housing stress by dissemination area (R) and ward (L)_

## The current state of the real estate market in Prince Edward County

``` {r make_fig_1_2}

figure_1_2_fun <- function(regular = "", condensed = "") {
  
home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year_month = format(sale_date, "%Y-%m")) %>% 
  mutate(year_month = paste0(year_month, "-01")) %>% 
  mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
  group_by(year_month) %>% 
  summarize(n=n(), mean_sale = mean(sale_price, na.rm=TRUE)) %>% 
  ggplot() +
  geom_line(aes(year_month, n), color = col_palette[5], lwd=1)+
  scale_y_continuous(name = NULL, label = scales::comma) +
  scale_x_date(name = NULL, date_breaks = "1 year", minor_breaks = NULL,
               date_labels = c("2021", "2016", "2017", "2018", "2019", "2020"))+
  theme_minimal() +
  theme(legend.position = "bottom", panel.grid.minor.x = element_blank(),
        text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_2.pdf"), 
         plot = figure_1_2_fun("Futura", "Futura Condensed"), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_2.pdf"))
}

```

The following section provides an overview of the state of the homeownership market in the County. With a relatively stable number of housing units available, the county is experiencing additional pressure in the past few years, which cannot be measured through 2016 census data. Two external market forces, namely short-term rentals and secondary home purchases by households from urban areas, have caused property prices to increases. According to Charles Dowdall, the largest year-over-year increases in housing sale prices occurred in the June 2020-June 2021 period, with an increase of 79.9%. To conduct an analysis of the homeownership market, our team was provided by the Prince Edward County Real Estate Board with a dataset of every residential real estate transaction in the county from 2016, totaling 3,017 sales. Figure \@ref(fig:fig-1-2) below summarizes the number of residential real estate sales in the county, starting on 6 January 2016.

``` {r fig-1-2, include = TRUE, fig.cap = '(ref:fig-1-2)', fig.align = "center"}

figure_1_2_fun()

```

(ref:fig-1-2) _Monthly number of property sales in Prince Edward County_

```{r para_3, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

peak_housing_sale <- 
  home_sales %>% 
   st_drop_geometry() %>% 
   mutate(year_month = format(sale_date, "%Y-%m")) %>% 
   mutate(year_month = paste0(year_month, "-01")) %>% 
   mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
   group_by(year_month) %>% 
   summarize(n=n(), mean_sale = mean(sale_price, na.rm=TRUE)) %>% 
   arrange(desc(n)) %>% 
   slice(1) %>% 
   pull(n)

second_peak_housing_sale <- 
  home_sales %>% 
   st_drop_geometry() %>% 
   mutate(year_month = format(sale_date, "%Y-%m")) %>% 
   mutate(year_month = paste0(year_month, "-01")) %>% 
   mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
   group_by(year_month) %>% 
   summarize(n=n(), mean_sale = mean(sale_price, na.rm=TRUE)) %>% 
   arrange(desc(n)) %>% 
   slice(2) %>% 
   pull(n)

dec_2020_sale_price <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year_month = format(sale_date, "%Y-%m")) %>% 
  mutate(year_month = paste0(year_month, "-01")) %>% 
  mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
  group_by(year_month) %>% 
  summarize(n=n(), mean_sale = mean(sale_price, na.rm=TRUE)) %>% 
  arrange(desc(mean_sale)) %>% 
  slice(1) %>% 
  pull(mean_sale) %>% 
  round(digit = -2) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

home_sales_variation <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year_month = format(sale_date, "%Y-%m")) %>% 
  mutate(year_month = paste0(year_month, "-01")) %>% 
  mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
  group_by(year_month) %>% 
  summarize("Number of sales" = n(), "Average sale price" = mean(sale_price, na.rm=TRUE)) %>% 
  mutate(across(where(is.numeric), 
                function(x) slide_dbl(x, ~{(.x[13] - .x[1]) / .x[1]}, 
                                      .before = 12, .complete = FALSE))) %>% 
  pivot_longer(-year_month, names_to = "var", values_to = "value") %>% 
  group_by(var) %>% 
  mutate(value = slide_dbl(value, mean, .before = 0, .complete = TRUE)) %>% 
  ungroup() %>% 
  filter(year_month >= "2017-01-01")

n_sale_2016 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2016) %>% 
  pull(n)

avg_sale_2016 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2016) %>% 
  pull(avg) %>%
  scales::dollar(accuracy = 10)

n_sale_2019 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2019) %>% 
  pull(n)

avg_sale_2019 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2019) %>% 
  pull(avg) %>%
  scales::dollar(accuracy = 10)

n_sale_2020 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2020) %>% 
  pull(n)

avg_sale_2020 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2020) %>% 
  pull(avg) %>%
  scales::dollar(accuracy = 10)

n_sale_2021 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2021) %>% 
  pull(n)

avg_sale_2021 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2021) %>% 
  pull(avg) %>%
  scales::dollar(accuracy = 10)


```

``` {r tab-1-1, include = TRUE}

library(kableExtra)

home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  mutate(avg = scales::dollar(avg)) %>% 
  set_names(c("Year", "Number of property sales", "Average sale price")) %>% 
  kbl(caption = "Yearly sales portrait in Prince Edward County",
      align = "lrrrrr") %>% 
  kable_styling(latex_options="scale_down")
  
```

``` {r make_fig_1_3}

figure_1_3_fun <- function(regular = "", condensed = "") {
  
home_sales_variation %>% 
  ggplot(aes(year_month, value, colour = var)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  geom_line(lwd = 1, na.rm = TRUE) +
  scale_x_date(name = NULL) +
  scale_y_continuous(name = NULL, limits = c(-1, NA), 
                     labels = scales::percent) +
  scale_color_manual(name = NULL, values = col_palette[c(1, 3)]) +
  theme_minimal() +
  theme(legend.position = "bottom", panel.grid.minor.x = element_blank(),
        text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_3.pdf"), 
         plot = figure_1_3_fun("Futura", "Futura Condensed"), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_3.pdf"))
}

```

The housing market in Prince Edward County has experienced both a growth in the number of property sales and an increase in the average sale prices of the properties. In 2016, there were `r n_sale_2016` property sales in the County, with an average sale price of  `r avg_sale_2016`. The number of sales decreased between 2017 and 2019 to reach `r n_sale_2019` sales. The highest recorded number of sales occurred in 2020, with  `r n_sale_2020`. Additionally, the average sale price of properties has constantly been increasing since 2016, to reach `r avg_sale_2019` in 2019, `r avg_sale_2020` in 2020 and `r avg_sale_2021` in 2021. Table \@ref(tab:tab-1-1) below summarizes the number and avergae sale prices per year.

There is a high increase in the number of residential sales starting in the second half of 2020, with the peak of real estate sales being in July 2020, with a total of `r peak_housing_sale` property sales, followed by `r second_peak_housing_sale` in September of 2020. This peak in property sales has also been accompanied by large increases in average sale prices, with a peak average sale price in December 2020 of `r dec_2020_sale_price`. This number is a staggering year-over-year increase of `r yoy_sale_2021` compared to the same month the year before. Figure \@ref(fig:fig-1-3) summarizes the year-over-year changes in the number of sales and sale price per month. 

``` {r fig-1-3, include = TRUE, fig.cap = '(ref:fig-1-3)', fig.align = "center"}

figure_1_3_fun()

```

(ref:fig-1-3) _Year-over-year changes in monthly real estate sales and average sale prices_

```{r para_4, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

list_ask_price <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year_month = format(sale_date, "%Y-%m")) %>% 
  mutate(year_month = paste0(year_month, "-01")) %>% 
  mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
  mutate(diff_price = sale_price - list_price) %>% 
  group_by(year_month) %>% 
  summarize(diff_price = mean(diff_price, na.rm=TRUE))

DOM <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year_month = format(sale_date, "%Y-%m")) %>% 
  mutate(year_month = paste0(year_month, "-01")) %>% 
  mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
  group_by(year_month) %>% 
  summarize(avg_DOM = mean(DOM, na.rm=TRUE))

DOM_2019 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  group_by(year) %>% 
  summarize(avg_DOM = round(mean(DOM, na.rm=TRUE), digit=0)) %>% 
  filter(year == 2019) %>% 
  pull(avg_dom)

DOM_2020 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  group_by(year) %>% 
  summarize(avg_DOM = round(mean(DOM, na.rm=TRUE), digit=0)) %>% 
  filter(year == 2020) %>% 
  pull(avg_dom)

DOM_2021 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  group_by(year) %>% 
  summarize(avg_DOM = round(mean(DOM, na.rm=TRUE), digit=0)) %>% 
  filter(year == 2021) %>% 
  pull(avg_dom)

diff_2020 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  mutate(diff_price = sale_price - list_price) %>% 
  group_by(year) %>% 
  summarize(diff_price = round(mean(diff_price, na.rm=TRUE), digit=-1)) %>% 
  filter(year == 2020) %>% 
  pull(diff_price) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

diff_2021 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  mutate(diff_price = sale_price - list_price) %>% 
  group_by(year) %>% 
  summarize(diff_price = round(mean(diff_price, na.rm=TRUE), digit=-1)) %>% 
  filter(year == 2021) %>% 
  pull(diff_price) %>% 
  prettyNum(",") %>% 
  paste0("$", .)


```

``` {r make_fig_1_4}

figure_1_4_fun <- function(regular = "", condensed = "") {
  
left_fig <- 
  DOM %>% 
  ggplot() +
  geom_line(aes(year_month, avg_DOM), color = col_palette[2], lwd=1)+
  scale_y_continuous(name = NULL, label = scales::comma) +
  scale_x_date(name = NULL, date_breaks = "1 year", minor_breaks = NULL,
               date_labels = c("2021", "2016", "2017", "2018", "2019", "2020"))+
  theme_minimal() +
  theme(legend.position = "bottom", panel.grid.minor.x = element_blank(), 
        text = element_text(family = regular))

right_fig <- 
  list_ask_price %>% 
  ggplot() +
  geom_line(aes(year_month, diff_price), color = col_palette[3], lwd=1)+
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  scale_y_continuous(name = NULL, label = scales::dollar) +
  scale_x_date(name = NULL, date_breaks = "1 year", minor_breaks = NULL,
               date_labels = c("2021", "2016", "2017", "2018", "2019", "2020"))+
  theme_minimal() +
  theme(legend.position = "bottom", panel.grid.minor.x = element_blank(), 
        text = element_text(family = regular))

  left_fig + right_fig + plot_layout(guide = "collect") & 
    theme(legend.position = "bottom", legend.key.width = unit(1.8, "lines"))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_4.pdf"), 
         plot = figure_1_4_fun("Futura", "Futura Condensed"), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_4.pdf"))
}

```

There are numerous proxies that can help us assess the state of the real estate market in a given geography in addition to yearly changes in the number of home sales and average sale prices. The number of days on the market and the difference between asking price and sale price are two indicators of a hot real estate market. Figure \@ref(fig:fig-1-4) shows both of those indicators. The average days on the market for the properties decreased in 2020 and even more so in 2021. The year with the highest average of days in the market is 2019 with `r DOM_2019` days. The following two years experienced declining averages, with properties in 2020 being sold after `r DOM_2020` days on average, and 2021 displaying the lowest average in the available data at `r DOM_2021` days. This speed in property sales is also accompanied by sale prices higher than the original asking prices starting late 2020. The only positive yearly average between the list price and the sale price is 2021 with `r diff_2021`, with 2020 having the smallest negative difference at `r diff_2020`.

``` {r fig-1-4, include = TRUE, fig.cap = '(ref:fig-1-4)', fig.align = "center"}

figure_1_4_fun()

```

(ref:fig-1-4) _Monthly averages for days on the market (right) and difference between asking and sale prices (left)_

```{r para_5, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

multiple_sales <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  arrange(sale_date) %>% 
  group_by(address, ward, unit_number) %>% 
  summarize(sale_dates = list(sale_date)) %>% 
  filter(lengths(sale_dates) > 1) %>%
  rowwise() %>% 
  mutate(first_time = sale_dates[1],
         second_time = sale_dates[2],
         third_time = sale_dates[3],
         fourth_time = sale_dates[4]) 

second <- 
  multiple_sales %>% 
  mutate(second_time_year = year(second_time),
         third_time_year = year(third_time),
         fourth_time_year = year(fourth_time)) %>% 
  group_by(second_time_year) %>% 
  summarize(n_second = n()) %>% 
  filter(!is.na(second_time_year)) %>% 
  rename(year=second_time_year)

second_2017 <- 
  second %>% 
  filter(year == 2017) %>% 
  pull(n_second)

second_2018 <- 
  second %>% 
  filter(year == 2018) %>% 
  pull(n_second)

second_2019 <- 
  second %>% 
  filter(year == 2019) %>% 
  pull(n_second)

second_2020 <- 
  second %>% 
  filter(year == 2020) %>% 
  pull(n_second)

second_2021 <- 
  second %>% 
  filter(year == 2021) %>% 
  pull(n_second)

third <- 
  multiple_sales %>% 
  mutate(second_time_year = year(second_time),
         third_time_year = year(third_time),
         fourth_time_year = year(fourth_time)) %>% 
  group_by(third_time_year) %>% 
  summarize(n_third = n()) %>% 
  filter(!is.na(third_time_year))%>% 
  rename(year=third_time_year)

third_2021 <- 
  third %>% 
  filter(year == 2021) %>% 
  pull(n_third)

fourth <- 
  multiple_sales %>% 
  mutate(second_time_year = year(second_time),
         third_time_year = year(third_time),
         fourth_time_year = year(fourth_time)) %>% 
  group_by(fourth_time_year) %>% 
  summarize(n_fourth = n()) %>% 
  filter(!is.na(fourth_time_year)) %>% 
  rename(year=fourth_time_year)

```

``` {r tab-1-2, include = TRUE}

library(kableExtra)

left_join(second, third) %>% 
  left_join(., fourth) %>% 
  set_names(c("Year of sale", 
              "Sold for the second time",
              "Sold for the third time",
              "Sold for the fourth time")) %>% 
  kbl(caption = "Properties sold multiple times between 2016 and 2021",
      align = "lrrrrr") %>% 
  kable_styling(latex_options="scale_down") 

  
```

Out of the 3,017 sales which occurred in Prince Edward, a total of 213 residential properties were sold more than one time during 2016 and 2021 (Table \@ref(tab:tab-1-2)). This quick turnover is an indicator of the state of the homeownership market: whereas houses are usually bought for long term living situations, it is not uncommon in hot property markets to see properties being sold multiple times in a short timespan. To explore this situation in Prince Edward County, we have looked at the addresses that came up more than once in the sales database, and grouped this number per year. The number of properties sold for a second time was similar in 2017 and 2018, respectively with `r second_2017` and `r second_2018`. The number increased by more than 50% between 2018 and 2019 to reach `r second_2019`. 2020 is the year with the most recorded second sales, reaching `r second_2020`, more than twice that of the year before. This phenomenon was less pronounced in 2021, with only `r second_2021` second time sales, but with the most properties being sold for a third time, reaching `r third_2021`. The most times a single property was sold in this time period is four times, although observed only once. While the limited date range of this dataset poses issues as to the comparability in between years (i.e. there are more years between 2021 and 2016 to record a second sale, compared to 2017 and 2016, for example), it provides another indicator of the state of the housing market in Prince Edward County. Combined with an overall increasing number of sales and average sale prices, positive differences between the list price and the sale price and shrinking time on the market, we can observe that Prince Edward County has been faced with a booming homeownership market since 2016, which is also the year of the last available census data. 

## Affording to live in Prince Edward County since 2016

```{r para_6, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

sale_price_by_ward <- 
  home_sales %>% 
  filter(sale_date >="2020-01-01") %>% 
  st_drop_geometry() %>% 
  left_join(., EW, by = "ward") %>% 
  filter(!is.na(ward)) %>% 
  st_as_sf() %>% 
  group_by(ward) %>% 
  summarize(avg_sale_price_2021 = mean(sale_price, na.rm=TRUE))

sale_price_2020_2017 <- 
  home_sales %>% 
  filter(sale_date >="2017-01-01", sale_date <= "2018-12-31") %>% 
  st_drop_geometry() %>% 
  left_join(., EW, by = "ward") %>% 
  filter(!is.na(ward)) %>% 
  st_as_sf() %>% 
  group_by(ward) %>% 
  summarize(avg_sale_price_1718 = mean(sale_price, na.rm=TRUE)) %>%
  st_drop_geometry() %>% 
  left_join(., sale_price_by_ward, by = "ward") %>% 
  st_as_sf()

north_avg_price <- 
  sale_price_by_ward %>% 
  st_drop_geometry() %>%
  arrange(desc(avg_sale_price)) %>% 
  slice(1) %>% 
  pull(avg_sale_price) %>% 
  scales::dollar(10)

athol_avg_price <- 
  sale_price_by_ward %>% 
  st_drop_geometry() %>%
  arrange(avg_sale_price) %>% 
  slice(1) %>% 
  pull(avg_sale_price) %>% 
  scales::dollar(10)

#https://www.wallstreetmojo.com/mortgage-formula/

affordable_homeownership_2021 <- 
  sale_price_2020_2017 %>% 
  st_drop_geometry() %>% 
  mutate(downpayment = avg_sale_price_2021*0.2,
         P = avg_sale_price_2021 - downpayment,
         amortization = 25,
         mortgage_rate = 0.0175) %>% 
  mutate(r = mortgage_rate/12,
         n = amortization*12) %>% 
  mutate(monthly_mortgage_payments = P*r*(((1+r)^n)
                                          /
                                          (((1+r)^n)-1)
                                          )
         ) %>% 
  mutate(maintenance_cost = 700,
         total_mortgage_payments = (monthly_mortgage_payments+maintenance_cost)*12,
         affordable_income_2021 = total_mortgage_payments/0.3) %>% 
  left_join(., st_drop_geometry(EW_housing) %>% select(ward, at_hh_inc), by="ward") %>% 
  mutate(diff_affordable_real_2021 = at_hh_inc-affordable_income_2021) %>% 
  select(ward, avg_sale_price_2021, at_hh_inc, diff_affordable_real_2021)

affordable_homeownership_1718 <- 
  sale_price_2020_2017 %>% 
  st_drop_geometry() %>% 
  mutate(downpayment = avg_sale_price_1718*0.2,
         P = avg_sale_price_1718 - downpayment,
         amortization = 25,
         mortgage_rate = 0.0175) %>% 
  mutate(r = mortgage_rate/12,
         n = amortization*12) %>% 
  mutate(monthly_mortgage_payments = P*r*(((1+r)^n)
                                          /
                                            (((1+r)^n)-1)
  )
  ) %>% 
  mutate(maintenance_cost = 700,
         total_mortgage_payments = (monthly_mortgage_payments+maintenance_cost)*12,
         affordable_income_1718 = total_mortgage_payments/0.3) %>% 
  left_join(., st_drop_geometry(EW_housing) %>% select(ward, at_hh_inc), by="ward") %>% 
  mutate(diff_affordable_real_1718 = at_hh_inc-affordable_income_1718) %>% 
  select(ward, avg_sale_price_1718, at_hh_inc, diff_affordable_real_1718)

diff_picton_1718 <- 
  affordable_homeownership_1718 %>% 
  filter(ward=="Picton") %>% 
  pull(diff_affordable_real_1718) %>% 
  {.*-1} %>% 
  scales::dollar(10) 

```

``` {r make_fig_1_5}

figure_1_5_fun <- function(regular = "", condensed = "") {
  
sale_price_2020_2017 %>% 
  ggplot() +
  geom_sf(data = province, colour = "transparent", fill = "grey93") +
  geom_sf(aes(fill = avg_sale_price_2021), colour = "white") +
  geom_sf(data = water, fill = "white", colour = "transparent") +
  scale_fill_stepsn(colors = col_palette[c(5, 3, 4, 6)], 
                       na.value = "grey80",
                       limits = c(400000, 1000000), oob = scales::squish, 
                       labels = scales::dollar)  +
  guides(fill = guide_colourbar(title = "Average sale\nprice",
                                title.vjust = 1)) + 
  gg_bbox(EW) +
  theme_void() +
  theme(text = element_text(family = regular, face = "plain"),
        legend.title = element_text(family = regular, face = "bold",
                                    size = 7),
        legend.title.align = 0.9,
        legend.text = element_text(family = regular, size = 5),
        panel.border = element_rect(colour = "white", size = 2))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_5.pdf"), 
         plot = figure_1_5_fun("Futura", "Futura Condensed"), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_5.pdf"))
}

```

Due to the relatively outdated nature of the last available census, it can be difficult to utilize this data to dress a portrait of the housing affordability in the County. However, we can still estimate based on the average sale prices by ward the income it would take to be able to afford being a homeowner in Prince Edward County without being in a situation of housing stress (which is set at the 30% threshold mentioned above). As we have seen in the first part of the chapter, homeowners in housing stress represent 17.3% of all homeowners, with varying averages by ward. The average sale price varies by ward, with North Marysburgh `r north_avg_price` having the highest average, and Athol the lowest `r athol_avg_price` for the years 2020 and 2021 only (Figure \@ref(fig:fig-1-5)).

``` {r fig-1-5, include = TRUE, fig.cap = '(ref:fig-1-5)', fig.align = "center"}

figure_1_5_fun()

```

(ref:fig-1-5) _Average sale prices by ward from 2016 to 2021_

``` {r tab-1-3, include = TRUE}

library(kableExtra)

affordable_homeownership_1718 %>% 
  left_join(., affordable_homeownership_2021 %>% select(-at_hh_inc), by = "ward") %>% 
  select(ward, avg_sale_price_1718, avg_sale_price_2021,
         at_hh_inc, diff_affordable_real_1718, diff_affordable_real_2021) %>% 
  mutate(avg_sale_price_1718 = scales::dollar(avg_sale_price_1718, 10),
         avg_sale_price_2021 = scales::dollar(avg_sale_price_2021, 10),
         at_hh_inc = scales::dollar(at_hh_inc, 10),
         diff_affordable_real_1718 = scales::dollar(diff_affordable_real_1718, 10),
         diff_affordable_real_2021 = scales::dollar(diff_affordable_real_2021, 10)) %>% 
  arrange(desc(diff_affordable_real_2021)) %>% 
  set_names(c("Ward", "Average sale price, 2017-2018", "Average sale price, 2020-2021", 
              "After-tax household income, 2016 census", "Difference with affordable income threshold, 2017-2018", 
              "Difference with affordable income threshold, 2020-2021")) %>% 
  kbl(caption = "Difference between household incomes and affordable homeownership threshold, for 2017-2018 and 2020-2021",
      align = "lrrrrr") %>% 
  kable_styling(latex_options="scale_down") 
  
```

Based on the average sale prices for the past years, it was possible to estimate the average household income it would take to become a homeowner in Prince Edward County in an affordable manner. We completed the exercise using average sale prices for the 2017-2018 and 2020-2021 periods to highlight the recent market changes in the county. The calculations were based on a 25-year mortgage at a 1.75% interest rate and a 20% mortgage down payment (although 20% downpayment can be considered a rare feat, with most people having small down payments and needing to insure their mortgages). Monthly mortgage payments and homeownership maintenance costs (property taxes, utilities) were calculated to provide a yearly homeonwership total costs, from which an affordable homeownership threshold was determined. The affordable homeonwership threshold represents the minimum household income required to have housing costs remain at 30% of income or below. These thresholds for both 2017-2018 and 2020-2021 were then compared to the 2016 census after-tax household income, by ward (2016 being the most recent data available). The differences between the affordable thresholds and the actual household incomes are displayed in Table \@ref(tab:tab-1-3). We can see that, for both time periods, the average after-tax household income in each ward is not sufficient to make homeownership affordable in the County (with North Marysburgh in 2017-2018 being the only exception). In the 2020-2021 period, there are five wards for which households would require more than $50,000 to make current homeownership market conditions affordable for them, whereas the highest difference in 2017-2018 was Picton with `r diff_picton_1718`.



\newpage
# Short-term accommodations in Prince Edward County: Market overview

<style type="text/css">
  body{
  font-family: Futura, Helvetica, Arial;
}
</style>

<br>

```{r setup, include = FALSE, echo = FALSE}

library(here)
source(here("R", "01_startup.R"))

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# Function for checking file modifications
mtime <- function(files) lapply(Sys.glob(files), function(x) file.info(x)$mtime)

# Set this to TRUE to output PDF figures
build_figures <- TRUE

qload(here("output", "/geometry.qsm"))
qload(here("output", "/str_processed.qsm"))

```

```{r new_objects, cache=TRUE, cache.lazy=FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

daily <- 
  daily %>% 
  # to not report on incomplete numbers, start at a date when VRBO is in our dataset
  filter(date >= "2017-06-01")

# 2021 active
active_2021 <- 
  daily %>%
  filter(status %in% c("R", "A"), date >= start_2021) %>%
  pull(property_ID) %>% 
  unique()

# 2021 revenue
revenue_2021 <-
  daily %>%
  filter(status == "R", date >= start_2021) %>%
  group_by(property_ID) %>%
  summarize(revenue_2021 = sum(price), .groups = "drop") %>% 
  inner_join(property, ., by = "property_ID")

# 2019 active
active_2019 <- 
  daily %>%
  filter(status %in% c("R", "A"), date <= end_2019, date >= start_2019) %>%
  pull(property_ID) %>% 
  unique()

# 2019 revenue
revenue_2019 <-
  daily %>%
  filter(status == "R", date <= end_2019, date >= start_2019) %>%
  group_by(property_ID) %>%
  summarize(revenue_2019 = sum(price), .groups = "drop") %>% 
  inner_join(property, ., by = "property_ID")

# Active listings
active_listings <- 
  daily %>% 
  filter(status != "B") %>% 
  count(date, listing_type) %>% 
  group_by(listing_type) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE)) %>% 
  ungroup()

active_listings <- 
  daily %>% 
  filter(status != "B") %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE),
         listing_type = "All listings") %>% 
  bind_rows(active_listings) %>% 
  arrange(date, listing_type)

# Daily variation
daily_variation <- 
  daily %>% 
  filter(status != "B", date != "2020-02-29") %>%
  group_by(date) %>% 
  summarize("Active listings" = n(), Revenue = sum(price[status == "R"])) %>% 
  mutate(across(where(is.numeric), 
                function(x) slide_dbl(x, ~{(.x[366] - .x[1]) / .x[1]}, 
                                      .before = 365, .complete = FALSE))) %>% 
  pivot_longer(-date, names_to = "var", values_to = "value") %>% 
  group_by(var) %>% 
  mutate(value = slide_dbl(value, mean, .before = 13, .complete = TRUE)) %>% 
  ungroup() %>% 
  filter(!is.na(value), !is.infinite(value)) %>% 
  group_by(date) %>% 
  filter(n() == 2, date >= as.Date("2017-06-01") + years(1)) %>% 
  ungroup()

# EW breakdown
EW_breakdown <- 
  daily %>% 
  filter(status != "B", date >= start_2019, 
         !c(date >= start_2020 & date <= end_2020)) %>% 
  group_by(date, ward) %>% 
  summarize(n = n(),
            revenue = sum(price[status == "R"])) %>% 
  left_join(st_drop_geometry(EW)) %>% 
  group_by(ward, dwellings) %>% 
  summarize(active_listings = mean(n[date >= start_2021]),
            active_2019 = mean(n[date < start_2021]),
            active_growth_2019_2021 = (active_listings - active_2019) / active_2019,
            daily_rev = sum(revenue[date >= start_2021]) / yday(max(date)),
            rev_2019 = sum(revenue[date < start_2021]) / yday(max(date)),
            rev_growth_2019_2021 = (daily_rev - rev_2019) / rev_2019,
            .groups = "drop") %>% 
  mutate(listings_pct = active_listings / sum(active_listings, na.rm = TRUE),
         listings_pct_dwellings = active_listings / dwellings,
         rev_pct = daily_rev / sum(daily_rev)) %>% 
  select(ward, active_listings, active_growth_2019_2021, listings_pct,
         listings_pct_dwellings, daily_rev, rev_pct, rev_growth_2019_2021)

# Active listings by EW
active_EW <-
  daily %>%
  filter(status != "B", date >= start_2021) %>%
  count(ward, date) %>% 
  group_by(ward) %>% 
  summarize(n = mean(n, na.rm = TRUE)) %>%
  left_join(EW, .) %>% 
  mutate(percentage = n / dwellings, n = round(n)) %>% 
  select(ward, n, dwellings, percentage)

# Active listings by DA
active_DA <-
  daily %>%
  filter(status != "B", date >= start_2021) %>%
  left_join(select(st_drop_geometry(property), property_ID, GeoUID)) %>% 
  count(GeoUID, date) %>% 
  group_by(GeoUID) %>% 
  summarize(n = mean(n, na.rm = TRUE)) %>%
  left_join(DA, .) %>% 
  mutate(percentage = n / dwellings, n = round(n),
         percentage = if_else(dwellings <= 4, NA_real_, percentage)) %>% 
  relocate(geometry, .after = last_col())

# Listing type breakdown
listing_type_breakdown <- 
  daily %>% 
  filter(status != "B", date >= start_2021) %>% 
  group_by(listing_type) %>% 
  summarize(
    active_listings = round(n() / yday(max(date))),
    revenue = sum(price[status == "R"]),
    .groups = "drop") %>% 
  mutate(pct_of_listings = active_listings / sum(active_listings),
         pct_of_revenue = revenue / sum(revenue))

listing_type_breakdown <- 
  daily %>% 
  filter(status != "B", date >= start_2019 - years(1), 
         date <= end_2019 - years(1)) %>% 
  group_by(listing_type) %>% 
  summarize(active_2019 = round(n() / 365)) %>% 
  left_join(listing_type_breakdown, .) %>% 
  mutate(pct_listing_growth_2019_2021 = (active_listings - active_2019) / 
           active_2019) %>% 
  select(-active_2019)

# Host revenue table for calculations and table
host_rev <-
  daily %>%
  filter(date >= start_2021, status == "R", !is.na(host_ID)) %>%
  group_by(host_ID) %>%
  summarize(rev = sum(price))

host_rev_2019 <-
  daily %>%
  filter(date >= start_2019, date <= end_2019, status == "R", 
         !is.na(host_ID)) %>%
  group_by(host_ID) %>%
  summarize(rev = sum(price))

```

```{r exec_summ, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

# Average active and blocked daily listings in 2021
avg_listings <- 
  daily %>% 
  filter(date >= start_2021) %>% 
  count(date, B = status == "B") %>% 
  group_by(B) %>% 
  summarize(avg = round(mean(n), digit = -1), .groups = "drop")

avg_listings_active <- 
  avg_listings$avg[1] %>% 
  prettyNum(",")

# Average active and blocked daily listings in 2019
avg_listings_2019 <- 
  daily %>% 
  filter(date >= start_2019, date <= end_2019) %>% 
  count(date, B = status == "B") %>% 
  group_by(B) %>% 
  summarize(avg = round(mean(n), digit = -1), .groups = "drop")

avg_listings_active_2019 <- 
  avg_listings_2019$avg[1] %>% 
  prettyNum(",")

# Variation daily active listings 2019 vs 2021
var_active_listings_2019_2021 <- 
  {(avg_listings[avg_listings$B == FALSE,]$avg - 
      avg_listings_2019[avg_listings_2019$B == FALSE,]$avg) /
      avg_listings_2019[avg_listings_2019$B == FALSE,]$avg} %>% 
  scales::percent()

# Daily revenue in 2021
daily_rev <- 
  {{revenue_2021$revenue_2021 %>% 
      sum()} / yday(max(daily$date))} %>% 
  round(-3) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

# Daily revenue in 2019
daily_rev_2019 <- 
  {{revenue_2019$revenue_2019 %>% 
      sum()}/365} %>% 
  round(-3) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

# Variation revenue 2019 vs 2021
var_daily_rev_2019_2021 <- 
  {({{revenue_2021$revenue_2021 %>% 
  sum()}/yday(max(daily$date))} -
  {{revenue_2019$revenue_2019 %>% 
  sum()}/365}) /
  {{revenue_2019$revenue_2019 %>% 
  sum()}/365}} %>% 
  scales::percent(0.1)

# EH listings
eh_listings <- 
  listing_type_breakdown %>% 
  filter(listing_type == "Entire home/apt") %>% 
  pull(pct_of_listings) %>% 
  scales::percent(0.1)

# EH revenue
eh_revenue <- 
  listing_type_breakdown %>% 
  filter(listing_type == "Entire home/apt") %>% 
  pull(pct_of_revenue) %>% 
  scales::percent(0.1)

# Host revenue in 2021
host_rev_top_10 <- 
  host_rev %>% 
  summarize(top_10 = sum(rev[rev > quantile(rev, .9)]) / sum(rev)) %>% 
  pull(top_10) %>% 
  scales::percent(0.1)

host_rev_top_1 <- 
  host_rev %>% 
  summarize(top_1 = sum(rev[rev > quantile(rev, .99)]) / sum(rev)) %>% 
  pull(top_1) %>% 
  scales::percent(0.1)

# Host revenue in 2019
host_rev_top_10_2019 <- 
  host_rev_2019 %>% 
  summarize(top_10 = sum(rev[rev > quantile(rev, .9)]) / sum(rev)) %>% 
  pull(top_10) %>% 
  scales::percent(0.1)

host_rev_top_1_2019 <- 
  host_rev_2019 %>% 
  summarize(top_1 = sum(rev[rev > quantile(rev, .99)]) / sum(rev)) %>% 
  pull(top_1) %>% 
  scales::percent(0.1)

# 2021 ML listings
ml_listings <- 
  daily %>% 
  filter(status != "B", date >= start_2021) %>% 
  count(multi) %>% 
  summarize(ML = n[2] / sum(n)) %>% 
  pull(ML) %>% 
  scales::percent(0.1)

# 2021 ML revenue
ml_revenue <- 
  daily %>% 
  filter(status == "R", date >= start_2021) %>% 
  group_by(multi) %>% 
  tally(price) %>% 
  summarize(multi_rev = n[2] / sum(n)) %>% 
  pull(multi_rev) %>% 
  scales::percent(0.1)

# 2019 ML listings
ml_listings_2019 <- 
  daily %>% 
  filter(status != "B", date >= start_2021, date <= end_2019) %>% 
  count(multi) %>% 
  summarize(ML = n[2] / sum(n)) %>% 
  pull(ML) %>% 
  scales::percent(0.1)

# 2019 ML revenue
ml_revenue_2019 <- 
  daily %>% 
  filter(status == "R", date >= start_2021, date <= end_2019) %>% 
  group_by(multi) %>% 
  tally(price) %>% 
  summarize(multi_rev = n[2] / sum(n)) %>% 
  pull(multi_rev) %>% 
  scales::percent(0.1)

```

**There are on a daily average `r avg_listings_active` active STA listings in Prince Edward County housing units in 2021, which collectively earned `r daily_rev` per day. The average number of active listings declined by `r var_active_listings_2019_2021` compared to 2019, while revenue increased by `r var_daily_rev_2019_2021`. The ward with the most active listings is Picton, with 19.5%. In Bloomfield, 34.7% of all dwellings were active STA listings in 2021. Almost all (`r eh_listings`) STA listings were entire homes, responsible for `r eh_revenue` of total revenues. Revenue is distributed unevenly among hosts, with the top 10% of hosts earning `r host_rev_top_10` of revenues. Commercial operators who control multiple STA listings account for half of listings (`r ml_listings`) and revenue (`r ml_revenue`). Overall, the Covid-19 pandemic has caused active daily listings to drop by 20%, while nightly prices were almost twice (48.4%) as high in 2021 compared to 2019. The pandemic has also flattened the seasonality pattern in the county, with non-summer months receiving more reservations on average than the years before. The share of reservations occurring in towns and townships also flattened because of Covid, with their respective shares remaining stable throughout the year.**

<br>

## Active daily listings and annual revenue

```{r para_1, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

avg_listings_active_2019 <- 
  avg_listings_2019$avg[1] %>% 
  prettyNum(",")

listings_change_pct <-
  ((avg_listings$avg[1] - avg_listings_2019$avg[1]) / avg_listings_2019$avg[1]) |> 
  abs() |> 
  scales::percent(0.1)

# Average number of hosts in 2021 (taking out blocked 365 days)
avg_hosts <- 
  daily %>% 
  filter(status != "B", date >= start_2021) %>%
  count(date, host_ID) %>% 
  count(date) %>% 
  summarize(hosts = round(mean(n), digit = -1), .groups = "drop") %>% 
  pull(hosts) %>% 
  prettyNum(",")

# Average number of hosts in 2019 (taking out blocked 365 days)
avg_hosts_2019 <- 
  daily %>% 
  filter(status != "B", date >= start_2019, date <= end_2019) %>%
  count(date, host_ID) %>% 
  count(date) %>% 
  summarize(hosts = round(mean(n), digit = -1), .groups = "drop") %>% 
  pull(hosts) %>% 
  prettyNum(",")

# Average revenue per active listing in 2021
avg_rev_per_listing <- 
  # Since there aren't 365 days in 2021, we need to avg per day
  {(sum(revenue_2021$revenue_2021) / yday(max(daily$date))) /
    daily %>% 
    filter(status != "B", date >= start_2021) %>% 
    count(date) %>% 
    summarize(avg_rev_per_active = round(mean(n)), .groups = "drop")} %>% 
  as.vector() %>% 
  round(digit = -1) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

# Average revenue per active listing in 2019
avg_rev_per_listing_2019 <- 
  {(sum(revenue_2019$revenue_2019) / 365) /
    daily %>% 
    filter(status != "B", date >= start_2019, date <= end_2019) %>% 
    count(date) %>% 
    summarize(avg_rev_per_active_2019 = round(mean(n)), .groups = "drop")} %>% 
  as.vector() %>% 
  round(digit = -1) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

#' Average revenue per active host in 2021
avg_rev_per_host <- 
  {(sum(revenue_2021$revenue_2021) / yday(max(daily$date))) /
    daily %>% 
    filter(status != "B", date >= start_2021) %>%
    group_by(date) %>% 
    summarize(n_hosts = length(unique(host_ID)), .groups = "drop_last") %>% 
    summarize(avg_n_hosts = round(mean(n_hosts)), .groups = "drop")} %>% 
  round(digit = -1) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

#' Average revenue per active host in 2019
avg_rev_per_host_2019 <- 
  {(sum(revenue_2019$revenue_2019) / 365) /
    daily %>% 
    filter(status != "B", date >= start_2019, date <= end_2019) %>% 
    group_by(date) %>% 
    summarize(n_hosts = length(unique(host_ID)), .groups = "drop_last") %>% 
    summarize(avg_n_hosts20 = round(mean(n_hosts)), .groups = "drop")} %>% 
  round(digit = -1) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

```

``` {r make_fig_1_1}

figure_1_1_fun <- function(regular = "", condensed = "") {
  
  active_listings %>% 
    mutate(label = if_else(date == "2018-09-01", listing_type, NA_character_)) %>%
    ggplot(aes(date, n, colour = listing_type, size = listing_type)) +
    geom_line(na.rm = TRUE) +
    geom_label(aes(label = label), size = 3, family = condensed) +
    scale_x_date(name = NULL) + 
    scale_y_continuous(name = NULL, label = scales::comma) +
    scale_colour_manual(name = NULL, values = col_palette[c(5, 1:3)]) +
    scale_size_manual(values = c("All listings" = 1.5, "Entire home/apt" = 0.75,
                                 "Private room" = 0.75, "Shared room" = 0.75)) +
    theme_minimal() +
    theme(legend.position = "NONE", panel.grid.minor.x = element_blank(),
          text = element_text(family = regular))
  
}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_1.pdf"), 
         # plot = figure_2_1_fun("Futura", "Futura Condensed"), 
         plot = figure_1_1_fun(), 
         width = 9, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_1.pdf"))
}

```

```{r seasonality}

pre_disruptions_reservations <- 
  daily %>%
  filter(status == "R",
         date >= "2017-06-01") %>% 
  count(date) %>% 
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE))

max_2017 <- 
  pre_disruptions_reservations %>% 
  filter(date < "2018-01-01") %>% 
  arrange(-n) %>% slice(1)

max_2019 <- 
  pre_disruptions_reservations %>% 
  arrange(-n) %>% slice(1)
  
monthly_percentage_reservations <- 
  daily %>%
  filter(status == "R",
         date >= "2018-01-01", date < "2020-01-01") %>% 
  count(date) %>% 
  mutate(month_year = zoo::as.yearmon(date,"%Y-%m-%d"),
         num_month = month(date),
         num_month = case_when(str_detect(num_month, pattern = "\\d{2}") ~ as.character(num_month),
                               TRUE ~ as.character(str_glue("0{num_month}")))) %>% 
  mutate(month = str_glue("{num_month} ({format(month_year, '%b')})")) %>% 
  group_by(month_year, month) %>% 
  summarize(n = sum(n)) %>% 
  group_by(month) %>% 
  summarize(n = mean(n)) %>% 
  mutate(per = n/sum(n))

summer_months <- 
monthly_percentage_reservations %>% 
  slice(5:9) %>% 
  summarize(scales::percent(sum(per))) %>% 
  pull()

yoy_2019 <- 
daily %>%
    filter(status == "R",
           date >= "2018-01-01", date < "2020-01-01") %>% 
    count(date) %>% 
    filter(str_detect(month(date), pattern = "5|6|7|8")) %>%
    group_by(year_2019 = date >= start_2019) %>% 
    summarize(n = sum(n)) %>% 
    summarize((n[2]-n[1])/n[1]) %>% pull() %>% 
    scales::percent()

yoy_2021 <- 
daily %>%
  filter(status == "R", date >= start_2019, 
         !c(date >= str_replace(max(daily$date), "^\\d{4}", "2019") & date <= end_2020)) %>% 
  count(date) %>% 
  filter(str_detect(month(date), pattern = "5|6|7|8")) %>%
  group_by(year_2021 = date >= start_2021) %>% 
  summarize(n = sum(n)) %>% 
  summarize((n[2]-n[1])/n[1]) %>% pull() %>% 
  {. * -1} %>% 
  scales::percent()


```

Active daily listings are listings which were displayed on Airbnb or Vrbo on a given day, and were either reserved or available for a reservation. It is the most reliable means of determining the overall size of the STA market in a location, particularly with respect to change over time. In 2021, there was an average of `r avg_listings_active` active daily listings (Figure \@ref(fig:fig-1-1)) in Prince Edward County operated by an average of `r avg_hosts` hosts. STA activity in Prince Edward County is highly seasonal, with strong activity from May to September (and an annual peak in August), weaker activity from October through April (with an annual trough in February, and a small peak over the holidays). Overall, the summer months (from May to September) account for `r summer_months` of the total number of reservations in a year. STA hosts collectively earned an average of `r daily_rev` per day in 2021—an average of `r avg_rev_per_listing` per daily active listing or `r avg_rev_per_host` per daily active host.

``` {r fig-1-1, include = TRUE, fig.cap = '(ref:fig-1-1)', fig.align = "center"}

figure_1_1_fun()

```

(ref:fig-1-1) _Active daily STAs in Prince Edward County (7-day average)_

Compared to before the pandemic, there are now fewer STA operators, but they are earning substantially more money. In 2019, the STA market revenue amounted to a daily average of `r daily_rev_2019`, with an average of `r avg_listings_active_2019` active listings on a given day operated by `r avg_hosts_2019` hosts. In 2019, the average listing earned `r avg_rev_per_listing_2019` a night and the average host `r avg_rev_per_host_2019` a night. While there are `r listings_change_pct` fewer active daily listings in 2021 when compared to 2019, these listings collectively earned `r var_daily_rev_2019_2021` more revenue.

``` {r para_2, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

# Average blocked daily listings in 2021
avg_listings_blocked <- 
  avg_listings$avg[2] %>% 
  prettyNum(",")

# Average blocked daily listings in 2019
avg_listings_blocked_2019 <- 
  avg_listings_2019$avg[2] %>% 
  prettyNum(",")

# Average revenue per all listings in 2021
avg_revenue_all_listings <- 
  {(revenue_2021$revenue_2021 %>% 
  mean()) / yday(max(daily$date))} %>% 
  round(digit = -1) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

# Average revenue per all listings in 2019
avg_revenue_all_listings_2019 <- 
  {(revenue_2019$revenue_2019 %>% 
  mean()) / 365} %>% 
  round(digit = -1) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

# Average revenue per all hosts in 2021
avg_revenue_all_hosts <- 
  {(revenue_2021 %>% 
  st_drop_geometry() %>%
  filter(!is.na(host_ID)) %>%
  group_by(host_ID) %>% 
  summarize("host_rev" = sum(revenue_2021)) %>% 
  summarize("avg_host_rev" = mean(host_rev)) %>% 
  pull(avg_host_rev)) / yday(max(daily$date))} %>% 
  round(., -1) %>% 
  paste0("$", .)

# Average revenue per all hosts in 2019
avg_revenue_all_hosts_2019 <- 
  {(revenue_2019 %>% 
  st_drop_geometry() %>%
  filter(!is.na(host_ID)) %>%
  group_by(host_ID) %>% 
  summarize("host_rev" = sum(revenue_2019)) %>% 
  summarize("avg_host_rev" = mean(host_rev)) %>% 
  pull(avg_host_rev)) / 365}  %>% 
  round(., -1) %>% 
  paste0("$", .)

# Non-housing active listings in 2021
non_housing_listings <- 
  daily_all %>% 
  filter(!housing, status != "B", date >= start_2021) %>%
  count(date) %>% 
  summarize(non_housing = round(mean(n), digit = -1)) %>% 
  pull(non_housing) %>% 
  prettyNum(",")

# Non-housing active listings in 2019
non_housing_listings_2019 <- 
  daily_all %>% 
  filter(!housing, status != "B", date >= start_2019, date <= end_2019) %>%
  count(date) %>% 
  summarize(non_housing = round(mean(n), digit = -1)) %>% 
  pull(non_housing) %>% 
  prettyNum(",")

```

There was also a daily average of `r avg_listings_blocked` listings which were visible on the Airbnb and Vrbo websites but were blocked by the host from receiving reservations (which is more than pre-Covid, with 2019 having on average `r avg_listings_blocked_2019` blocked listings on a given day). The presence of these listings can erroneously suggest that a territory’s STA market is larger than it is. When these blocked but inactive listings are included, the average listing earned `r avg_revenue_all_listings` daily in 2021, and the average host earned `r avg_revenue_all_hosts` daily. Finally, there was a daily average of `r non_housing_listings` listings that were not located in private housing units (B&Bs, hotels, etc.), which have been excluded from the analysis in this report. All the material which follows pertain to short-term accommodations located in Prince Edward County’s residential housing stock.

``` {r para_3, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

# Date and amount of highest activity
highest_activity <- 
  daily %>% 
  filter(status != "B") %>% 
  count(date) %>% 
  filter(n == max(n)) %>% 
  group_by(date) %>% 
  summarize(daily_max = round((n), digit = -1)) %>% 
  slice(1)

highest_activity_date <-
  highest_activity$date %>% 
  {paste0(month.name[as.numeric(substr(., 6, 7))], " ", substr(., 1, 4))}

highest_activity_amount <- 
  highest_activity$daily_max %>% 
  prettyNum(",")

# Active listing YOY change in 2019
active_yoy_change_2019 <- 
  daily %>% 
  filter(status != "B", date >= start_2019 - years(1), 
         date <= end_2019) %>% 
  group_by(year_2019 = date >= start_2019) %>% 
  summarize(active_listings = n() / 365,
            revenue = sum(price[status == "R"]), .groups = "drop") %>% 
  summarize(across(c(active_listings, revenue), ~{(.x[2] - .x[1]) / .x[1]}),
            .groups = "drop")

active_yoy_listings_2019 <- 
  active_yoy_change_2019$active_listings %>% 
  scales::percent(accuracy = 0.1)

active_yoy_revenue_2019 <- 
  active_yoy_change_2019$revenue %>% 
  scales::percent(accuracy = 0.1)

# Active listing change 2019 to 2021
active_yoy_change <- 
  daily %>% 
  filter(status != "B", date >= start_2019, 
         !c(date >= start_2020 & date <= end_2020)) %>% 
  group_by(year_2021 = date >= start_2021) %>% 
  summarize(active_listings = n() / yday(max(date)),
            revenue = sum(price[status == "R"])  / yday(max(date)), .groups = "drop") %>% 
  summarize(across(c(active_listings, revenue), ~{(.x[2] - .x[1]) / .x[1]}),
            .groups = "drop")

active_yoy_listings <- 
  active_yoy_change$active_listings %>% 
  {. * -1} %>% 
  scales::percent(accuracy = 0.1)

active_yoy_revenue <- 
  active_yoy_change$revenue %>% 
  scales::percent(accuracy = 0.1)

```

<br>

## Location of STA listings and revenue

``` {r para_4}

picton_listing_pct <- 
  EW_breakdown %>% 
  filter(ward == "Picton") %>% 
  pull(listings_pct) %>% 
  scales::percent(0.1)

picton_rev_pct <- 
  EW_breakdown %>% 
  filter(ward == "Picton") %>% 
  pull(rev_pct) %>% 
  scales::percent(0.1)

hallowell_listing_pct <- 
  EW_breakdown %>% 
  filter(ward == "Hallowell") %>% 
  pull(listings_pct) %>% 
  scales::percent(0.1)

hallowell_rev_pct <- 
  EW_breakdown %>% 
  filter(ward == "Hallowell") %>% 
  pull(rev_pct) %>% 
  scales::percent(0.1)

wellington_listing_pct <- 
  EW_breakdown %>% 
  filter(ward == "Wellington") %>% 
  pull(listings_pct) %>% 
  scales::percent(0.1)

wellington_rev_pct <- 
  EW_breakdown %>% 
  filter(ward == "Wellington") %>% 
  pull(rev_pct) %>% 
  scales::percent(0.1)

picton_per_cap <- 
  EW_breakdown %>% 
  filter(ward == "Picton") %>% 
  pull(listings_pct_dwellings) %>% 
  scales::percent(0.1)

athol_per_cap <- 
  EW_breakdown %>% 
  filter(ward == "Athol") %>% 
  pull(listings_pct_dwellings) %>% 
  scales::percent(0.1)

wellington_per_cap <- 
  EW_breakdown %>% 
  filter(ward == "Wellington") %>% 
  pull(listings_pct_dwellings) %>% 
  scales::percent(0.1)

bloomfield_per_cap <- 
  EW_breakdown %>% 
  filter(ward == "Bloomfield") %>% 
  pull(listings_pct_dwellings) %>% 
  scales::percent(0.1)

min_per_dwellings <- 
  EW_breakdown %>%
  filter(!is.na(ward), !ward %in% c("Bloomfield", "Wellington", "Athol")) %>% 
  pull(listings_pct_dwellings) %>% 
  min() %>% 
  scales::percent(0.1)

max_per_dwellings <- 
  EW_breakdown %>% 
  filter(!is.na(ward), !ward %in% c("Bloomfield", "Wellington", "Athol")) %>% 
  pull(listings_pct_dwellings) %>% 
  max() %>% 
  scales::percent(0.1)

```

```{r on_water, cache = TRUE, cache.lazy = FALSE}

qload(here("output", "geometry.qsm"), nthreads = availableCores())

ocean <-
  read_sf(here("data", "shapefiles", "lhy_000h16a_e.shp")) %>%
  st_transform(32618)

ocean <-
  ocean %>%
  st_filter(select(city, -everything()))

river <-
  read_sf(here("data", "shapefiles", "lhy_000c16a_e.shp")) %>%
  st_transform(32618)

river <-
  river %>%
  st_filter(select(city, -everything()))

water <- rbind(select(river, -everything()), select(ocean, -everything()))

rm(ocean, river, city)
```

``` {r make_fig_1_2}

figure_1_2_fun <- function(regular = "", condensed = "") {
  
  left_map <- 
    active_EW %>% 
    ggplot() +
    geom_sf(data = province, colour = "transparent", fill = "grey93") +
    geom_sf(aes(fill = percentage), colour = "white", size = 0.1) +
    geom_sf(data = water, fill = "white", colour = "transparent") +
    scale_fill_stepsn(colors = col_palette[c(5, 3, 4, 1, 6)],
                      breaks = c(0, 0.025, 0.05, 0.075, 0.10, 0.125, 0.15),
                      na.value = "grey80",
                      limits = c(0, 0.15), oob = scales::squish, 
                      labels = scales::percent)  +
    guides(fill = guide_colourbar(title = "STAs/\ndwelling",
                                  title.vjust = 1)) + 
    gg_bbox(active_EW) +
    theme_void() +
    theme(text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold",
                                      size = 7),
          legend.title.align = 0.9,
          legend.text = element_text(family = regular, size = 5),
          panel.border = element_rect(colour = "white", size = 2))
  
  right_map <- 
    active_DA %>% 
    ggplot() +
    geom_sf(data = province, colour = "transparent", fill = "grey93") +
    geom_sf(aes(fill = percentage), colour = "transparent") +
    geom_sf(data = water, fill = "white", colour = "transparent") +
    scale_fill_stepsn(colors = col_palette[c(5, 3, 4, 1, 6)],
                      breaks = c(0, 0.025, 0.05, 0.075, 0.10, 0.125, 0.15),
                      na.value = "grey80",
                      limits = c(0, 0.15), oob = scales::squish, 
                      labels = scales::percent)  +
    guides(fill = guide_colourbar(title = "STAs/\ndwelling",
                                  title.vjust = 1)) + 
    gg_bbox(active_EW) +
    theme_void() +
    theme(text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold",
                                      size = 7),
          legend.title.align = 0.9,
          legend.text = element_text(family = regular, size = 5),
          panel.border = element_rect(colour = "white", size = 2))
  
  left_map + right_map + plot_layout(guide = "collect") & 
    theme(legend.position = "bottom", legend.key.width = unit(1.8, "lines"))
  
}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_2.pdf"), 
         # plot = figure_2_2_fun("Futura", "Futura Condensed"), 
         plot = figure_1_2_fun(), 
         width = 8, height = 3.5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_2.pdf"))
}

```

STA activity in Prince Edward County is spread throughout the municipality, but is disproportionately located in the south and along the waterfront (Figure \@ref(fig:fig-1-2)). When STA activity is aggregated by electoral wards, Picton accounts for `r picton_listing_pct` of all listings and for `r picton_rev_pct` of all host revenue (Table \@ref(tab:tab-1-1)). Picton is followed by Hallowell (`r hallowell_listing_pct` of active listings and the largest share of total revenue at `r hallowell_rev_pct`) and Wellington (`r wellington_listing_pct` of active listings and `r wellington_rev_pct` of revenue). In per-capita terms, Bloomfield has by far the highest concentrations of STAs per dwellings with a third (`r bloomfield_per_cap`) of its dwellings operating as STAs, followed by Athol (`r athol_per_cap`) and Wellington (`r wellington_per_cap`). In all other wards, STAs account for between `r min_per_dwellings` and `r max_per_dwellings` of total dwellings. (These numbers were all 30-50% higher before the pandemic.)

``` {r fig-1-2, include = TRUE, fig.cap = '(ref:fig-1-2)', fig.align = "center"}

figure_1_2_fun()

```

(ref:fig-1-2) _Active STAs as a share of all dwelling units in Prince Edward County, by ward (L) and dissemination area (R)_

``` {r tab-1-1, include = TRUE}

library(kableExtra)

EW_breakdown %>% 
  arrange(-active_listings) %>% 
  mutate(active_listings = prettyNum(round(active_listings, -1), ","),
         active_growth_2019_2021 = scales::percent(active_growth_2019_2021, 0.1),
         listings_pct_dwellings = scales::percent(listings_pct_dwellings, 0.1),
         daily_rev = scales::dollar(round(daily_rev, -2)),
         rev_growth_2019_2021 = scales::percent(rev_growth_2019_2021, 0.1)) %>%
  select(ward, active_listings, active_growth_2019_2021, listings_pct_dwellings, daily_rev, rev_growth_2019_2021) %>% 
  add_row(ward = "Prince Edward County",
          active_listings = avg_listings_active,
          active_growth_2019_2021 = paste0("-", active_yoy_listings),
          listings_pct_dwellings = {
            avg_listings_active %>% 
              parse_number() %>% 
              {. / sum(EW$dwellings)} %>% 
              scales::percent(0.1)},
          daily_rev = daily_rev,
          rev_growth_2019_2021 = paste0("-", active_yoy_revenue),
          .before = 1) %>% 
  filter(!is.na(ward)) %>%
  set_names(c("Ward", 
              "Active listings",
              "Annual listing growth (2019-2021)",
              "Active listings as % of dwellings",
              "Average Daily revenue",
              "Daily revenue growth (2019-2021)")) %>% 
  kbl(caption = "Wards with at least 20 daily active listings in 2021",
      align = "lrrrrr") %>% 
  kable_styling(latex_options="scale_down") %>% 
  row_spec(1, background = paste0(col_palette[2], "50"))

```

<br>

## Listing types and sizes

``` {r para_5, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

bedrooms <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(housing, property_ID %in% active_2021, listing_type == "Entire home/apt") %>% 
  mutate(bedrooms = if_else(bedrooms >= 3, "3+", as.character(bedrooms))) %>% 
  count(bedrooms) %>% 
  mutate(percentage = n / sum(n))

one_bedrooms <- 
  bedrooms %>% 
  filter(bedrooms == "1") %>% 
  pull(percentage) %>% 
  scales::percent(0.1)

two_bedrooms <- 
  bedrooms %>% 
  filter(bedrooms == "2") %>% 
  pull(percentage) %>% 
  scales::percent(0.1)

three_bedrooms <- 
  bedrooms %>% 
  filter(bedrooms == "3+") %>% 
  pull(percentage) %>% 
  scales::percent(0.1)

studios <- 
  bedrooms %>% 
  filter(bedrooms == "0") %>% 
  pull(percentage) %>% 
  scales::percent(0.1)

eh_3_bedroom <- 
  property %>% 
  filter(housing, scraped >= start_2021, 
         listing_type == "Entire home/apt", !is.na(bedrooms)) %>% 
  st_drop_geometry() %>% 
  summarize(bed_3 = mean(bedrooms <= 3)) %>% 
  pull(bed_3) %>% 
  scales::percent(0.1)

```

STAs listed on Airbnb can be one of four types: entire homes or apartments, private rooms, shared rooms, and hotel rooms. We have excluded the latter from our analysis, since we focus only on STAs located in housing units. In 2021 entire-home listings accounted for `r eh_listings` of all daily active listings, and `r eh_revenue` of total host revenue (Table \@ref(tab:tab-1-2)). Private rooms accounted for nearly all of the remainder. Moreover, the dominance of entire-home listings in Prince Edward County’s STA market has been    increasing over time, as the quantity of private-room listings was on the decline even before the pandemic.

``` {r tab-1-2, include = TRUE}

library(kableExtra)

# Exclude shared room as too marginal
listing_type_breakdown[1:2,] %>%
  mutate(active_listings = prettyNum(round(active_listings, digits = -1), ","),
         revenue = scales::dollar(revenue, 0.1, 1 / 1000000),
         pct_of_listings = scales::percent(pct_of_listings, 0.1),
         pct_of_revenue = scales::percent(pct_of_revenue, 0.1),
         pct_listing_growth_2019_2021 = scales::percent(pct_listing_growth_2019_2021, 0.1)) %>% 
  rename(`Listing type` = listing_type,
         `Active listings` = active_listings,
         `2021 revenue so far (Jan-Aug, million)` = revenue,
         `Share of all listings` = pct_of_listings,
         `Share of all revenue` = pct_of_revenue,
         `Listing growth (2019-2021)` = pct_listing_growth_2019_2021
         ) %>% 
  kbl(caption = "Listing type prevalence in Prince Edward County",
      align = "lrrrrr") %>% 
  kable_styling(latex_options="scale_down")

```

Entire-home STAs can be single-family homes, townhouses, apartments, or condominium units. More than half (`r three_bedrooms`) of these were three-or-more-bedroom housing units, and a quarter (`r two_bedrooms`) were two-bedroom units. A fifth (`r one_bedrooms`) had one bedroom, and only `r studios` were studios. In general, three-or-more-bedroom units are over-represented on STA platforms in comparison with the County’s overall housing stock.

<br>

## Revenue distribution among STA hosts

``` {r para_9, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

# Host deciles table for figure
host_deciles <-
  daily %>%
  filter(date >= start_2021, status == "R", !is.na(host_ID)) %>%
  group_by(host_ID) %>%
  summarize(rev = sum(price)) %>% 
  summarize(all = sum(rev),
            top_10 = sum(rev[rev > quantile(rev, c(0.90))] / all),
            top_20 = sum(rev[rev > quantile(rev, c(0.80))] / all) - 
              sum(rev[rev > quantile(rev, c(0.90))] / all),
            top_30 = sum(rev[rev > quantile(rev, c(0.70))] / all) - 
              sum(rev[rev > quantile(rev, c(0.80))] / all),
            top_40 = sum(rev[rev > quantile(rev, c(0.60))] / all) - 
              sum(rev[rev > quantile(rev, c(0.70))] / all),
            top_50 = sum(rev[rev > quantile(rev, c(0.50))] / all) - 
              sum(rev[rev > quantile(rev, c(0.60))] / all),
            top_60 = sum(rev[rev > quantile(rev, c(0.40))] / all) - 
              sum(rev[rev > quantile(rev, c(0.50))] / all),
            top_70 = sum(rev[rev > quantile(rev, c(0.30))] / all) - 
              sum(rev[rev > quantile(rev, c(0.40))] / all),
            top_80 = sum(rev[rev > quantile(rev, c(0.20))] / all) - 
              sum(rev[rev > quantile(rev, c(0.30))] / all),
            top_90 = sum(rev[rev > quantile(rev, c(0.10))] / all) - 
              sum(rev[rev > quantile(rev, c(0.20))] / all),
            top_100 = sum(rev[rev > quantile(rev, c(0.00))] / all) - 
              sum(rev[rev > quantile(rev, c(0.10))] / all)) %>% 
  select(-all) %>% 
  pivot_longer(everything(), names_to = "percentile", values_to = "value") %>% 
  mutate(percentile = factor(percentile, levels = paste0("top_", 1:10 * 10))) %>% 
  mutate(perfect_distribution = 0.1,
         decile = 1:10,
         dummy_1 = perfect_distribution,
         dummy_2 = value) %>%  
  rename("0" = perfect_distribution, "1" = value, "0.25" = dummy_1, 
         "0.75" = dummy_2) %>%
  pivot_longer(c("0","0.25", "0.75", "1"), names_to = "position") %>% 
  mutate(position = as.numeric(position),
         display_val = scales::percent(value, .1)) %>% 
  group_by(position) %>% 
  mutate(absolute_val = slide_dbl(value, ~{.x[1] / 2 + sum(.x[-1])}, 
                                  .after = 9)) %>% 
  ungroup() %>% 
  mutate(
    display_val = paste0("earned ", display_val, "\nof revenue"),
    display_percentile = case_when(
      percentile == "top_10" ~ "Top 10% of hosts...",
      percentile == "top_20" ~ "Next 10% of hosts...",
      TRUE ~ NA_character_))

top_host_listings <- 
  property %>% 
  filter(host_ID == host_rev[which.max(host_rev$rev),]$host_ID) %>% 
  nrow()

top_host_rev <- 
  host_rev %>% 
  filter(rev == max(rev)) %>% 
  pull(rev) %>% 
  scales::dollar(accuracy = 0.1, scale = 1 / 1000000, suffix = " million")

median_host_rev <- 
  median(host_rev$rev) %>%
  scales::dollar(accuracy = 100)

n_hosts_over_100 <- 
  host_rev %>% 
  filter(rev >= 100000) %>% 
  nrow()

host_rev_top_10 <- 
  host_rev %>% 
  summarize(top_10 = sum(rev[rev > quantile(rev, .9)]) / sum(rev)) %>% 
  pull(top_10) %>% 
  scales::percent(0.1)

host_rev_top_5 <- 
  host_rev %>% 
  summarize(top_5 = sum(rev[rev > quantile(rev, .95)]) / sum(rev)) %>% 
  pull(top_5) %>% 
  scales::percent(0.1)

host_rev_top_1 <- 
  host_rev %>% 
  summarize(top_1 = sum(rev[rev > quantile(rev, .99)]) / sum(rev)) %>% 
  pull(top_1) %>% 
  scales::percent(0.1)

#### same for 2019

host_deciles_2019 <-
  daily %>%
  filter(date >= start_2019, date <= str_replace(max(daily$date), "^\\d{4}", "2019"), 
         status == "R", !is.na(host_ID)) %>%
  group_by(host_ID) %>%
  summarize(rev = sum(price)) %>% 
  summarize(all = sum(rev),
            top_10 = sum(rev[rev > quantile(rev, c(0.90))] / all),
            top_20 = sum(rev[rev > quantile(rev, c(0.80))] / all) - 
              sum(rev[rev > quantile(rev, c(0.90))] / all),
            top_30 = sum(rev[rev > quantile(rev, c(0.70))] / all) - 
              sum(rev[rev > quantile(rev, c(0.80))] / all),
            top_40 = sum(rev[rev > quantile(rev, c(0.60))] / all) - 
              sum(rev[rev > quantile(rev, c(0.70))] / all),
            top_50 = sum(rev[rev > quantile(rev, c(0.50))] / all) - 
              sum(rev[rev > quantile(rev, c(0.60))] / all),
            top_60 = sum(rev[rev > quantile(rev, c(0.40))] / all) - 
              sum(rev[rev > quantile(rev, c(0.50))] / all),
            top_70 = sum(rev[rev > quantile(rev, c(0.30))] / all) - 
              sum(rev[rev > quantile(rev, c(0.40))] / all),
            top_80 = sum(rev[rev > quantile(rev, c(0.20))] / all) - 
              sum(rev[rev > quantile(rev, c(0.30))] / all),
            top_90 = sum(rev[rev > quantile(rev, c(0.10))] / all) - 
              sum(rev[rev > quantile(rev, c(0.20))] / all),
            top_100 = sum(rev[rev > quantile(rev, c(0.00))] / all) - 
              sum(rev[rev > quantile(rev, c(0.10))] / all)) %>% 
  select(-all) %>% 
  pivot_longer(everything(), names_to = "percentile", values_to = "value") %>% 
  mutate(percentile = factor(percentile, levels = paste0("top_", 1:10 * 10))) %>% 
  mutate(perfect_distribution = 0.1,
         decile = 1:10,
         dummy_1 = perfect_distribution,
         dummy_2 = value) %>%  
  rename("0" = perfect_distribution, "1" = value, "0.25" = dummy_1, 
         "0.75" = dummy_2) %>%
  pivot_longer(c("0","0.25", "0.75", "1"), names_to = "position") %>% 
  mutate(position = as.numeric(position),
         display_val = scales::percent(value, .1)) %>% 
  group_by(position) %>% 
  mutate(absolute_val = slide_dbl(value, ~{.x[1] / 2 + sum(.x[-1])}, 
                                  .after = 9)) %>% 
  ungroup() %>% 
  mutate(
    display_val = paste0("earned ", display_val, "\nof revenue"),
    display_percentile = case_when(
      percentile == "top_10" ~ "Top 10% of hosts...",
      percentile == "top_20" ~ "Next 10% of hosts...",
      TRUE ~ NA_character_))

top_host_listing_2019 <- 
  property %>% 
  filter(host_ID == host_rev[which.max(host_rev_2019$rev),]$host_ID) %>% 
  nrow()

top_host_rev_2019 <- 
  host_rev_2019 %>% 
  filter(rev == max(rev)) %>% 
  pull(rev) %>% 
  scales::dollar(accuracy = 0.1, scale = 1 / 1000000, suffix = " million")

median_host_rev_2019 <- 
  median(host_rev_2019$rev) %>%
  scales::dollar(accuracy = 100)

n_hosts_over_100_2019 <- 
  host_rev_2019 %>% 
  filter(rev >= 100000) %>% 
  nrow()

host_rev_top_10_2019 <- 
  host_rev_2019 %>% 
  summarize(top_10 = sum(rev[rev > quantile(rev, .9)]) / sum(rev)) %>% 
  pull(top_10) %>% 
  scales::percent(0.1)

host_rev_top_5_2019 <- 
  host_rev_2019 %>% 
  summarize(top_5 = sum(rev[rev > quantile(rev, .95)]) / sum(rev)) %>% 
  pull(top_5) %>% 
  scales::percent(0.1)

host_rev_top_1_2019 <- 
  host_rev_2019 %>% 
  summarize(top_1 = sum(rev[rev > quantile(rev, .99)]) / sum(rev)) %>% 
  pull(top_1) %>% 
  scales::percent(0.1)

diff_host_100 <- 
  (n_hosts_over_100_2019 - n_hosts_over_100) %>% 
  {. * -1}

# End month
end_month <- 
  max(daily$date) %>% 
  substr(6, 7) %>% 
  as.numeric() %>% 
  {month.name[.]}

```
``` {r para_10, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

# ML table for figure
ML <- 
  daily %>% 
  filter(status != "B") %>% 
  group_by(date) %>% 
  summarize(Listings = mean(multi),
            Revenue = sum(price[status == "R" & multi], na.rm = TRUE) / 
              sum(price[status == "R"], na.rm = TRUE)) %>% 
  mutate(across(where(is.numeric), slide_dbl, mean, .before = 13)) %>% 
  pivot_longer(c(Listings, Revenue), names_to = "Multilisting percentage",
               values_to = "value")

ML_per_listings_rev <- 
ML %>% 
  filter(date >= "2018-01-01") %>% 
  group_by(`Multilisting percentage`) %>% 
  summarize(n = mean(value)) %>% 
  pull(n) %>% 
  scales::percent(., accuracy = 0.1)

```

A crucial concept for understanding the structure of a STA market is the distinction between casual STAs (“home sharing”) and dedicated STAs (“commercial operations”). One way to capture this distinction is to examine how many STA listings each host operates. Some hosts operate multiple STA units, which strongly suggests that they are commercial operators rather than a casual home sharers. To take the simplest case, a host with two or more entire-home listings active on the same day cannot be operating both listings out of their principal residence. We consider entire-homes to be "multilistings" if they are operated by hosts who are simultaneously operating other entire-home listings. We define private-room multilistings as cases where a host has three or more private-room listings operating on the same day. Since `r eh_3_bedroom` of entire-home listings have three or fewer bedrooms, there will be limited cases where a host operating three private-room STA listings in a dwelling unit has not converted the entire unit into a dedicated STA.

In 2021, `r ml_listings` of active listings in Prince Edward County were multilistings, earning `r ml_revenue` of total host revenue. Multilistings have been steady since 2018, at around 50% of both listings (`r ML_per_listings_rev[1]`) and revenue (`r ML_per_listings_rev[2]`), and the Covid-19 pandemic has not affected these proportions.

``` {r make_fig_1_3}

figure_1_3_fun <- function(regular = "", condensed = "") {
  
  revenue_colour <- colorRampPalette(col_palette[c(7, 6, 1, 4, 3, 2, 5)])(10)

  host_deciles %>% 
  ggplot(aes(position, value, group = decile, fill = decile)) +
  geom_area(colour = "white", lwd = 1.2) +
  geom_text(aes(x = 0.02, y = absolute_val, label = display_percentile), 
            data = filter(host_deciles, position == 0, decile <= 2),
            family = regular, 
            hjust = 0) +
  geom_text(aes(x = 0.98, y = absolute_val, label = display_val), 
            data = filter(host_deciles, position == 1, decile <= 2),
            family = regular, 
            hjust = 1) +
  scale_y_continuous(name = "Host decile", label = scales::label_percent(1),
                     breaks = seq(0, 1, by = 0.1), limits = c(0, 1),
                     sec.axis = sec_axis(~., 
                                         name = "% of total revenue",
                                         labels = derive(), 
                                         breaks = derive())) +
  scale_fill_gradientn(colours = revenue_colour) +
  theme_void() +
  theme(legend.position = "none",
        text = element_text(family = regular),
        axis.text.y = element_text(hjust = 1),
        axis.title.y.left = element_text(
          angle = 90, margin = margin(0, 10, 0, 0)),
        axis.title.y.right = element_text(
          angle = 270, margin = margin(0, 0, 0, 10)),
        axis.title.x = element_blank(), 
        axis.text.x = element_blank())

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_3.pdf"), 
         # plot = figure_2_6_fun("Futura", "Futura Condensed"), 
         plot = figure_1_3_fun(),
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_3.pdf"))
}

```

Another way to capture the distinction between part-time and full-time STA operations is to examine the distribution of revenue among STA hosts. Is revenue widely distributed between many part-time hosts of single listings, or concentrated among a small number of commercial operators who control many full-time listings? Among all the STA hosts who earned revenue in Prince Edward County in 2021, the median revenue from January to `r end_month` was `r median_host_rev`. Throughout the county, there were `r n_hosts_over_100` hosts that earned more than $100,000 in 2021, which is `r diff_host_100` more hosts than during the same months of 2019. Figure \@ref(fig:fig-1-3) shows the percentage of the total `r daily_rev` in STA daily revenue which accrued to each decile of hosts. The figure shows that revenue is disproportionately concentrated among a small number of hosts; the top 10% earned `r host_rev_top_10`: the top 5% earned `r host_rev_top_5` of revenue, while the top 1% of hosts earned `r host_rev_top_1` of all revenue. The pandemic hasn't changed the revenue distribution among the STA hosts who are still operating, but in 2021 there were fewer hosts than in 2019, each earning more revenue on average than in 2019. In absolute terms, the financial incentive to operate STAs in PEC has therefore increased during the pandemic.

``` {r fig-1-3, include = TRUE, fig.cap = '(ref:fig-1-3)', fig.align = "center"}

figure_1_3_fun()

```

(ref:fig-1-3) _STA host revenue distribution in Prince Edward County_

<br>

## STA growth rates

``` {r make_fig_1_4}

figure_1_4_fun <- function(regular = "", condensed = "") {
  
  daily_variation %>% 
    mutate(label = if_else(date == "2019-10-01", var, NA_character_)) %>%
    ggplot(aes(date, value, colour = var)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    geom_line(lwd = 1, na.rm = TRUE) +
    geom_label(aes(label = label), family = condensed, size = 3) +
    scale_x_date(name = NULL) +
    scale_y_continuous(name = NULL, limits = c(-1, NA), 
                       labels = scales::percent) +
    scale_color_manual(name = NULL, values = col_palette[c(5, 1)]) +
    theme_minimal() +
    theme(legend.position = "none", panel.grid.minor.x = element_blank(),
          text = element_text(family = regular))
  
}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_4.pdf"), 
         # plot = figure_2_3_fun("Futura", "Futura Condensed"), 
         plot = figure_1_4_fun(), 
         width = 9, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_4.pdf"))
}

```

Figure \@ref(fig:fig-1-4) shows the change in active listings and revenue relative to one year earlier, which is a convenient way to remove seasonal variation to identify underlying growth trends. Until the end of 2019, the growth rate in the number of active daily STA listings had been steadily slowing. Each date generally had more active listings than the same date of the previous year, but that difference was shrinking. By the beginning of 2020 (before the pandemic), active listing numbers had begun to decline somewhat, before dropping sharply with the onset of Covid-19. Listing numbers continued to drop through 2020 and the beginning of 2021, but by the summer of 2021 they had once again begun to grow, albeit from a lower, pandemic baseline. Revenue growth has followed a different pattern. It was positive through much of 2019, and remained neutral or positive throughout the first year of the pandemic. In the summer of 2021, despite active listing numbers only beginning to recover, revenue was up significantly over 2020.

``` {r fig-1-4, include = TRUE, fig.cap = '(ref:fig-1-4)', fig.align = "center"}

figure_1_4_fun()

```

(ref:fig-1-4) _Change in daily active listings and host revenue compared to one year earlier (14-day average)_

``` {r para_6, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

#' YOY listing growth, 2019
listing_growth_2019 <- 
  daily %>% 
  filter(status != "B", date >= start_2019 - years(1), date <= end_2019) %>% 
  group_by(year_2019 = date >= start_2019) %>% 
  summarize(n = n() / 365) %>% 
  summarize(change = (n[2] - n[1]) / n[1])  %>% 
  pull(change) %>% 
  scales::percent(0.1)

#' YOY listing growth, 2021
listing_growth_2021 <- 
  daily %>% 
  filter(status != "B", date >= start_2019, 
         !c(date >= start_2020 & date <= end_2020)) %>% 
  group_by(year_2021 = date >= start_2021) %>% 
  summarize(n = n() / yday(max(date))) %>% 
  summarize(change = (n[2] - n[1]) / n[1])  %>% 
  pull(change) %>% 
  scales::percent(0.1)

```

Overall, the year-over-year change in average daily active listings from 2018 to 2019 was only `r listing_growth_2019`—the clear sign of a market reaching saturation, at least in supply terms if not pricing terms. Between 2019 and 2021, because of the Covid-19 pandemic, the change in active daily listings has been `r listing_growth_2021`.


## Diverging STA supply and demand during the Covid-19 pandemic

``` {r para_7, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

# YOY reservation change, 2019-2021
reservation_change_2021 <- 
  daily %>%
  filter(status == "R", date >= start_2019, 
         !c(date >= start_2020 & date <= end_2020)) %>%
  group_by(year_2021 = date >= start_2021) %>%
  summarize(n = n() / yday(max(date))) %>%
  summarize(change = (n[2] - n[1]) / n[1]) %>% 
  pull(change) %>% 
  scales::percent(0.1)

# YOY reservation change, 2018-2019
reservation_change_2019 <- 
  daily %>%
  filter(status == "R", date >= start_2019 - years(1), date <= end_2019) %>%
  group_by(year_2019 = date >= start_2019) %>%
  summarize(n = n()) %>%
  summarize(change = (n[2] - n[1]) / n[1]) %>% 
  pull(change) %>% 
  scales::percent(0.1)

# Reservation counts, 2019-2021
reservation_count_2021 <- 
  daily %>%
  filter(status == "R", date >= start_2019, 
         !c(date >= start_2020 & date <= end_2020)) %>%
  group_by(year_2021 = date >= start_2021) %>%
  summarize(n = n() / yday(max(date))) %>% 
  mutate(n = round(n, -1)) %>% 
  pull(n)

# Reservation counts, 2018-2019
reservation_count_2019 <- 
  daily %>%
  filter(status == "R", date >= start_2019 - years(1), date <= end_2019) %>%
  group_by(year_2019 = date >= start_2019) %>%
  summarize(n = n() /365) %>% 
  mutate(n = round(n, -1)) %>% 
  pull(n)

# YOY revenue change, 2019-2021
active_yoy_revenue_2021 <- 
  daily %>%
  filter(status == "R", date >= start_2019, 
         !c(date >= start_2020 & date <= end_2020)) %>%
  group_by(year_2021 = date >= start_2021) %>%
  summarize(revenue = sum(price) / yday(max(date))) %>%
  summarize(change = (revenue[2] - revenue[1]) / revenue[1]) %>% 
  pull(change) %>% 
  {. * -1} %>% 
  scales::percent(0.1)

```

```{r reservation_trend, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}
library(tsibble)
library(feasts)
library(fable)

# Get daily reservations and prices
reservations_and_prices <- 
  daily %>% 
  filter(date >= "2017-06-01", status == "R") %>% 
  group_by(date) %>% 
  summarize(res = n(), price = mean(price))

# Create monthly time series
monthly_series <- 
  reservations_and_prices %>% 
  tsibble::as_tsibble(index = date) %>% 
  tsibble::index_by(yearmon = yearmonth(date)) %>% 
  summarize(price = sum(res * price) / sum(res),
            res = sum(res)) %>% 
  relocate(price, .after = res)

# Create reservations model
reservations_model <- 
  monthly_series %>%
  filter(yearmon <= yearmonth("2020-02")) %>% 
  model(res = decomposition_model(
    STL(res, robust = TRUE), NAIVE(season_adjust)))

# Create price model
price_model <- 
  monthly_series %>% 
  filter(yearmon <= yearmonth("2020-02")) %>% 
  model(price = decomposition_model(
    STL(price, robust = TRUE), NAIVE(season_adjust)))

# Create reservations forecast
reservations_forecast <-
  reservations_model %>% 
  forecast(h = "24 months") %>% 
  as_tibble() %>% 
  select(yearmon, res_trend_month = .mean)

# Create price forecast
price_forecast <- 
  price_model %>% 
  forecast(h = "24 months") %>% 
  as_tibble() %>% 
  select(yearmon, price_trend_month = .mean)

# Integrate forecasts into monthly data
monthly_series <- 
  monthly_series %>% 
  left_join(reservations_forecast, by = "yearmon") %>% 
  left_join(price_forecast, by = "yearmon")

# Integrate forecasts into daily data
reservations_and_prices <- 
  reservations_and_prices %>% 
  mutate(across(c(res, price), slider::slide_dbl, ~.x[1], .before = 366, 
                .complete = TRUE, .names = "{.col}_trend")) %>%
  mutate(across(c(res_trend, price_trend), slider::slide_dbl, mean, 
                .before = 6, .complete = TRUE)) %>%
  mutate(across(c(res_trend, price_trend), 
                ~if_else(date >= "2020-03-01", .x, NA_real_))) %>%
  mutate(yearmon = yearmonth(date)) %>%
  left_join(select(monthly_series, -res, -price), by = "yearmon") %>%
  group_by(yearmon) %>%
  mutate(res_trend = res_trend * res_trend_month / sum(res_trend),
         price_trend = price_trend * price_trend_month / mean(price_trend)) %>%
  ungroup() %>%
  select(-c(yearmon:price_trend_month))

res_total_pandemic_dif <-
  reservations_and_prices |> 
  filter(date >= "2020-03-01") |> 
  summarize(res_dif = sum(res_trend - res)) |> 
  pull(res_dif) |> 
  scales::comma(100)

res_total_pandemic <-
  reservations_and_prices |> 
  filter(date >= "2020-03-01") |> 
  summarize(res_tot = sum(res)) |> 
  pull(res_tot) |> 
  scales::comma(100)

res_total_pandemic_pct <-
  {(parse_number(res_total_pandemic) - parse_number(res_total_pandemic_dif)) / 
  parse_number(res_total_pandemic)} %>%
  scales::percent(0.1)

res_total_pandemic_trend <-
  reservations_and_prices |> 
  filter(date >= "2020-03-01") |> 
  summarize(res_tot = sum(res_trend)) |> 
  pull(res_tot) |> 
  scales::comma(100)

price_difs <- 
  reservations_and_prices |> 
  mutate(price_dif = price - price_trend,
         price_dif_pct = (price - price_trend) / price_trend) |> 
  summarize(max_price = max(price, na.rm = TRUE),
            max_dif = max(price_dif, na.rm = TRUE),
            max_dif_pct = max(price_dif_pct, na.rm = TRUE),
            max_price_date = date[which.max(price)],
            max_dif_date = date[which.max(price_dif)],
            max_dif_pct_date = date[which.max(price_dif_pct)])

max_price <- scales::dollar(price_difs$max_price, 1)

var_rise_price <-
  daily |> 
  filter(year(date) %in% c(2019, 2021),
         month(date) <= month(max(daily$date))) |> 
  group_by(year_2021 = year(date) == 2021) |> 
  summarize(avg_price = mean(price)) |> 
  summarize((avg_price[2] - avg_price[1]) / avg_price[1]) |> 
  pull() |> 
  scales::percent(0.1)

```

``` {r make_fig_1_5}

figure_1_5_fun <- function(regular = "", condensed = "") {

  reservations_and_prices %>% 
  mutate(res = slider::slide_dbl(res, mean, .before = 6, .complete = TRUE)) %>% 
  select(date, res, res_trend) %>% 
  pivot_longer(-date) %>% 
  filter(!is.na(value)) %>%
  mutate(label = case_when(
    date == "2019-07-05" & name == "res" ~ "Actual reservations", 
    date == "2020-08-05" & name == "res_trend" ~ "Expected reservations",
    TRUE ~ NA_character_)) %>%
  ggplot() +
  geom_ribbon(aes(x = date, ymin = res, ymax = res_trend, group = 1),
              data = {reservations_and_prices %>% 
                  mutate(res = slider::slide_dbl(res, mean, .before = 6, .complete = TRUE))
                }, fill = col_palette[3],
              alpha = 0.3) +
  geom_line(aes(date, value, color = name), lwd = 1) +
    geom_label(aes(date, value, label = label, color = name), size = 3) +
  scale_x_date(name = NULL, limits = as.Date(c("2018-01-01", NA))) +
  scale_y_continuous(name = NULL, limits = c(0, NA), 
                     label = scales::comma) +
  scale_color_manual(name = NULL, 
                     labels = c("Actual reservations", "Expected reservations"), 
                     values = col_palette[c(5, 1)]) +
  theme_minimal() +
  theme(legend.position = "none",
       panel.grid.minor.x = element_blank(),
       text = element_text(face = "plain", family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_5.pdf"),
         # plot = figure_2_4_fun("Futura", "Futura Condensed"),
         plot = figure_1_5_fun(),
         width = 9, height = 5, units = "in", useDingbats = FALSE)

  extrafont::embed_fonts(here("output", "figures", "figure_1_5.pdf"))
}

```

Figure \@ref(fig:fig-1-5) provides a closer look at daily reservations since 2019, comparing the actual trajectory of reservations during the pandemic with what the trajectory of reservations would have been expected to be, based on previous growth in Prince Edward County's STA market but in the absence of the pandemic. (To do this, we use seasonal decomposition to identify the regular seasonal fluctuations in STA activity and separate them from the underlying patterns of growth or decline.) The pattern is clear: outside of the summer peak, reservations during the pandemic have been roughly in line with the pre-pandemic trend, but the summer peak has been lower since 2020. Nightly reservations would have been expected to reach nearly 800 at the height of the summer, but barely crossed 600—a greater than 20% decline. In total, from March 2020 through September 2021, we estimate that there have been `r res_total_pandemic_dif` fewer STA nights reserved than would normally have been expected to occur. The `r res_total_pandemic` total nights reserved in this time period is `r res_total_pandemic_pct` of the `r res_total_pandemic_trend` nights total that would represent the previous growth trend.

``` {r fig-1-5, include = TRUE, fig.cap = '(ref:fig-1-5)', fig.align = "center"}

figure_1_5_fun()

```
(ref:fig-1-5) _Actual and expected reservations during the Covid-19 pandemic (7-day average)_

``` {r make_fig_1_6}

figure_1_6_fun <- function(regular = "", condensed = "") {

  reservations_and_prices %>% 
  mutate(price = slider::slide_dbl(price, mean, .before = 6, .complete = TRUE)) %>% 
  select(date, price, price_trend) %>% 
  pivot_longer(-date) %>% 
  filter(!is.na(value)) %>%
  mutate(label = case_when(
    date == "2019-07-05" & name == "price" ~ "Actual nightly price", 
    date == "2021-04-15" & name == "price_trend" ~ "Expected nightly price",
    TRUE ~ NA_character_)) %>%
  ggplot() +
  geom_ribbon(aes(x = date, ymin = price, ymax = price_trend, group = 1),
              data = {reservations_and_prices %>% 
                  mutate(price = slider::slide_dbl(price, mean, .before = 6, .complete = TRUE))
                }, fill = col_palette[3],
              alpha = 0.3) +
  geom_line(aes(date, value, color = name), lwd = 1) +
    geom_label(aes(date, value, label = label, color = name), size = 3) +
  scale_x_date(name = NULL, limits = as.Date(c("2018-01-01", NA))) +
  scale_y_continuous(name = NULL, limits = c(150, NA), 
                     label = scales::dollar) +
  scale_color_manual(name = NULL, values = col_palette[c(5, 1)]) +
  theme_minimal() +
  theme(legend.position = "none",
       panel.grid.minor.x = element_blank(),
       text = element_text(face = "plain", family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_6.pdf"),
         # plot = figure_2_4_fun("Futura", "Futura Condensed"),
         plot = figure_1_6_fun(),
         width = 9, height = 5, units = "in", useDingbats = FALSE)

  extrafont::embed_fonts(here("output", "figures", "figure_1_6.pdf"))
}

```

While reservation volumes have been down during the pandemic, the opposite is true of nightly STA prices. Prior to March 2020, nightly prices had been remarkably stable in Prince Edward County, fluctuating around $270 with summer peaks slightly above $300 and winter troughs below $250 (Figure \@ref(fig:fig-1-6)). Since March 2020 the seasonal fluctuation has remained, but the underlying growth trend has turned sharply positive. Nightly prices reached a peak of `r max_price` in early September 2021, nearly double what the pre-pandemic trend would have predicted. Overall, from January to September 2021, nightly prices have been `r var_rise_price` higher than during these same months of 2019.

``` {r fig-1-6, include = TRUE, fig.cap = '(ref:fig-1-6)', fig.align = "center"}

figure_1_6_fun()

```
(ref:fig-1-6) _Actual and expected nightly prices during the Covid-19 pandemic (7-day average)_

The divergent patterns in STA reservations and nightly prices present a puzzle. The rapid increase in prices is a clear sign that demand for Prince Edward County STAs has outstripped supply. Normally, the result would be new supply arriving on the market to match that demand, which in turn would moderate the price increases and lead to a new supply/demand equilibrium. That has not happened, however: supply in the last two summer seasons has in fact been substantially lower than the pre-pandemic level, to say nothing of the much higher level of supply which would have been expected in the face of dramatic price increases. These facts strongly suggest that some additional factor has limited the potential supply of STAs in Prince Edward County—a possibility that we will explore in a subsequent chapter.


## Flattening seasonal and geographic STA variation during the pandemic

```{r para_6_2}

per_res_month <- 
daily %>%
  filter(status == "R", date >= start_2019, 
         !c(date >= str_replace(max(daily$date), "^\\d{4}", "2019") & date <= end_2020)) %>%
  count(date) %>% 
  mutate(year = year(date),
         month = month(date)) %>%
  # filter(!month %in% c(1,2)) %>% 
  group_by(year, month) %>% 
  summarize(n = sum(n)) %>% 
  group_by(year) %>% 
  mutate(yearly_per = n/sum(n)) 

peaks_yearly_per <- 
per_res_month %>% 
  arrange(-yearly_per) %>% 
  group_by(year) %>% 
  slice(1) %>% 
  mutate(yearly_per = scales::percent(yearly_per))

august_2019_per_R <- 
  peaks_yearly_per %>% 
  filter(year == 2019) %>% 
  pull(yearly_per)

august_2021_per_R <- 
  peaks_yearly_per %>% 
  filter(year == 2021) %>% 
  pull(yearly_per)

```

``` {r make_fig_1_7}

figure_1_7_fun <- function(regular = "", condensed = "") {
  
  daily |> 
    filter(status == "R", year(date) %in% c(2019, 2021), 
           month(date) <= month(max(daily$date))) |> 
    group_by(year_2021 = year(date) == 2021) |> 
    count(date) |> 
    mutate(n = n / sum(n), 
           n = slide_dbl(n, mean, .before = 6, .complete = TRUE)) |> 
    ungroup() |> 
    mutate(date = as.Date(str_replace(date, "^\\d{4}", "2019")), 
           year = if_else(year_2021, "2021", "2019")) |> 
    mutate(label = if_else(date == "2019-04-10", year, NA_character_)) |> 
    ggplot(aes(date, n, color = year)) +
    geom_line(size = 1) +
    geom_label(aes(label = label), size = 3) +
    scale_color_manual(values = col_palette[1:2]) +
    scale_y_continuous(name = NULL, limits = c(0, 0.01),
                       labels = scales::percent_format(accuracy = 0.1)) +
    theme_minimal() +
    xlab(NULL) +
    theme(legend.position = "none", panel.grid.minor.x = element_blank(),
          text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_7.pdf"), 
         plot = figure_1_7_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_7.pdf"))
}


```

While the largest changes to Prince Edward County's STA market since the Covid-19 pandemic began are the declining reservations and skyrocketing prices, there are two other (related) patterns of note. The first is that the seasonality of the County's STA activity has been flattened. As previously noted, STA reservations have been substantially below trend during the summer months of 2020 and 2021. But off-season reservations have not been nearly as strongly affected, remaining very near to pre-pandemic trends. The result is that, in 2020 and 2021, the summer has accounted for a much smaller share of total annual reservations than previous years (Figure \@ref(fig:fig-1-7)). (In 2019, August—the peak month—accounted for `r august_2019_per_R` of total reserved nights from January to September, while in 2021 the corresponding figure had dropped to `r august_2021_per_R`.)

``` {r fig-1-7, include = TRUE, fig.cap = '(ref:fig-1-7)', fig.align = "center"}

figure_1_7_fun()

```
(ref:fig-1-7) _Percentage of total annual reservations occurring each day, January to September (7-day average)_

```{r, make_fig_1_8}

ward_type_comp <- 
  daily |> 
  left_join(st_drop_geometry(select(EW, -dwellings)), by = "ward") |> 
  filter(status == "R", !is.na(type)) |> 
  count(type, date) |> 
  group_by(date) |> 
  mutate(pct = n / sum(n)) |> 
  group_by(type) |> 
  mutate(pct = slide_dbl(pct, mean, .before = 6, .complete = TRUE)) |> 
  ungroup() |> 
  filter(year(date) %in% c(2019, 2021), month(date) <= 9) |> 
  mutate(year = year(date), .after = date)

figure_1_8_fun <- function(regular = "", condensed = "") {

ward_type_comp |> 
  mutate(label = if_else(date == "2019-02-10", type, NA_character_)) |> 
  ggplot() +
  geom_line(aes(date, pct, colour = type), size = 1) +
  geom_label(aes(date, pct, label = label, colour = type)) +
  facet_wrap(vars(year), scales = "free_x") +
  scale_x_date(name = NULL) +
  scale_color_manual(values = col_palette[1:3]) +
  scale_y_continuous(name = NULL, labels = scales::percent_format(accuracy = 1),
                     limits = c(0, 0.675)) +
  theme_minimal() +
    theme(legend.position = "NONE", panel.grid.minor.x = element_blank(),
          text = element_text(family = regular), 
          strip.text = element_text(face = "bold"))
}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_8.pdf"), 
         # plot = figure_3_4_fun("Futura", "Futura Condensed"), 
         plot = figure_1_8_fun(), 
         width = 9, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_8.pdf"))
}

```

Covid-19 has flattened the seasonality of STA activity in Prince Edward County, and it has also flattened geographic variation in that activity. Figure \@ref(fig:fig-1-8) shows the percentage of total reservations happening in town, township or village. In 2019, the townships had a relatively low share of STA reservations in the off-season—between 55% and 60%—which then rose substantially during the summer high season, to roughly 65%. The towns and villages displayed the opposite pattern: relatively more activity in the off season and less in the high season. In 2021, these curves are all flat. This pattern is consistent with the constrained supply of STAs identified above; the usual influx of summer STAs in the townships failed to arrive in 2021.

``` {r fig-1-8, include = TRUE, fig.cap = '(ref:fig-1-8)', fig.align = "center"}

figure_1_8_fun()

```
(ref:fig-1-8) _Share of daily total reservation, by type of ward (7-day average)_

<br>


## Prince Edward County in comparison with other non-urban tourist destinations

``` {r comparison, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "national_comparison.qs"))}

daily_comp <- qread(here("output", "national_comparison.qs"), nthreads = availableCores())
 
comp_table <-
  daily_comp |> 
  group_by(location, date) |> 
  summarize(
    active = sum(status %in% c("A", "R")),
    res = sum(status == "R"),
    price_eh = mean(price[status == "R" & listing_type == "Entire home/apt"]),
    .groups = "drop") |> 
  pivot_longer(c(active, res, price_eh), "category") |> 
  mutate(category = case_when(
    category == "active" ~ "Active listings",
    category == "res" ~ "Reservations",
    category == "price_eh" ~ "Nightly prices")) |> 
  mutate(category = factor(category, levels = c(
    "Active listings", "Reservations", "Nightly prices"))) |> 
  mutate(location = factor(location, levels = c(
    (unique(location))[c(1:4, 6:8)], "Prince Edward County")))

rm(daily_comp)

```

``` {r make_fig_1_9}

figure_1_9_fun <- function(regular = "", condensed = "") {
  
comp_table |> 
  group_by(location, category) |> 
  mutate(index = 100 * value / value[date == "2019-08-01"]) |> 
  mutate(index = slide_dbl(index, mean, .before = 6, .complete = TRUE)) |> 
  ungroup() |> 
  filter(date >= "2020-01-05") |> 
  ggplot(aes(date, index, colour = location, size = location)) +
  geom_line() +
  scale_x_date(name = NULL) +
  scale_y_continuous(name = NULL) + 
  scale_colour_manual(values = c("Prince Edward County" = col_palette[5]),
                      na.value = "grey80") +
  scale_size_manual(values = c("Prince Edward County" = 1.5), na.value = 0.5) +
  facet_wrap(vars(category), scales = "free_y") +
  theme_minimal() +
    theme(legend.position = "none", panel.grid.minor.x = element_blank(),
          text = element_text(family = regular),
          strip.text = element_text(face = "bold"))
  
}

if (build_figures) {
  ggsave(here("output", "figures", "figure_1_9.pdf"), 
         # plot = figure_2_7_fun("Futura", "Futura Condensed"), 
         plot = figure_1_9_fun(),
         width = 9, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_1_9.pdf"))
}

```

The preceding analysis demonstrates that Prince Edward County's STA market has undergone several significant transformations since the onset of the Covid-19 pandemic—above all a modest decline in summer-season reservations compared to previous trends but a dramatic increase in nightly prices. Prince Edward County is not the only major non-urban tourist destination in the country, however; to what extent have other areas seen similar developments? To answer this question, we compare the County with seven other top non-urban tourist destinations in Canada: the Blue Mountains (ON), Charlottetown (PE), Cape Breton Island (NS), Gaspésie (QC), Mont-Tremblant (QC), Tofino (BC), and Whistler (BC). Some of these destinations have strongly seasonal STA markets similar to Prince Edward County while others receive visitors throughout the year, but all have plausibly been subjected to similar dynamics with respect to tourism during the pandemic. Namely, these are all destinations nearby to major metropolitan areas, and thus may be receiving elevated tourist demand from nearby city dwellers who cancelled more distant travel plans and looked for alternative destinations closer to home.

Figure \@ref(fig:fig-1-9) shows active listings, reservations, and nightly prices in Prince Edward County in comparison with the other seven markets. (All data series are indexed to their values on August 1, 2019.) All three panels of the figure reveal a high level of diversity in STA market trajectories during the pandemic, but several patterns are clear. First, Prince Edward County has had among the lowest relative number of active STA listings and STA reservations of any of the areas. Most of the major non-urban tourist destinations in the country saw listings and reservations mostly recovered to summer 2019 levels by the end of summer 2021, and Prince Edward County stands out for the size of its ongoing gap in this regard. Second, Prince Edward County has seen by far the largest spike in nightly prices—almost every other comparable market had prices equal to or lower than August 2019 levels for most of the pandemic, and no other market has seen the kind of sustained upward trajectory which the County has undergone.

``` {r fig-1-9, include = TRUE, fig.cap = '(ref:fig-1-9)', fig.align = "center"}

figure_1_9_fun()

```
(ref:fig-1-9) _STA activity in Prince Edward County and other leading non-urban tourist destinations (2019-08-01 = 100)_

The only plausible conclusion of these facts is that Prince Edward County's STA market has been subjected to a different set of forces from those at work in comparable markets elsewhere in the country. In the next chapter we begin to explore the extent to which changes in the County's broader housing market could be responsible.

\newpage

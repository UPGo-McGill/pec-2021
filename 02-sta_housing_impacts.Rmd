# STA housing market impacts

<style type="text/css">
  body{
  font-family: Futura, Helvetica, Arial;
}
</style>

<br>

```{r setup, include = FALSE, echo = FALSE}

library(here)
source(here("R", "01_startup.R"))

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# Function for checking file modifications
mtime <- function(files) lapply(Sys.glob(files), function(x) file.info(x)$mtime)

qload(here("output", "/geometry.qsm"))
qload(here("output", "/str_processed.qsm"))
seasonal_FREH <- qread("output/seasonal_FREH.qs")

# Set this to TRUE to output PDF figures
build_figures <- TRUE

```
```{r housing_objects, cache=TRUE, cache.lazy=FALSE}

home_sales <- qread(here("output", "home_sales.qs"), nthreads = availableCores())

DA_housing <- 
  cancensus::get_census(
    dataset = "CA16", regions = list(CSD = c("3513020")), level = "DA",
    vectors = c("v_CA16_4836", "v_CA16_4838", "v_CA16_4837", "v_CA16_4901", 
                "v_CA16_4899", "v_CA16_4894", "v_CA16_6698", "v_CA16_6692", 
                "v_CA16_6725", "v_CA16_6719", "v_CA16_4896", "v_CA16_4892",
                "v_CA16_4986", "v_CA16_4984"),
    geo_format = "sf") %>% 
  st_transform(32618) %>% 
  select(-c(`Shape Area`:Households, CSD_UID:`Area (sq km)`)) %>% 
  set_names(c("dwellings", "GeoUID", "parent_tenure", "renter", "owner", "average_rent",
              "p_thirty_renter", "average_ho_cost", "average_value_dwellings", "p_thirty_owner", 
              "mobility_one_year", "parent_mobility_one_year", "mobility_five_years", 
              "parent_mobility_five_years", "at_hh_inc", "parent_hh", "geometry")) %>% 
  mutate(p_mobility_one_year = mobility_one_year/parent_mobility_one_year,
         p_mobility_five_years = mobility_five_years/parent_mobility_five_years,
         p_thirty_renter = p_thirty_renter / 100,
         p_thirty_owner = p_thirty_owner / 100) %>% 
  select(GeoUID, dwellings, renter, owner, average_rent, average_ho_cost, average_value_dwellings,
         p_thirty_renter, p_thirty_owner, p_mobility_one_year, p_mobility_five_years, at_hh_inc, parent_hh) %>% 
  as_tibble() %>% 
  st_as_sf(agr = "constant")

# Apply spatial interpolation to get census data by ward

EW_housing <- 
  DA_housing %>% 
  mutate(area = st_area(geometry)) %>% 
  st_set_agr("constant") %>% 
  mutate(thirty_renter = p_thirty_renter * renter,
         thirty_owner = p_thirty_owner * owner,
         mobility_one_year = p_mobility_one_year * dwellings,
         mobility_five_years = p_mobility_five_years * dwellings) %>% 
  select(GeoUID, dwellings, owner, renter, average_rent, average_ho_cost, average_value_dwellings,
         thirty_renter, thirty_owner, mobility_one_year, mobility_five_years, at_hh_inc, parent_hh, area)

avg_list <- str_subset(names(EW_housing), "average|p_|inc") %>% 
  str_subset("total", negate = TRUE)

agg_list <-
  setdiff(names(EW_housing), c("GeoUID", "geometry", "area")) %>% 
  setdiff(avg_list)

round_list <- c("average_rent", "average_ho_cost", "average_value_dwellings", 
                "dwellings", "renter", "owner")

EW_housing <- 
  EW %>% 
  select(ward) %>% 
  st_transform(32618) %>% 
  st_set_agr("constant") %>% 
  st_intersection(., EW_housing) %>% 
  mutate(area_prop = st_area(geometry) / area) %>% 
  mutate(across(all_of(agg_list), ~{.x * units::drop_units(area_prop)})) %>% 
  select(-GeoUID, -area, -area_prop) %>% 
  st_drop_geometry() %>% 
  group_by(ward) %>% 
  summarize(
    average_rent = weighted.mean(average_rent, renter, na.rm = TRUE),
    average_ho_cost = weighted.mean(average_ho_cost, owner, na.rm = TRUE),
    average_value_dwellings = weighted.mean(average_value_dwellings, owner, na.rm = TRUE),
    at_hh_inc = weighted.mean(at_hh_inc, parent_hh, na.rm = TRUE),
    across(all_of(agg_list), sum, na.rm = TRUE)) %>% 
  mutate(p_thirty_renter = thirty_renter / renter,
         p_thirty_owner = thirty_owner / owner,
         p_mobility_one_year = mobility_one_year / dwellings,
         p_mobility_five_years = mobility_five_years / dwellings) %>% 
  select(-thirty_renter, -thirty_owner, -mobility_one_year, -mobility_five_years, -parent_hh) %>% 
  mutate(across(all_of(round_list), round, digit = 0)) %>% 
  left_join(., EW %>% select(ward), by = "ward") %>% 
  st_as_sf() %>% 
  st_transform(32618)

```
```{r on_water, cache = TRUE, cache.lazy = FALSE}

ocean <-
  read_sf(here("data", "shapefiles", "lhy_000h16a_e.shp")) %>%
  st_transform(32618)

ocean <-
  ocean %>%
  st_filter(select(city, -everything()))

river <-
  read_sf(here("data", "shapefiles", "lhy_000c16a_e.shp")) %>%
  st_transform(32618)

river <-
  river %>%
  st_filter(select(city, -everything()))

water <- rbind(select(river, -everything()), select(ocean, -everything()))

```

**TKTK**

<br>

## Housing issues in Prince Edward County

The common definition of affordable housing is that for which the costs do not exceed 30% of the household's disposable income. The Canadian Mortgage and Housing Corporation calls this metric the "shelter cost-income ratio" (2020). Additionally, a healthy rental market is considered one in which the vacancy rate is of 3% or above (ACTO 2021). By either of these metrics, Prince Edward County's housing market has been under severe stress in the last several years. Housing demand—driven by some combination of in-movers, STAs, and second-home sales—has far outstripped housing supply. The Covid-19 pandemic has exacerbated these demand-side issues by bringing in an influx of new buyers looking for a second home, in part due to the increased possibilities for remote work. As a result, housing prices and rents have both risen far faster than local incomes. This chapter provides an overview of housing conditions for both homeowners and renters in Prince Edward County, and then analyzes the role of STAs in the County's housing affordability challenges.


## Housing sales and prices

```{r sales_figures, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

peak_housing_sale <- 
  home_sales %>% 
   st_drop_geometry() %>% 
   mutate(year_month = format(sale_date, "%Y-%m")) %>% 
   mutate(year_month = paste0(year_month, "-01")) %>% 
   mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
   group_by(year_month) %>% 
   summarize(n=n(), mean_sale = mean(sale_price, na.rm=TRUE)) %>% 
   arrange(desc(n)) %>% 
   slice(1) %>% 
   pull(n)

dec_2020_sale_price <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year_month = format(sale_date, "%Y-%m")) %>% 
  mutate(year_month = paste0(year_month, "-01")) %>% 
  mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
  group_by(year_month) %>% 
  summarize(n=n(), mean_sale = mean(sale_price, na.rm=TRUE)) %>% 
  arrange(desc(mean_sale)) %>% 
  slice(1) %>% 
  pull(mean_sale) %>% 
  round(digit = -2) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

home_sales_variation <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year_month = format(sale_date, "%Y-%m")) %>% 
  mutate(year_month = paste0(year_month, "-01")) %>% 
  mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
  group_by(year_month) %>% 
  summarize("Number of sales" = n(), "Average sale price" = mean(sale_price, na.rm=TRUE)) %>% 
  mutate(across(where(is.numeric), 
                function(x) slide_dbl(x, ~{(.x[13] - .x[1]) / .x[1]}, 
                                      .before = 12, .complete = FALSE))) %>% 
  pivot_longer(-year_month, names_to = "var", values_to = "value") %>% 
  group_by(var) %>% 
  mutate(value = slide_dbl(value, mean, .before = 0, .complete = TRUE)) %>% 
  ungroup() %>% 
  filter(year_month >= "2017-01-01")

yoy_sale_2021 <- 
  home_sales_variation %>% 
  filter(var == "Average sale price") %>% 
  arrange(desc(value)) %>% 
  slice(2) %>% 
  pull(value) %>% 
  scales::percent(0.1)

n_sale_2016 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2016) %>% 
  pull(n)

avg_sale_2016 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2016) %>% 
  pull(avg) %>%
  scales::dollar(accuracy = 10)

n_sale_2019 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2019) %>% 
  pull(n)

avg_sale_2019 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2019) %>% 
  pull(avg) %>%
  scales::dollar(accuracy = 10)

n_sale_2020 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2020) %>% 
  pull(n)

avg_sale_2020 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2020) %>% 
  pull(avg) %>%
  scales::dollar(accuracy = 10)

avg_sale_2021 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2021) %>% 
  pull(avg) %>%
  scales::dollar(accuracy = 10)

scale_factor <-
  home_sales |> 
  st_drop_geometry() |> 
  filter(year(sale_date) == 2020) |> 
  summarize(scale = sum(month(sale_date) >= 7) / sum(month(sale_date) <= 6)) |> 
  pull(scale) |> 
  {\(x) x + 1}()

data_for_graph <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = mean(sale_price, na.rm = TRUE)) |> 
  mutate(n = if_else(sale_date == 2021, round(n * scale_factor), as.numeric(n)),
         shift = sale_date + n ^ 0.45 / 50)

n_sale_2021 <- 
  data_for_graph |> 
  filter(sale_date == 2021) |> 
  pull(n) |> 
  scales::comma()


```

Even prior to the last several years, housing prices were increasing rapidly in Prince Edward County. By one estimate, the median home price in the county almost doubled between 2008 to 2018, going from $205,000 to $395,000. That is an increase seven times greater than the increase in median household incomes in the same time period (The County Foundation 2018). In the last five years, however, two external market forces—namely STAs and secondary home purchases by households from urban areas—have added a new source of housing demand. In the face of relatively stable housing supply (as of the 2016 census, only 4.2% of housing units had been built in the previous five years), this new demand has contributed to record-setting housing price increases. To conduct an analysis of the homeownership market, our team was provided by the Prince Edward County Real Estate Board with a dataset of every residential real estate transaction in the County from January 2016 through September 2021, totaling `r scales::comma(nrow(home_sales))` sales.

``` {r make_fig_2_1}

figure_2_1_fun <- function(regular = "", condensed = "") {
  
sales_for_map <- 
  home_sales %>% 
  filter(sale_date >= "2021-01-01") %>% 
  st_drop_geometry() %>% 
  left_join(., EW, by = "ward") %>% 
  filter(!is.na(ward)) %>% 
  st_as_sf() %>% 
  group_by(ward) %>% 
  summarize(avg_sale_price_2021 = mean(sale_price, na.rm = TRUE))

sales_labels <-
  sales_for_map |> 
  st_centroid(of_largest_polygon = TRUE) |> 
  mutate(x = st_coordinates(geometry)[, 1],
         y = st_coordinates(geometry)[, 2],
         label = scales::dollar(avg_sale_price_2021, 100)) |> 
  st_drop_geometry()

sales_for_map |> 
ggplot() +
  geom_sf(data = province, colour = "transparent", fill = "grey93") +
  geom_sf(aes(fill = avg_sale_price_2021), colour = "white") +
  geom_sf(data = water, fill = "white", colour = "transparent") +
  ggrepel::geom_label_repel(aes(x, y, label = label), data = sales_labels,
                            size = 2, nudge_y = c(0, 0, -5000, 2000, 0, 0, 5000,
                                                  0, 0, 0)) +
  scale_fill_stepsn(colors = col_palette[c(3, 4, 6)], na.value = "grey80",)  +
  gg_bbox(EW) +
  theme_void() +
  theme(text = element_text(family = regular, face = "plain"),
        legend.position = "none",
        panel.border = element_rect(colour = "white", size = 2))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_1.pdf"), 
         plot = figure_2_1_fun(), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_1.pdf"))
}

```

Figure \@ref(fig:fig-2-1) shows the average selling price by electoral ward for each home sold in 2021. Prices are highest in the eastern and central parts of the County, but, with the exception of Athol, the average price in each ward is above $650,000. (That figure climbs above $1 million in South Marysburgh).

``` {r fig-2-1, include = TRUE, fig.cap = '(ref:fig-2-1)', fig.align = "center"}

figure_2_1_fun()

```
(ref:fig-2-1) _Average home sale prices by ward in 2021_

``` {r make_fig_2_2}

figure_2_2_fun <- function(regular = "", condensed = "") {
  
  data_for_graph <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = mean(sale_price, na.rm = TRUE)) |> 
  mutate(n = if_else(sale_date == 2021, round(n * scale_factor), as.numeric(n)),
         shift = sale_date + n ^ 0.45 / 50)
  
  ggplot(data_for_graph) +
  geom_smooth(aes(sale_date, avg), data = filter(data_for_graph, sale_date <= 2019),
              se = FALSE, colour = col_palette[2], method = "lm", 
              formula = y ~ log(x - 2015)) +
  geom_smooth(aes(sale_date, avg), data = filter(data_for_graph, sale_date >= 2019),
              se = FALSE, colour = col_palette[7], method = "lm") +
  geom_point(aes(sale_date, avg, size = n), colour = col_palette[5]) +
  geom_text(aes(shift, avg, label = n)) +
  scale_x_continuous(name = NULL, limits = c(2016, 2021.5), breaks = 2016:2021) +
  scale_y_continuous(name = NULL, limits = c(300000, 800000), 
                     labels = scales::dollar) +
  scale_size(limits = c(0, 1200), range = c(0, 20)) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank())

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_2.pdf"), 
         plot = figure_2_2_fun(), 
         width = 9, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_2.pdf"))
}

```

Figure \@ref(fig:fig-2-2) summarizes the volume and average prices of home sales since 2016. There are two important trends in this data. The first is that, although house prices were rising steadily through 2019, price growth was starting to level off. (This is visible in the declining slope of the light blue trend line.) By contrast, since the start of the pandemic, sale prices have been on a far steeper trajectory (the purple trend line)—nearly doubling in just two years. The average price was of `r avg_sale_2016` in 2016, but rose to `r avg_sale_2019` in 2019, `r avg_sale_2020` in 2020, and `r avg_sale_2021` in 2021 (so far). The peak average monthly sale price reached `r dec_2020_sale_price` in December 2020, which is a staggering `r yoy_sale_2021` higher than the the same month the year before. 

``` {r fig-2-2, include = TRUE, fig.cap = '(ref:fig-2-2)', fig.align = "center"}

figure_2_2_fun()

```
(ref:fig-2-2) _Housing sales prices and volume, 2016-2021_

``` {r make_fig_2_3}

figure_2_3_fun <- function(regular = "", condensed = "") {

home_sales_variation %>%
  mutate(label = if_else(year_month == "2018-01-01", var, NA_character_)) %>%
  ggplot(aes(year_month, value, colour = var)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  geom_line(lwd = 1, na.rm = TRUE) +
  geom_label(aes(label = label), size = 3, family = condensed) +
  scale_x_date(name = NULL) +
  scale_y_continuous(name = NULL, limits = c(-1, NA),
                     labels = scales::percent) +
  scale_color_manual(name = NULL, values = col_palette[c(1, 3)]) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank(),
        text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_3.pdf"),
         plot = figure_2_3_fun(),
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)

  extrafont::embed_fonts(here("output", "figures", "figure_2_3.pdf"))
}

```

The second trend is the increasing sales volume during the pandemic. In 2016, there were `r n_sale_2016` property sales in the County, but this number declined over the next several years to reach `r n_sale_2019` in 2019. Sales volume began to surge in the month following the pandemic, reaching a monthly peak of `r peak_housing_sale` sales in July 2020. In total, 2020 saw a increase to `r n_sale_2020` sales, while 2021 is on track for `r n_sale_2021` sales by year's end—nearly three times higher than 2019. Figure \@ref(fig:fig-2-3) summarizes the year-over-year changes in monthly number of sales and sale price. 

``` {r fig-2-3, include = TRUE, fig.cap = '(ref:fig-2-3)', fig.align = "center"}

figure_2_3_fun()

```
(ref:fig-2-3) _Year-over-year changes in monthly real estate sales and average sale prices_

```{r days_on_market, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

DOM <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year_month = format(sale_date, "%Y-%m")) %>% 
  mutate(year_month = paste0(year_month, "-01")) %>% 
  mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
  group_by(year_month) %>% 
  summarize(avg_DOM = mean(DOM, na.rm = TRUE))

DOM_2019 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  group_by(year) %>% 
  summarize(avg_DOM = round(mean(DOM, na.rm = TRUE), digit = 0)) %>% 
  filter(year == 2019) %>% 
  pull(avg_DOM)

DOM_2020 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  group_by(year) %>% 
  summarize(avg_DOM = round(mean(DOM, na.rm = TRUE), digit = 0)) %>% 
  filter(year == 2020) %>% 
  pull(avg_DOM)

DOM_2021 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  group_by(year) %>% 
  summarize(avg_DOM = round(mean(DOM, na.rm = TRUE), digit = 0)) %>% 
  filter(year == 2021) %>% 
  pull(avg_DOM)

diff_2019 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  mutate(diff_price = sale_price - list_price) %>% 
  group_by(year) %>% 
  summarize(diff_price = mean(diff_price, na.rm = TRUE)) %>% 
  filter(year == 2019) %>% 
  pull(diff_price) %>% 
  scales::dollar(100)

diff_2021 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  mutate(diff_price = sale_price - list_price) %>% 
  group_by(year) %>% 
  summarize(diff_price = mean(diff_price, na.rm = TRUE)) %>% 
  filter(year == 2021) %>% 
  pull(diff_price) %>% 
  scales::dollar(100)

```

``` {r make_fig_2_4}

figure_2_4_fun <- function(regular = "", condensed = "") {
  
home_sales %>% 
  st_drop_geometry() %>% 
  group_by(sale_date) %>% 
  summarize(avg_DOM = mean(DOM, na.rm=TRUE)) |> 
  mutate(avg_DOM = slide_dbl(avg_DOM, mean, .before = 6)) |> 
  ggplot(aes(sale_date, avg_DOM)) +
  geom_line(color = col_palette[2], alpha = 0.5) +
  stat_smooth(color = col_palette[2], method = "loess", se = FALSE, span = 0.8) +
  scale_y_continuous(name = NULL, label = scales::comma, limits = c(0, 150)) +
  scale_x_date(name = NULL, date_breaks = "1 year", minor_breaks = NULL,
               date_labels = c("2021", "2016", "2017", "2018", "2019", "2020"))+
  theme_minimal() +
  theme(legend.position = "bottom", panel.grid.minor.x = element_blank(), 
        text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_4.pdf"), 
         plot = figure_2_4_fun(), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_4.pdf"))
}

```

Several other indicators support the picture of a housing market in the midst of a demand shock, including the number of days on the market, the difference between asking price and sale price, and the number of resales. Figure \@ref(fig:fig-2-3) shows the number of days on market for home sales in Prince Edward County, and reveals a rapidly falling average during the pandemic. The average sale in 2019 had been on the market for `r DOM_2019` days, but that number fell to `r DOM_2020` in 2020, and to just `r DOM_2021` days in 2021. During the same time period, the difference between original asking price and final sale price shifted substantially, rising from `r diff_2019` in 2019 (indicating that the average property sold for less than its asking price) to `r diff_2021` in 2021—the first time this indicator has been positive since our dataset began in 2016.

``` {r fig-2-4, include = TRUE, fig.cap = '(ref:fig-2-4)', fig.align = "center"}

figure_2_4_fun()

```
(ref:fig-2-4) _Average number of days on market for successful home sales (7-day average)_

```{r multiple_sales, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

multiple_sales <-
  home_sales %>% 
  st_drop_geometry() %>% 
  arrange(sale_date) %>% 
  group_by(address, ward, unit_number) %>% 
  summarize(sale_dates = list(sale_date)) %>% 
  filter(lengths(sale_dates) > 1) %>%
  rowwise() %>% 
  mutate(difs = as.numeric(min(diff(sale_dates)))) |>
  ungroup() |> 
  filter(difs <= 730) |> 
  rowwise() |> 
  mutate(year = lubridate::year(max(sale_dates))) |> 
  ungroup() |> 
  count(year) |> 
  rename(resales = n) |> 
  left_join(home_sales %>% 
              st_drop_geometry() %>% 
              count(year = year(sale_date))) |> 
  mutate(resale_pct = resales / n) |> 
  filter(year >= 2018) |> 
  select(-n)

total_sales_2018_on <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  filter(sale_date >= "2018-01-01") %>%
  arrange(sale_date) %>% 
  count(address, ward, unit_number) %>% 
  nrow() %>%
  scales::comma()

```

Out of the `r total_sales_2018_on` sales which occurred in Prince Edward County from 2018 to 2021, a total of `r sum(multiple_sales$resales)` residential properties had already been sold at least once in the previous two years (Table \@ref(tab:tab-2-1)). Quick sales such as these may indicate "house flipping", and is a clear symptom of a housing market where speculative investments are playing a role. (In fact, one property in Prince Edward County has been sold four separate times between 2016 and 2021.) The table demonstrates that quick sales have risen rapidly since 2018, both in absolute numbers and as a proportion of all sales. In 2021 so far, `r scales::percent(max(multiple_sales$resale_pct), 0.1)` of all home sales are properties which had been sold in the previous two years.

``` {r tab-2-1, include = TRUE}

library(kableExtra)

multiple_sales |> 
  mutate(resale_pct = scales::percent(resale_pct, 0.1)) |> 
  set_names(c("Year of sale", "Multi-sale properties", 
              "Multi-sale properties as % of all properties sold")) |> 
  kbl(caption = "Properties sold multiple times between 2016 and 2021",
      align = "lrr") %>% 
  kable_styling(latex_options="scale_down") 

  
```


## Homeownership affordability

The housing sales trends described above tell only half the story of homeownership affordability in Prince Edward County. The other half is the ability of County residents to afford elevated housing prices. The most recent reliable data on Canadian incomes and housing affordability comes from the 2016 Census, which means that it will not have captured changes in income or—more importantly—the incredibly rapid increase in housing prices over the last five years.

```{r owner_calcs, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

sale_price_by_ward <- 
  home_sales %>% 
  filter(sale_date >= "2020-01-01") %>% 
  st_drop_geometry() %>% 
  left_join(EW, by = "ward") %>% 
  filter(!is.na(ward)) %>% 
  st_as_sf() %>% 
  group_by(ward) %>% 
  summarize(avg_sale_price_2021 = mean(sale_price, na.rm = TRUE))

sale_price_2020_2017 <- 
  home_sales %>% 
  filter(sale_date >= "2017-01-01", sale_date <= "2018-12-31") %>% 
  st_drop_geometry() %>% 
  left_join(EW, by = "ward") %>% 
  filter(!is.na(ward)) %>% 
  st_as_sf() %>% 
  group_by(ward) %>% 
  summarize(avg_sale_price_1718 = mean(sale_price, na.rm = TRUE)) %>%
  st_drop_geometry() %>% 
  left_join(sale_price_by_ward, by = "ward") %>% 
  st_as_sf()

# https://www.wallstreetmojo.com/mortgage-formula/

affordable_homeownership_2021 <- 
  sale_price_2020_2017 %>% 
  st_drop_geometry() %>% 
  mutate(down_pay = avg_sale_price_2021*0.2,
         P = avg_sale_price_2021 - down_pay,
         amort = 25,
         mortgage_rate = 0.0175) %>% 
  mutate(r = mortgage_rate / 12,
         n = amort * 12) %>% 
  mutate(monthly_payments = P * r * (((1 + r) ^ n) / (((1 + r) ^ n) - 1))) %>% 
  mutate(maintenance = 700,
         total_payments = (monthly_payments + maintenance) * 12,
         affordable_income_2021 = total_payments / 0.3) %>% 
  left_join(st_drop_geometry(EW_housing) %>% 
              select(ward, at_hh_inc), by = "ward") %>% 
  mutate(diff_affordable_real_2021 = at_hh_inc - affordable_income_2021) %>% 
  select(ward, avg_sale_price_2021, at_hh_inc, diff_affordable_real_2021)

affordable_homeownership_1718 <- 
  sale_price_2020_2017 %>% 
  st_drop_geometry() %>% 
  mutate(down_pay = avg_sale_price_1718*0.2,
         P = avg_sale_price_1718 - down_pay,
         amort = 25,
         mortgage_rate = 0.0175) %>% 
  mutate(r = mortgage_rate / 12,
         n = amort * 12) %>% 
  mutate(monthly_payments = P * r * (((1 + r) ^ n) / (((1 + r) ^ n) - 1))) %>% 
  mutate(maintenance = 700,
         total_payments = (monthly_payments + maintenance) * 12,
         affordable_income_1718 = total_payments / 0.3) %>% 
  left_join(st_drop_geometry(EW_housing) %>% 
              select(ward, at_hh_inc), by = "ward") %>% 
  mutate(diff_affordable_real_1718 = at_hh_inc - affordable_income_1718) %>% 
  select(ward, avg_sale_price_1718, at_hh_inc, diff_affordable_real_1718)

diff_picton_1718 <- 
  affordable_homeownership_1718 %>% 
  filter(ward == "Picton") %>% 
  pull(diff_affordable_real_1718) %>% 
  {. * -1} %>% 
  scales::dollar(10) 

```

``` {r make_fig_2_5}

affordability_map_data <- 
  affordable_homeownership_1718 %>% 
  left_join(affordable_homeownership_2021 %>% 
              select(-at_hh_inc), by = "ward") %>% 
  select(ward, avg_sale_price_1718, avg_sale_price_2021,
         at_hh_inc, diff_affordable_real_1718, diff_affordable_real_2021) |> 
  pivot_longer(c(diff_affordable_real_1718, diff_affordable_real_2021),
               names_to = "years") |> 
  mutate(years = if_else(str_detect(years, "1718"), "2017-2018", "2020-2021"))

figure_2_5_fun <- function(regular = "", condensed = "") {
  
EW |> 
  left_join(affordability_map_data) |> 
  ggplot() +
  geom_sf(data = province, colour = "transparent", fill = "grey93") +
  geom_sf(aes(fill = value), colour = "white", size = 0.3) +
  geom_sf(data = water, fill = "white", colour = "transparent") +
  facet_wrap(vars(years)) +
  scale_fill_steps2(low = col_palette[6], high = col_palette[3], 
                    limits = c(-90000, 90000), breaks = 30000 * -3:3,
                    labels = scales::dollar)  +
  guides(fill = guide_colourbar(title = "Average\naffordability gap",
                                title.vjust = 1)) + 
  gg_bbox(EW) +
  theme_void() +
  theme(text = element_text(family = regular, face = "plain"),
        legend.title = element_text(family = regular, face = "bold",
                                    size = 7),
        legend.title.align = 0.9,
        legend.text = element_text(family = regular, size = 4),
        panel.border = element_rect(colour = "white", size = 2),
        strip.text = element_text(face = "bold"),
        legend.position = "bottom", legend.key.width = unit(1.8, "lines"))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_5.pdf"), 
         plot = figure_2_5_fun(), 
         width = 8, height = 3.5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_5.pdf"))
}

```

Instead, we can look at average sale prices and establish at what income levels these sale prices would be affordable, then compare those levels with actual 2016 incomes in Prince Edward County. We make the highly conservative assumption that home buyers receive 25-year mortgages at a 1.75% rate and with a 20% down payment. We then calculate monthly mortgage payments and homeownership maintenance costs (property taxes, utilities) for homes sales from 2017-2018 and 2020-2021, and establish what income level would be necessary to keep those costs under 30% of income. We compare these income levels to 2016 after-tax household income, grouped by electoral ward. The differences between the affordable thresholds and the actual household incomes are displayed in Figure \@ref(fig:fig-2-5) and Table \@ref(tab:tab-2-2). For both time periods, the average after-tax household income in each ward is not sufficient to afford homeownership (with North Marysburgh in 2017-2018 being the only exception). In the 2020-2021 period the situation is much worse; there are five wards for which households, on average, would require more than $50,000 in additional after-tax income to make homeownership affordable given current market conditions. The highest difference in 2017-2018, meanwhile, was `r diff_picton_1718` in Picton.

``` {r fig-2-5, include = TRUE, fig.cap = '(ref:fig-2-5)', fig.align = "center"}

figure_2_5_fun()

```
(ref:fig-2-5) _Average gap between actual after-tax income and income necessary to afford the average house_

``` {r tab-2-2, include = TRUE}

library(kableExtra)

affordable_homeownership_1718 %>% 
  left_join(., affordable_homeownership_2021 %>% select(-at_hh_inc), by = "ward") %>% 
  select(ward, avg_sale_price_1718, avg_sale_price_2021,
         at_hh_inc, diff_affordable_real_1718, diff_affordable_real_2021) %>% 
  mutate(avg_sale_price_1718 = scales::dollar(avg_sale_price_1718, 10),
         avg_sale_price_2021 = scales::dollar(avg_sale_price_2021, 10),
         at_hh_inc = scales::dollar(at_hh_inc, 10),
         diff_affordable_real_1718 = scales::dollar(diff_affordable_real_1718, 10),
         diff_affordable_real_2021 = scales::dollar(diff_affordable_real_2021, 10)) %>% 
  arrange(desc(diff_affordable_real_2021)) %>% 
  select(ward, at_hh_inc, diff_affordable_real_1718, diff_affordable_real_2021) %>%
  set_names(c("Ward", "After-tax household income (2016)", 
              "Annual affordability gap (2017-2018)", 
              "Annual affordability gap (2020-2021)")) %>% 
  kbl(caption = "Annual affordability gap for homeowners (2017-2018 and 2020-2021)",
      align = "lrrrrr") %>% 
  kable_styling(latex_options="scale_down") 
  
```


## Renter affordability

```{r renter_afford, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

rent_sept <- qread("output/rent_sept.qs", nthreads = availableCores())
  
p_thirty_renter_well <- 
  EW_housing %>% 
  st_drop_geometry %>% 
  arrange(desc(p_thirty_renter)) %>% 
  slice(1) %>% 
  pull(p_thirty_renter) %>%   
  scales::percent(accuracy = 0.1)

p_thirty_renter_picton <- 
  EW_housing %>% 
  st_drop_geometry %>% 
  arrange(desc(p_thirty_renter)) %>% 
  slice(2) %>% 
  pull(p_thirty_renter) %>%   
  scales::percent(accuracy = 0.1)

p_thirty_renter_hallo <- 
  EW_housing %>% 
  st_drop_geometry %>% 
  arrange(desc(p_thirty_renter)) %>% 
  slice(3) %>% 
  pull(p_thirty_renter) %>%   
  scales::percent(accuracy = 0.1)

avg_rent_bach <- 
  rent_sept %>% 
  group_by(bedrooms) %>% 
  summarize(avg_rent = mean(rent)) %>% 
  filter(bedrooms == 0) %>% 
  pull(avg_rent) %>% 
  scales::dollar(accuracy = 1)

avg_rent_one <- 
  rent_sept %>% 
  group_by(bedrooms) %>% 
  summarize(avg_rent = mean(rent)) %>% 
  filter(bedrooms == 1) %>% 
  pull(avg_rent) %>% 
  scales::dollar(accuracy = 1)

avg_rent_two <- 
  rent_sept %>% 
  group_by(bedrooms) %>% 
  summarize(avg_rent = mean(rent)) %>% 
  filter(bedrooms == 2) %>% 
  pull(avg_rent) %>% 
  scales::dollar(accuracy = 1)

avg_rent_three <- 
  rent_sept %>% 
  group_by(bedrooms) %>% 
  summarize(avg_rent = mean(rent)) %>% 
  filter(bedrooms == 3) %>% 
  pull(avg_rent) %>% 
  scales::dollar(accuracy = 1)

avg_rent_pec_sept_2021 <- 
  mean(rent_sept$rent) %>% 
  scales::dollar(accuracy = 1) 

census_avg_rent <- 
  paste("$936")

towns <- c("Picton", "Wellington", "Bloomfield")

EW_rent <- 
  EW_housing %>% 
  st_drop_geometry() %>% 
  mutate(ward = ifelse(!ward %in% towns, "Township", ward)) %>% 
  group_by(ward) %>% 
  summarise(avg_census_rent = weighted.mean(average_rent, renter),
            avg_hh_inc = weighted.mean(at_hh_inc, dwellings))

rent_diff_table <- 
  rent_sept %>% 
  group_by(ward) %>% 
  summarize(sept_avg_rent = mean(rent)) %>% 
  left_join(EW_rent, by = "ward") %>% 
  mutate(affordable_rent = (avg_hh_inc / 12) * 0.30,
         rent_diff = affordable_rent - sept_avg_rent) %>% 
  mutate(ward = if_else(ward == "Township", "Townships", ward)) %>% 
  select(ward, sept_avg_rent, avg_hh_inc, affordable_rent, rent_diff) %>% 
  arrange(rent_diff)

rent_diff_picton <- 
  rent_diff_table %>% 
  filter(ward == "Picton") %>% 
  pull(rent_diff) %>% 
  {. * -1} %>% 
  scales::dollar(accuracy = 1)

rent_diff_well <- 
  rent_diff_table %>% 
  filter(ward == "Wellington") %>% 
  pull(rent_diff) %>% 
  {. * -1} %>% 
  scales::dollar(accuracy = 1)
  
```

The housing affordability challenges facing renters in Prince Edward County are different from those of homeowners. First of all, renters make up only 16.9% of all households in the County. However, in 2016 (prior to the enormous surge in housing costs), almost half (48.9%) of renters were in a situation of housing stress—nearly three times the equivalent 17.3% rate for homeowners. The ward with the most renter housing stress was Wellington, with `r p_thirty_renter_well` of renters spending more than 30% of their household income on rent, followed by Picton with `r p_thirty_renter_picton` and Hallowell with `r p_thirty_renter_hallo`. As of October 2017, the County calculated its rental vacancy rate to be 0.81%—far below the 3% considered a minimum for a healthy rental market (Prince Edward County 2019).

As documented above, the County has experienced a housing demand spike during the pandemic, and this has affected rents as well as housing prices. According to figures collected by the Prince Edward County Affordable Housing Corporation, average rents increased by 52% from June 2020 to June 2021. In September 2021 the average rent for a bachelor unit was `r avg_rent_bach` while the average rent for a one-bedroom was `r avg_rent_one`. The average rents for two-bedroom and three-bedroom units were `r avg_rent_two` and `r avg_rent_three`, respectively. The overall average County rent of `r avg_rent_pec_sept_2021` in September 2021 is nearly double the average rent of `r census_avg_rent` reported in the 2016 Census.

The standard affordability threshold for renters is the same 30% shelter cost-income ratio. Using September 2021 average rents from Picton, Wellington, Bloomfield and the townships in comparison with after-tax household income from the 2016 Census, it is possible to estimate affordability thresholds for renters across the County. Table \@ref(tab:tab-2-3) summarizes these findings. The difference between affordable rents and actual average market rents is a highly conservative underestimate, because the after-tax household income figures used for this calculation include incomes from both owner and renter households. Renter households earn significantly less on average than owner households, meaning that the household income used for this calculation is drawn approximately 5/6 from (higher earning) homeowners and only 1/6 from (lower earning) renters. Even given this fact, in Picton the average after-tax household income (among all homeowners and renters) is not sufficient to affordably pay for the average rental apartment: renters spend on average `r rent_diff_picton` more on rent each month than the affordable rent threshold. This figure in Wellington is `r rent_diff_well`. 

``` {r tab-2-3, include = TRUE}

library(kableExtra)

rent_diff_table %>% 
    mutate(sept_avg_rent = scales::dollar(sept_avg_rent, 1),
         avg_hh_inc = scales::dollar(avg_hh_inc, 10),
         affordable_rent = scales::dollar(affordable_rent, 1),
         rent_diff = scales::dollar(rent_diff, 1)) %>% 
  select(ward, sept_avg_rent, rent_diff) %>%
  set_names(c("Ward", "Average rent (Sept. 2021)", "Monthly affordability gap")) %>% 
  kbl(caption = "Monthly affordability gap for renters (Sept. 2021)",
      align = "lrrrrr") %>% 
  kable_styling(latex_options="scale_down") 
  
```


## The impact of STAs on housing affordability

Having established the broad contours of the housing affordability challenges facing Prince Edward County over the last several years, we now address the specific role of STAs in creating those challenges. After all, one possible explanation for at least some of both the insufficient supply and elevated demand for housing in PEC is the growth in short-term rentals. Tourists compete with residents for housing—adding demand to the local housing market—while landlords shift their properties out of the conventional housing market to become dedicated STAs—reducing the supply of conventional housing. Research has found that renting a housing unit on the STR market frequently offers landlords greater potential revenue than conventional leases (Wachsmuth & Weisler 2018). Multiple studies have also found that Airbnb and other STA platforms increase housing costs (Barron, Kung, & Proserpio 2017; Horn & Merante 2017; Garcia-Lopez et al. 2019).


## Full-time STAs

One of the major considerations when gauging the impacts of short-term rentals (STAs) on a specific location is the extent to which STAs are removing long-term housing from the market. This process can occur either directly, for example where tenants of a rental unit are evicted or not replaced at the end of a lease and the unit is converted to a STR, or indirectly by absorbing new construction or investment properties which otherwise would have gone onto the long-term market. In a highly seasonal market such as Prince Edward County, moreover, it is likely that there will be many housing units which are operated as dedicated STAs during the summer high season but then occupied by tenants or by their owners during the low season. To obtain the exact number of units that have been converted to full-time STAs (either year-round or during the summer), it would be necessary to survey individual property owners en masse, which is unfeasible because online STA hosts are mostly anonymous. Instead, we use the daily activity of STA listings, alongside structural characteristics such as listing type and location, to estimate which listings are operating as dedicated STAs and are therefore not available as conventional long-term housing.

``` {r make_fig_2_6}

full_time_listings <- qread(file = "output/full_time_listings.qs")

figure_2_6_fun <- function(regular = "", condensed = "") {
  
full_time_listings |> 
  mutate(code = case_when(
    year_season == "Winter 2017" ~ 1,
    year_season == "Summer 2018" ~ 2,
    year_season == "Winter 2018" ~ 3,
    year_season == "Summer 2019" ~ 4,
    year_season == "Winter 2019" ~ 5,
    year_season == "Summer 2020" ~ 6,
    year_season == "Winter 2020" ~ 7,
    year_season == "Summer 2021" ~ 8)) |> 
  group_by(property_ID) |> 
  mutate(full_time = (code + 1) %in% code | (code - 1) %in% code) |> 
  ungroup() |> 
  count(year_season, full_time) |> 
  mutate(season = case_when(
    full_time ~ "Year-round",
    TRUE ~ str_remove(year_season, ' \\d{4}')
  )) |> 
  mutate(year_season = factor(year_season, levels = c(
    "Winter 2017", "Summer 2018", "Winter 2018", "Summer 2019", "Winter 2019",
    "Summer 2020", "Winter 2020", "Summer 2021"))) |> 
  ggplot() +
    geom_bar(aes(year_season, n, fill = season), stat= "identity")+
    theme(plot.title = element_text(size=10),
          legend.title = element_blank())+
  scale_fill_manual("legend", 
                    values = c("Year-round" = col_palette[3],
                               "Summer" = col_palette[1],
                               "Winter" = col_palette[2]))+
  scale_y_continuous(name = NULL, label = scales::comma) +
  theme_minimal()+
  xlab("")+
  ylab("")+
  theme(legend.title = element_blank(),
        legend.position = "bottom", 
        panel.grid.minor.x = element_blank(),
        text = element_text(face = "plain", family = regular),
        legend.text = element_text( size = 10, family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_6.pdf"), 
         plot = figure_2_6_fun(), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_6.pdf"))
}

```

```{r FREH_seasonal}

# FREH summer 2019
summer_FREH_2019 <- 
  full_time_listings |> 
  filter(year_season == "Summer 2019") |> 
  nrow() |> 
  round(-1)

# FREH summer 2021
summer_FREH_2021 <- 
  full_time_listings |> 
  filter(year_season == "Summer 2021") |> 
  nrow() |> 
  round(-1)

# Pct summer 2019
summer_FREH_pct_2019 <- 
{summer_FREH_2019 / sum(EW$dwellings)} %>% 
  scales::percent(0.1)

# Pct summer 2021
summer_FREH_pct_2021 <- 
{summer_FREH_2021 / sum(EW$dwellings)} %>% 
  scales::percent(0.1)

# Pct summer 2019 Bloomfield
summer_FREH_pct_bloomfield_2019 <- 
  full_time_listings %>%
  filter(year_season == "Summer 2019",
         property_ID %in% property[property$ward == "Bloomfield",]$property_ID) %>%
  nrow() %>%
  {. / EW[EW$ward == "Bloomfield",]$dwellings} %>%
  scales::percent(0.1)
  
# Pct summer 2021 Bloomfield
summer_FREH_pct_bloomfield_2021 <- 
  full_time_listings %>%
  filter(year_season == "Summer 2021",
         property_ID %in% property[property$ward == "Bloomfield",]$property_ID) %>%
  nrow() %>%
  {. / EW[EW$ward == "Bloomfield",]$dwellings} %>%
  scales::percent(0.1)

```

We estimate full-time STA status by observing the activity of each entire-home STA during the high season (May to September) and the low season (October to April), and identifying all the listings which were available for reservations at least 75% of the total time period. This forms the pool of listings which are highly available for a given season, and therefore likely to be dedicated STAs. We then further refine this calculation by discarding any listing that was not actually reserved at least 25% of the total time period in the high season, or at least seven nights in the low season. Figure \@ref(fig:fig-2-6) shows the number of these properties active each season since Winter 2017, further distinguishing between properties which are full-time year-round (shown in green), full-time only in the summer (shown in orange), and full-time only in the winter (shown in blue). The figure reveals significant seasonal variation, with the pre-Covid high seasons seeing nearly twice the number of dedicated STAs in operation as the low seasons. The peak number of full-time STAs was `r summer_FREH_2019` in Summer 2019. The figure also shows a major impact from the Covid-19 pandemic; Summer 2020 saw roughly the same number of full-time STA operations as Winter 2018, although Summer 2021 indicates that the full-time STA market is expanding again, with `r summer_FREH_2021` dedicated STAs in operation.

``` {r fig-2-6, include = TRUE, fig.cap = '(ref:fig-2-6)', fig.align = "center"}

figure_2_6_fun()

```
(ref:fig-2-6) _Housing units operating on a full-time basis on the STA market of the Prince Edward County, per season_

``` {r make_fig_2_7}

figure_2_7_fun <- function(regular = "", condensed = "") {
  
property |> 
  st_drop_geometry() |> 
  select(property_ID, ward) |> 
  right_join(full_time_listings) |> 
  count(ward, year_season) |> 
  filter(year_season %in% c("Summer 2019", "Summer 2021")) |> 
  left_join(EW) |> 
  st_as_sf() |> 
  ggplot() +
  geom_sf(data = province, colour = "transparent", fill = "grey93") +
  geom_sf(aes(fill = n / dwellings), colour = "white", size = 0.3) +
  geom_sf(data = water, fill = "white", colour = "transparent") +
  facet_wrap(vars(year_season)) +
  scale_fill_stepsn(colors = col_palette[c(3, 4, 6)], na.value = "grey80",
                    breaks = c(0, 0.02, 0.04, 0.06, 0.08, 0.1),
                    limits = c(0, 0.1), oob = scales::squish, 
                    labels = scales::percent)  +
  guides(fill = guide_colourbar(title = "Full-time STAs\nas % of all housing",
                                title.vjust = 1)) + 
  gg_bbox(EW) +
  theme_void() +
  theme(text = element_text(family = regular, face = "plain"),
        legend.title = element_text(family = regular, face = "bold",
                                    size = 7),
        legend.title.align = 0.9,
        legend.text = element_text(family = regular, size = 4),
        panel.border = element_rect(colour = "white", size = 2),
        strip.text = element_text(face = "bold"),
        legend.position = "bottom", legend.key.width = unit(1.8, "lines"))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_7.pdf"), 
         plot = figure_2_7_fun(), 
         width = 8, height = 3.5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_7.pdf"))
}

```

Figure \@ref(fig:fig-2-7) and Table \@ref(tab:tab-2-4) summarize STA-induced housing loss by ward. They demonstrate both a wide amount of geographical variation in the intensity of full-time STAs and a generalized decline in full-time STAs across all areas during the pandemic. Across the entire County, the amount of housing operating as dedicated STAs declined from `r summer_FREH_pct_2019` in Summer 2019 to `r summer_FREH_pct_2021` in Summer 2021. This is a large decline, but even the smaller `r summer_FREH_pct_2021` figure is higher than any other municipality in Ontario with the exception of the Blue Mountains. Bloomfield had by far the highest percentage of housing units operating as dedicated STAs in both Summer 2019 (`r summer_FREH_pct_bloomfield_2019`) and Summer 2021 (`r summer_FREH_pct_bloomfield_2021`), albeit with low absolute unit counts since the village's population is so small.

``` {r fig-2-7, include = TRUE, fig.cap = '(ref:fig-2-7)', fig.align = "center"}

figure_2_7_fun()

```
(ref:fig-2-7) _The percentage of housing units operating as dedicated STAs, by ward_

``` {r tab-2-4, include = TRUE}

library(kableExtra)

ward_table <- 
  property |> 
  st_drop_geometry() |> 
  select(property_ID, ward) |> 
  right_join(full_time_listings) |> 
  count(ward, year_season) |> 
  filter(year_season %in% c("Summer 2019", "Summer 2021")) |> 
  left_join(EW) |> 
  filter(year_season %in% c("Summer 2019", "Summer 2021")) |> 
  select(ward, year_season, n, dwellings) |> 
  pivot_wider(names_from = year_season, values_from = c(n)) |> 
  rename(n_2019 = `Summer 2019`, n_2021 = `Summer 2021`)

ward_table |> 
  summarize(
    ward = "Prince Edward County",
    across(c(dwellings:n_2021), sum, na.rm = TRUE)) |> 
  bind_rows(ward_table) |> 
  filter(!is.na(ward)) |> 
  mutate(
    pct_2019 = scales::percent(n_2019 / dwellings, 0.1),
    pct_2021 = scales::percent(n_2021 / dwellings, 0.1),
    n_2019 = round(n_2019, -1),
    n_2021 = round(n_2021, -1)) |> 
  select(ward, n_2019, pct_2019, n_2021, pct_2021) |> 
  set_names(c("Ward", "Full-time STAs (Summer 2019)", 
              "As % of housing (Summer 2019)",
              "Full-time STAs (Summer 2021)", 
              "As % of housing (Summer 2021)")) |> 
  kbl(caption = "Full-time STAs by ward",
      align = "lrrrrr") |>
  kable_styling(latex_options = "scale_down") |> 
  row_spec(1, background = paste0(col_palette[2], "50"))

```

```{r monthly_FT}

monthly_str <- function(start_date, end_date, cut = 25) {
  daily %>% 
    filter(date >= start_date, date <= end_date, status != "B") %>% 
    group_by(month = lubridate::month(date, label = TRUE, abbr = FALSE)) %>% 
    count(property_ID) %>% 
    filter(n >= cut) %>%
    count(month) %>% 
    mutate(month = str_to_sentence(month))
}

monthly_2019 <- 
  monthly_str("2019-01-01", "2019-12-31") %>% 
  rename(n_2019 = n)

monthly_2021 <- 
  monthly_str("2021-01-01", "2021-12-31") %>% 
  rename(n_2021 = n)

variation_df <- 
  left_join(monthly_2019, monthly_2021) %>% 
  mutate(variation = (n_2021 - n_2019) / n_2019)

jan_month_dif <- 
  variation_df |> 
  filter(month == "January") |> 
  pull(variation) |> 
  abs() |> 
  scales::percent(0.1)

sep_month_dif <- 
  variation_df |> 
  filter(month == "September") |> 
  pull(variation) |> 
  abs() |> 
  scales::percent(0.1)

```

A final perspective on the change in full-time STAs during the pandemic can be seen by examining STA activity on a monthly—rather than seasonal basis. Table \@ref(tab:tab-2-5) shows the properties that were active at least 25 days out of the month in each month in 2019 and 2021. Activity in 2019 displays a strong seasonality pattern, with monthly full-time listings bottoming out in February, then peaking in July before beginning to decline again. (Cell colouring indicates which months received greater or smaller shares of total annual activity.) In 2021, by contrast, full-time listings have been steadily rising through the end of September (the final month for which we have data). While there were `r jan_month_dif` fewer full-time listings in January 2021 compared to January 2019, that gap had shrunk to only `r sep_month_dif` by September 2021. This suggests that the dedicated STA market in Prince Edward County is close to recovering from the negative shock of the pandemic.

``` {r tab-2-5, include = TRUE}

library(kableExtra)

variation_df %>% 
  mutate(variation = scales::percent(variation, 0.1)) %>% 
  rename(Month = month,
         "Full-time STAs (2019)" = n_2019,
         "Full-time STAs (2021)" = n_2021,
         "Variation (%)" = variation) %>% 
  kbl(caption = "Full-time STAs per month", align = "lrrrrr") %>% 
  kable_styling(latex_options="scale_down") %>%
  column_spec(2, background = spec_color(variation_df$n_2019[1:12], 
                                         alpha = 0.4, end = 0.7)) %>% 
  column_spec(3, background = spec_color(variation_df$n_2021[1:12], 
                                         alpha = 0.4, end = 0.7))

```


## Are STAs responsible for rising home prices and sales volumes?

So far we have established two broad facts about Prince Edward County's housing market and STAs: First, while housing prices were rising prior to the pandemic, price (and rent) increases and sales volumes have accelerated dramatically since 2020. Second, during this same time period the number of active STAs has declined, albeit from a very high baseline. The combination of these two facts suggests that the rapid deterioration in housing affordability since the beginning of the pandemic is probably not a consequence primarily of STA activity. There is an additional way to approach this question, which is to look for home sales which directly resulted in new STAs. Because STA hosts were obligated to register their properties with the County from November 2019 through September 2020 (discussed more in the next chapter), it is possible to match the addresses of home sales with the addresses of registered STAs to obtain a different estimate of the relationship between STAs and housing market dynamics.

```{r, include = TRUE}

start_reg <- as.Date("2019-11-04")
end_reg <- as.Date("2020-09-04")
start_mora <- as.Date("2020-09-05")
end_mora <- as.Date("2021-06-22")

STA <- qread(here("output", "/STA.qs"))

total_licenses_all <- 
  STA %>% 
  st_drop_geometry() %>% 
  nrow()

# Get properties active during the period when the registration was into effect
reg_property <- 
  property %>% 
  filter(scraped >= start_reg) %>% 
  st_transform(32618)

sold_before_created <- 
home_sales %>% 
  st_drop_geometry() %>% 
  left_join(STA, by = "address") %>% 
  filter(!is.na(id)) %>%
  filter(sale_date <= created) %>% 
  count(address) %>% 
  nrow()

per_sold_before_created <- 
{sold_before_created / nrow(STA)} %>% 
  scales::percent(0.1)

sold_before_created_covid <- 
home_sales %>% 
  st_drop_geometry() %>% 
  left_join(STA, by = "address") %>% 
  filter(!is.na(id)) %>%
  filter(sale_date <= created,
         sale_date >= "2020-03-14") %>% 
  count(address) %>% 
  nrow()

per_sold_before_created_covid <- 
{sold_before_created_covid / nrow(STA)} %>% 
  scales::percent(0.1)

created_before_sale <- 
home_sales %>% 
  st_drop_geometry() %>% 
  left_join(STA, by = "address") %>% 
  filter(!is.na(id)) %>%
  filter(sale_date >= created) %>% 
  count(address) %>% 
  nrow()

total_sales <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  count(year) %>% 
  set_names(c("year", "total"))

survival_factor <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(scraped > created, str_starts(property_ID, "ab-")) %>% 
  group_by(year_created = year(created)) %>% 
  summarize(still_active = mean(scraped >= "2019-11-01")) %>% 
  filter(year_created >= 2016)

proportion_home_sales_STA <-
  home_sales %>% 
  st_drop_geometry() %>% 
  inner_join(STA, by = "address") %>% 
  filter(sale_date <= created) %>% 
  mutate(year = year(sale_date)) %>% 
  count(year) %>% 
  left_join(total_sales, by = "year") %>% 
  mutate(perc = n/total,
         perc_adjusted = perc / 
           (total_licenses_all / reg_property %>% nrow())) %>% 
  left_join(survival_factor, by = c("year" = "year_created")) %>% 
  mutate(perc_adj_2 = perc_adjusted / still_active)

```

```{r make_fig_2_8}

figure_2_8_fun <- function(regular = "", condensed = "") {

proportion_home_sales_STA %>% 
  mutate(perc_adjusted = perc_adjusted - perc,
         perc_adj_2 = perc_adj_2 - perc_adjusted - perc) %>% 
  select(year, perc, perc_adjusted, perc_adj_2) %>% 
  pivot_longer(c(perc:perc_adj_2)) %>% 
  mutate(name = case_when(
    name == "perc" ~ "Direct matches",
    name == "perc_adjusted" ~ "Inferred from registration rate",
    name == "perc_adj_2" ~ "Inferred from listing attrition")) %>% 
  mutate(name = factor(name, levels = c("Direct matches", 
                                        "Inferred from registration rate",
                                        "Inferred from listing attrition"))) %>% 
  ggplot() +
  geom_col(aes(x = year, y = value, fill = name), 
           position = position_stack(reverse = TRUE)) +
  scale_x_continuous(name = NULL, breaks = 2016:2021) +
  scale_y_continuous(name = NULL, breaks = c(0.1, 0.2, 0.3, 0.4, 0.5), 
                     label = scales::percent) +
  scale_fill_manual(name = NULL, values = col_palette[c(6, 1, 4)]) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank(), legend.position = "bottom")
  
}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_8.pdf"), 
         plot = figure_2_8_fun("Futura", "Futura Condensed"), 
         width = 9, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_8.pdf"))
}

```

In total, out of the `r scales::comma(nrow(STA))` properties registered as STAs in Prince Edward County, `r scales::comma(sold_before_created)` (`r per_sold_before_created`) were sold prior to being registered at least once since 2016. Put differently, these `r scales::comma(sold_before_created)` sales are `r scales::percent(sold_before_created / nrow(home_sales), 0.1)` of the total `r scales::comma(nrow(home_sales))` home sales which occurred in Prince Edward County between 2016 and September 2021. However, this latter percentage substantially underestimates the actual number of home sales which became STAs for two reasons. First, despite the legal requirement to register, not all active STA hosts actually registered their properties with the County. Any STA that did not register will not be able to be matched to a home sale. Second, STA registration did not begin until November 2019, but many of the STAs which were active in earlier years were no longer active by that date. So, for example, a property which was sold in February 2016, converted into an STA in April 2016, operated for three years, and then deactivated in September 2019 would not match to an STA registration.

Figure \@ref(fig:fig-2-8) shows the estimated proportion of home sales each year since 2016 which became STAs, adjusting for both of these sources of systemic underestimation. The dark orange portions of each bar shows direct matches between home sales and new STA listings: in each case, the exact address of the sale was registered as an STA subsequent to the sale. The lighter orange portions of each bar show the additional matches which we did not detect but which we can infer existed based on the fact that only `r scales::percent(total_licenses_all / reg_property %>% nrow(), 0.1)` of STA listings which were active during the time when the registration system was in effect actually registered. Finally, the yellow portion of each bar shows the additional matches which we can infer from the natural attrition of STA listings over time: many 2016 listings had been taken down by the time registration began in November 2019, but only a few 2019 listings had been taken down.

``` {r fig-2-8, include = TRUE, fig.cap = '(ref:fig-2-8)', fig.align = "center"}

figure_2_8_fun()

```
(ref:fig-2-8) _The share of annual home sales attributable to new STAs (2016-2021)_

The figure suggests that approximately half of _all_ home sales in Prince Edward County in 2016 and 2017 can be attributed to new STA activity. At the same time, that proportion has systematically fallen each year since 2017, reaching `r scales::percent(proportion_home_sales_STA[proportion_home_sales_STA$year == 2020,]$perc_adj_2, 0.1)` in 2020. Some of this decline can be attributable to the shortened time frame in which a new home sale can be converted to an STA as the data approaches the present—i.e., there are certainly some home sales from 2020 and 2021 which will become STAs in the future but have not done so yet. But the trend is clear: STAs have transitioned from arguably the main driver of housing sales in 2016 and 2017 to a still significant but minority driver of sales during the pandemic.


## Conclusion

The key findings of this chapter are as follows:

- Housing prices and sales volumes have dramatically accelerated since the start of the pandemic, with correspondingly negative impacts on homeownership affordability. While prices were rising before 2020 as well, the evidence suggests that price growth was beginning to level off until the pandemic introduced a massive demand shock into the housing market.
- Residential rents have also seen enormous increases, driven by the same market fundamentals, i.e. huge demand increases without corresponding supply increases.
- Prior to the pandemic, fully `r summer_FREH_pct_2019` of housing in Prince Edward County was operating as a dedicated STA in the summer. This is certainly a large enough share to have made a major contribution to the housing unaffordability problems in the County which were present before the pandemic.
- The amount of full-time STAs declined substantially during the pandemic, and only as of the end of Summer 2021 does it appear that STA supply is recovering to pre-pandemic levels.
- Approximately half of all home sales in 2016 and 2017 can be attributed to new STAs, but that shared has dropped by half in the last several years.

Taken together, these findings suggest that STA activity in Prince Edward County has been an important driver of the medium-term housing affordability issues in the County, but that the dramatic deterioration in housing affordability since the beginning of the pandemic is not primarily a consequence of STA activity. 


\newpage
# STA housing market impacts

<style type="text/css">
  body{
  font-family: Futura, Helvetica, Arial;
}
</style>

<br>

```{r setup, include = FALSE, echo = FALSE}

library(here)
source(here("R", "01_startup.R"))

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# Function for checking file modifications
mtime <- function(files) lapply(Sys.glob(files), function(x) file.info(x)$mtime)

qload(here("output", "/geometry.qsm"))
qload(here("output", "/str_processed.qsm"))
seasonal_FREH <- qread("output/seasonal_FREH.qs")

# Set this to TRUE to output PDF figures
build_figures <- TRUE

```
```{r housing_objects, cache=TRUE, cache.lazy=FALSE}

home_sales <- qread(here("output", "home_sales.qs"), nthreads = availableCores())

DA_housing <- 
  cancensus::get_census(
    dataset = "CA16", regions = list(CSD = c("3513020")), level = "DA",
    vectors = c("v_CA16_4836", "v_CA16_4838", "v_CA16_4837", "v_CA16_4901", 
                "v_CA16_4899", "v_CA16_4894", "v_CA16_6698", "v_CA16_6692", 
                "v_CA16_6725", "v_CA16_6719", "v_CA16_4896", "v_CA16_4892",
                "v_CA16_4986", "v_CA16_4984"),
    geo_format = "sf") %>% 
  st_transform(32618) %>% 
  select(-c(`Shape Area`:Households, CSD_UID:`Area (sq km)`)) %>% 
  set_names(c("dwellings", "GeoUID", "parent_tenure", "renter", "owner", "average_rent",
              "p_thirty_renter", "average_ho_cost", "average_value_dwellings", "p_thirty_owner", 
              "mobility_one_year", "parent_mobility_one_year", "mobility_five_years", 
              "parent_mobility_five_years", "at_hh_inc", "parent_hh", "geometry")) %>% 
  mutate(p_mobility_one_year = mobility_one_year/parent_mobility_one_year,
         p_mobility_five_years = mobility_five_years/parent_mobility_five_years,
         p_thirty_renter = p_thirty_renter / 100,
         p_thirty_owner = p_thirty_owner / 100) %>% 
  select(GeoUID, dwellings, renter, owner, average_rent, average_ho_cost, average_value_dwellings,
         p_thirty_renter, p_thirty_owner, p_mobility_one_year, p_mobility_five_years, at_hh_inc, parent_hh) %>% 
  as_tibble() %>% 
  st_as_sf(agr = "constant")

# Apply spatial interpolation to get census data by ward

EW_housing <- 
  DA_housing %>% 
  mutate(area = st_area(geometry)) %>% 
  st_set_agr("constant") %>% 
  mutate(thirty_renter = p_thirty_renter * renter,
         thirty_owner = p_thirty_owner * owner,
         mobility_one_year = p_mobility_one_year * dwellings,
         mobility_five_years = p_mobility_five_years * dwellings) %>% 
  select(GeoUID, dwellings, owner, renter, average_rent, average_ho_cost, average_value_dwellings,
         thirty_renter, thirty_owner, mobility_one_year, mobility_five_years, at_hh_inc, parent_hh, area)

avg_list <- str_subset(names(EW_housing), "average|p_|inc") %>% 
  str_subset("total", negate = TRUE)

agg_list <-
  setdiff(names(EW_housing), c("GeoUID", "geometry", "area")) %>% 
  setdiff(avg_list)

round_list <- c("average_rent", "average_ho_cost", "average_value_dwellings", 
                "dwellings", "renter", "owner")

EW_housing <- 
  EW %>% 
  select(ward) %>% 
  st_transform(32618) %>% 
  st_set_agr("constant") %>% 
  st_intersection(., EW_housing) %>% 
  mutate(area_prop = st_area(geometry) / area) %>% 
  mutate(across(all_of(agg_list), ~{.x * units::drop_units(area_prop)})) %>% 
  select(-GeoUID, -area, -area_prop) %>% 
  st_drop_geometry() %>% 
  group_by(ward) %>% 
  summarize(
    average_rent = weighted.mean(average_rent, renter, na.rm = TRUE),
    average_ho_cost = weighted.mean(average_ho_cost, owner, na.rm = TRUE),
    average_value_dwellings = weighted.mean(average_value_dwellings, owner, na.rm = TRUE),
    at_hh_inc = weighted.mean(at_hh_inc, parent_hh, na.rm = TRUE),
    across(all_of(agg_list), sum, na.rm = TRUE)) %>% 
  mutate(p_thirty_renter = thirty_renter / renter,
         p_thirty_owner = thirty_owner / owner,
         p_mobility_one_year = mobility_one_year / dwellings,
         p_mobility_five_years = mobility_five_years / dwellings) %>% 
  select(-thirty_renter, -thirty_owner, -mobility_one_year, -mobility_five_years, -parent_hh) %>% 
  mutate(across(all_of(round_list), round, digit = 0)) %>% 
  left_join(., EW %>% select(ward), by = "ward") %>% 
  st_as_sf() %>% 
  st_transform(32618)

```
```{r on_water, cache = TRUE, cache.lazy = FALSE}

ocean <-
  read_sf(here("data", "shapefiles", "lhy_000h16a_e.shp")) %>%
  st_transform(32618)

ocean <-
  ocean %>%
  st_filter(select(city, -everything()))

river <-
  read_sf(here("data", "shapefiles", "lhy_000c16a_e.shp")) %>%
  st_transform(32618)

river <-
  river %>%
  st_filter(select(city, -everything()))

water <- rbind(select(river, -everything()), select(ocean, -everything()))

```

**TKTK**

<br>

## Housing issues in Prince Edward County

The common definition of affordable housing is that for which the costs do not exceed 30% of the household's disposable income. The Canadian Mortgage and Housing Corporation calls this metric the "shelter cost-income ratio" (2020). Additionally, a healthy rental market is considered one in which the vacancy rate is of 3% of above (ACTO 2021). By either of these metrics, Prince Edward County's housing market has been under severe stress in the last several years. Housing demand—driven by some combination of in-movers, STAs, and second-home sales—has far outstripped housing supply. The Covid-19 pandemic has exacerbated these demand-side issues by bringing in an influx of new buyers looking for a second home, in part due to the increased possibilities for remote work. As a result, housing prices and rents have both risen far faster than local incomes. This chapter provides an overview of housing conditions for both homeowners and renters in Prince Edward County, and then analyzes the role of STAs in the County's housing affordability challenges.


## Housing sales and prices

```{r sales_figures, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

peak_housing_sale <- 
  home_sales %>% 
   st_drop_geometry() %>% 
   mutate(year_month = format(sale_date, "%Y-%m")) %>% 
   mutate(year_month = paste0(year_month, "-01")) %>% 
   mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
   group_by(year_month) %>% 
   summarize(n=n(), mean_sale = mean(sale_price, na.rm=TRUE)) %>% 
   arrange(desc(n)) %>% 
   slice(1) %>% 
   pull(n)

dec_2020_sale_price <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year_month = format(sale_date, "%Y-%m")) %>% 
  mutate(year_month = paste0(year_month, "-01")) %>% 
  mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
  group_by(year_month) %>% 
  summarize(n=n(), mean_sale = mean(sale_price, na.rm=TRUE)) %>% 
  arrange(desc(mean_sale)) %>% 
  slice(1) %>% 
  pull(mean_sale) %>% 
  round(digit = -2) %>% 
  prettyNum(",") %>% 
  paste0("$", .)

home_sales_variation <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year_month = format(sale_date, "%Y-%m")) %>% 
  mutate(year_month = paste0(year_month, "-01")) %>% 
  mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
  group_by(year_month) %>% 
  summarize("Number of sales" = n(), "Average sale price" = mean(sale_price, na.rm=TRUE)) %>% 
  mutate(across(where(is.numeric), 
                function(x) slide_dbl(x, ~{(.x[13] - .x[1]) / .x[1]}, 
                                      .before = 12, .complete = FALSE))) %>% 
  pivot_longer(-year_month, names_to = "var", values_to = "value") %>% 
  group_by(var) %>% 
  mutate(value = slide_dbl(value, mean, .before = 0, .complete = TRUE)) %>% 
  ungroup() %>% 
  filter(year_month >= "2017-01-01")

yoy_sale_2021 <- 
  home_sales_variation %>% 
  filter(var == "Average sale price") %>% 
  arrange(desc(value)) %>% 
  slice(2) %>% 
  pull(value) %>% 
  scales::percent(0.1)

n_sale_2016 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2016) %>% 
  pull(n)

avg_sale_2016 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2016) %>% 
  pull(avg) %>%
  scales::dollar(accuracy = 10)

n_sale_2019 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2019) %>% 
  pull(n)

avg_sale_2019 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2019) %>% 
  pull(avg) %>%
  scales::dollar(accuracy = 10)

n_sale_2020 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2020) %>% 
  pull(n)

avg_sale_2020 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2020) %>% 
  pull(avg) %>%
  scales::dollar(accuracy = 10)

avg_sale_2021 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = round(mean(sale_price, na.rm=TRUE), -1)) %>% 
  filter(sale_date == 2021) %>% 
  pull(avg) %>%
  scales::dollar(accuracy = 10)

scale_factor <-
  home_sales |> 
  st_drop_geometry() |> 
  filter(year(sale_date) == 2020) |> 
  summarize(scale = sum(month(sale_date) >= 7) / sum(month(sale_date) <= 6)) |> 
  pull(scale) |> 
  {\(x) x + 1}()

data_for_graph <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = mean(sale_price, na.rm = TRUE)) |> 
  mutate(n = if_else(sale_date == 2021, round(n * scale_factor), as.numeric(n)),
         shift = sale_date + n ^ 0.45 / 50)

n_sale_2021 <- 
  data_for_graph |> 
  filter(sale_date == 2021) |> 
  pull(n) |> 
  scales::comma()


```

Even prior to the last several years, housing prices were increasing rapidly in Prince Edward County. By one estimate, the median home price in the county almost doubled between 2008 to 2018, going from $205,000 to $395,000. That is an increase seven times greater than the increase in median household incomes in the same time period (The County Foundation 2018). In the last five years, however, two external market forces—namely STAs and secondary home purchases by households from urban areas—have added a new source of housing demand. In the face of relatively stable housing supply (as of the 2016 census, only 4.2% of housing units had been built in the previous five years), this new demand has contributed to record-setting housing price increases. To conduct an analysis of the homeownership market, our team was provided by the Prince Edward County Real Estate Board with a dataset of every residential real estate transaction in the County from January 2016 through September 2021, totaling `r scales::comma(nrow(home_sales))` sales.

``` {r make_fig_2_1}

figure_2_1_fun <- function(regular = "", condensed = "") {
  
sales_for_map <- 
  home_sales %>% 
  filter(sale_date >= "2021-01-01") %>% 
  st_drop_geometry() %>% 
  left_join(., EW, by = "ward") %>% 
  filter(!is.na(ward)) %>% 
  st_as_sf() %>% 
  group_by(ward) %>% 
  summarize(avg_sale_price_2021 = mean(sale_price, na.rm = TRUE))

sales_labels <-
  sales_for_map |> 
  st_centroid(of_largest_polygon = TRUE) |> 
  mutate(x = st_coordinates(geometry)[, 1],
         y = st_coordinates(geometry)[, 2],
         label = scales::dollar(avg_sale_price_2021, 100)) |> 
  st_drop_geometry()

sales_for_map |> 
ggplot() +
  geom_sf(data = province, colour = "transparent", fill = "grey93") +
  geom_sf(aes(fill = avg_sale_price_2021), colour = "white") +
  geom_sf(data = water, fill = "white", colour = "transparent") +
  ggrepel::geom_label_repel(aes(x, y, label = label), data = sales_labels,
                            size = 2, nudge_y = c(0, 0, -5000, 2000, 0, 0, 5000,
                                                  0, 0, 0)) +
  scale_fill_stepsn(colors = col_palette[c(3, 4, 6)], na.value = "grey80",)  +
  gg_bbox(EW) +
  theme_void() +
  theme(text = element_text(family = regular, face = "plain"),
        legend.position = "none",
        panel.border = element_rect(colour = "white", size = 2))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_1.pdf"), 
         plot = figure_2_1_fun(), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_1.pdf"))
}

```

Figure \@ref(fig:fig-2-1) shows the average selling price by electoral ward for each home sold in 2021. Prices are highest in the eastern and central parts of the County, but, with the exception of Athol, the average price in each ward is above $650,000. (That figure climbs above $1 million in South Marysburgh).

``` {r fig-2-1, include = TRUE, fig.cap = '(ref:fig-2-1)', fig.align = "center"}

figure_2_1_fun()

```
(ref:fig-2-1) _Average home sale prices by ward in 2021_

``` {r make_fig_2_2}

figure_2_2_fun <- function(regular = "", condensed = "") {
  
  data_for_graph <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(sale_date = year(sale_date)) %>% 
  filter(!is.na(sale_date)) %>% 
  group_by(sale_date) %>% 
  summarize(n = n(), avg = mean(sale_price, na.rm = TRUE)) |> 
  mutate(n = if_else(sale_date == 2021, round(n * scale_factor), as.numeric(n)),
         shift = sale_date + n ^ 0.45 / 50)
  
  ggplot(data_for_graph) +
  geom_smooth(aes(sale_date, avg), data = filter(data_for_graph, sale_date <= 2019),
              se = FALSE, colour = col_palette[2], method = "lm", 
              formula = y ~ log(x - 2015)) +
  geom_smooth(aes(sale_date, avg), data = filter(data_for_graph, sale_date >= 2019),
              se = FALSE, colour = col_palette[7], method = "lm") +
  geom_point(aes(sale_date, avg, size = n), colour = col_palette[5]) +
  geom_text(aes(shift, avg, label = n)) +
  scale_x_continuous(name = NULL, limits = c(2016, 2021.5), breaks = 2016:2021) +
  scale_y_continuous(name = NULL, limits = c(300000, 800000), 
                     labels = scales::dollar) +
  scale_size(limits = c(0, 1200), range = c(0, 20)) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank())

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_2.pdf"), 
         plot = figure_2_2_fun(), 
         width = 9, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_2.pdf"))
}

```

Figure \@ref(fig:fig-2-2) summarizes the volume and average prices of home sales since 2016. There are two important trends in this data. The first is that, although house prices were rising steadily through 2019, price growth was starting to level off. (This is visible in the declining slope of the light blue trend line.) By contrast, since the start of the pandemic, sale prices have been on a far steeper trajectory (the purple trend line)—nearly doubling in just two years. The average price was price of `r avg_sale_2016` in 2016, but rose to `r avg_sale_2019` in 2019, `r avg_sale_2020` in 2020, and `r avg_sale_2021` in 2021 (so far). The peak average monthly sale price reached `r dec_2020_sale_price` in December 2020, which is a staggering `r yoy_sale_2021` higher than the the same month the year before. 

``` {r fig-2-2, include = TRUE, fig.cap = '(ref:fig-2-2)', fig.align = "center"}

figure_2_2_fun()

```
(ref:fig-2-2) _Housing sales prices and volume, 2016-2021_

``` {r make_fig_2_3}

figure_2_3_fun <- function(regular = "", condensed = "") {

home_sales_variation %>%
  mutate(label = if_else(year_month == "2018-01-01", var, NA_character_)) %>%
  ggplot(aes(year_month, value, colour = var)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  geom_line(lwd = 1, na.rm = TRUE) +
  geom_label(aes(label = label), size = 3, family = condensed) +
  scale_x_date(name = NULL) +
  scale_y_continuous(name = NULL, limits = c(-1, NA),
                     labels = scales::percent) +
  scale_color_manual(name = NULL, values = col_palette[c(1, 3)]) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank(),
        text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_3.pdf"),
         plot = figure_2_3_fun(),
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)

  extrafont::embed_fonts(here("output", "figures", "figure_2_3.pdf"))
}

```

The second trend is the increasing sales volume during the pandemic. In 2016, there were `r n_sale_2016` property sales in the County, but this number declined over the next several years to reach `r n_sale_2019` in 2019. Sales volume began to surge in the month following the pandemic, reaching a monthly peak of `r peak_housing_sale` sales in July 2020. In total, 2020 saw a increase to `r n_sale_2020` sales, while 2021 is on track for `r n_sale_2021` sales by year's end—nearly three times higher than 2019. Figure \@ref(fig:fig-2-3) summarizes the year-over-year changes in monthly number of sales and sale price. 

``` {r fig-2-3, include = TRUE, fig.cap = '(ref:fig-2-3)', fig.align = "center"}

figure_2_3_fun()

```
(ref:fig-2-3) _Year-over-year changes in monthly real estate sales and average sale prices_

```{r days_on_market, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

DOM <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year_month = format(sale_date, "%Y-%m")) %>% 
  mutate(year_month = paste0(year_month, "-01")) %>% 
  mutate(year_month = as_date(year_month, format = "%Y-%m-%d")) %>% 
  group_by(year_month) %>% 
  summarize(avg_DOM = mean(DOM, na.rm = TRUE))

DOM_2019 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  group_by(year) %>% 
  summarize(avg_DOM = round(mean(DOM, na.rm = TRUE), digit = 0)) %>% 
  filter(year == 2019) %>% 
  pull(avg_DOM)

DOM_2020 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  group_by(year) %>% 
  summarize(avg_DOM = round(mean(DOM, na.rm = TRUE), digit = 0)) %>% 
  filter(year == 2020) %>% 
  pull(avg_DOM)

DOM_2021 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  group_by(year) %>% 
  summarize(avg_DOM = round(mean(DOM, na.rm = TRUE), digit = 0)) %>% 
  filter(year == 2021) %>% 
  pull(avg_DOM)

diff_2019 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  mutate(diff_price = sale_price - list_price) %>% 
  group_by(year) %>% 
  summarize(diff_price = mean(diff_price, na.rm = TRUE)) %>% 
  filter(year == 2019) %>% 
  pull(diff_price) %>% 
  scales::dollar(100)

diff_2021 <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  mutate(diff_price = sale_price - list_price) %>% 
  group_by(year) %>% 
  summarize(diff_price = mean(diff_price, na.rm = TRUE)) %>% 
  filter(year == 2021) %>% 
  pull(diff_price) %>% 
  scales::dollar(100)

```

``` {r make_fig_2_4}

figure_2_4_fun <- function(regular = "", condensed = "") {
  
home_sales %>% 
  st_drop_geometry() %>% 
  group_by(sale_date) %>% 
  summarize(avg_DOM = mean(DOM, na.rm=TRUE)) |> 
  mutate(avg_DOM = slide_dbl(avg_DOM, mean, .before = 6)) |> 
  ggplot(aes(sale_date, avg_DOM)) +
  geom_line(color = col_palette[2], alpha = 0.5) +
  stat_smooth(color = col_palette[2], method = "loess", se = FALSE, span = 0.8) +
  scale_y_continuous(name = NULL, label = scales::comma, limits = c(0, 150)) +
  scale_x_date(name = NULL, date_breaks = "1 year", minor_breaks = NULL,
               date_labels = c("2021", "2016", "2017", "2018", "2019", "2020"))+
  theme_minimal() +
  theme(legend.position = "bottom", panel.grid.minor.x = element_blank(), 
        text = element_text(family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_4.pdf"), 
         plot = figure_2_4_fun(), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_4.pdf"))
}

```

Several other indicators support the picture of a housing market in the midst of a demand shock, including the number of days on the market, the difference between asking price and sale price, and the number of resales. Figure \@ref(fig:fig-2-3) shows the number of days on market for home sales in Prince Edward County, and reveals a rapidly falling average during the pandemic. The average sale in 2019 had been on the market for `r DOM_2019` days, but that number fell to `r DOM_2020` in 2020, and to just `r DOM_2021` days in 2021. During the same time period, the difference between original asking price and final sale price shifted substantially, rising from `r diff_2019` in 2019 (indicating that the average property sold for less than its asking price) to `r diff_2021` in 2021—the first time this indicator has been positive since our dataset began in 2016.

``` {r fig-2-4, include = TRUE, fig.cap = '(ref:fig-2-4)', fig.align = "center"}

figure_2_4_fun()

```
(ref:fig-2-4) _Average number of days on market for successful home sales (7-day average)_

```{r multiple_sales, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

multiple_sales <-
  home_sales %>% 
  st_drop_geometry() %>% 
  arrange(sale_date) %>% 
  group_by(address, ward, unit_number) %>% 
  summarize(sale_dates = list(sale_date)) %>% 
  filter(lengths(sale_dates) > 1) %>%
  rowwise() %>% 
  mutate(difs = as.numeric(min(diff(sale_dates)))) |>
  ungroup() |> 
  filter(difs <= 730) |> 
  rowwise() |> 
  mutate(year = lubridate::year(max(sale_dates))) |> 
  ungroup() |> 
  count(year) |> 
  rename(resales = n) |> 
  left_join(home_sales %>% 
              st_drop_geometry() %>% 
              count(year = year(sale_date))) |> 
  mutate(resale_pct = resales / n) |> 
  filter(year >= 2018) |> 
  select(-n)

total_sales_2018_on <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  filter(sale_date >= "2018-01-01") %>%
  arrange(sale_date) %>% 
  count(address, ward, unit_number) %>% 
  nrow() %>%
  scales::comma()

```

Out of the `r total_sales_2018_on` sales which occurred in Prince Edward County from 2018 to 2021, a total of `r sum(multiple_sales$resales)` residential properties had already been sold at least once in the previous two years (Table \@ref(tab:tab-2-1)). Quick sales such as these may indicate "house flipping", and is a clear symptom of a housing market where speculative investments are playing a role. (In fact, one property in Prince Edward County has been sold four separate times between 2016 and 2021.) The table demonstrates that quick sales have risen rapidly since 2018, both in absolute numbers and as a proportion of all sales. In 2021 so far, `r `scales::percent(max(multiple_sales$resale_pct)), 0.1)` of all home sales are properties which had been sold in the previous two years.

``` {r tab-2-1, include = TRUE}

library(kableExtra)

multiple_sales |> 
  mutate(resale_pct = scales::percent(resale_pct, 0.1)) |> 
  set_names(c("Year of sale", "Multi-sale properties", 
              "Multi-sale properties as % of all properties sold")) |> 
  kbl(caption = "Properties sold multiple times between 2016 and 2021",
      align = "lrr") %>% 
  kable_styling(latex_options="scale_down") 

  
```


## Homeownership affordability

The housing sales trends described above tell only half the story of homeownership affordability in Prince Edward County. The other half is the ability of County residents to afford elevated housing prices. The most recent reliable data on Canadian incomes and housing affordability comes from the 2016 Census, which means that it will not have captured changes in income or in housing costs in the last five years. Given the incredibly rapid increase in housing prices during that period, it is important to 


```{r owner_calcs, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

sale_price_by_ward <- 
  home_sales %>% 
  filter(sale_date >= "2020-01-01") %>% 
  st_drop_geometry() %>% 
  left_join(., EW, by = "ward") %>% 
  filter(!is.na(ward)) %>% 
  st_as_sf() %>% 
  group_by(ward) %>% 
  summarize(avg_sale_price_2021 = mean(sale_price, na.rm=TRUE))

sale_price_2020_2017 <- 
  home_sales %>% 
  filter(sale_date >="2017-01-01", sale_date <= "2018-12-31") %>% 
  st_drop_geometry() %>% 
  left_join(., EW, by = "ward") %>% 
  filter(!is.na(ward)) %>% 
  st_as_sf() %>% 
  group_by(ward) %>% 
  summarize(avg_sale_price_1718 = mean(sale_price, na.rm=TRUE)) %>%
  st_drop_geometry() %>% 
  left_join(., sale_price_by_ward, by = "ward") %>% 
  st_as_sf()

#https://www.wallstreetmojo.com/mortgage-formula/

affordable_homeownership_2021 <- 
  sale_price_2020_2017 %>% 
  st_drop_geometry() %>% 
  mutate(downpayment = avg_sale_price_2021*0.2,
         P = avg_sale_price_2021 - downpayment,
         amortization = 25,
         mortgage_rate = 0.0175) %>% 
  mutate(r = mortgage_rate/12,
         n = amortization*12) %>% 
  mutate(monthly_mortgage_payments = P*r*(((1+r)^n)
                                          /
                                          (((1+r)^n)-1)
                                          )
         ) %>% 
  mutate(maintenance_cost = 700,
         total_mortgage_payments = (monthly_mortgage_payments+maintenance_cost)*12,
         affordable_income_2021 = total_mortgage_payments/0.3) %>% 
  left_join(., st_drop_geometry(EW_housing) %>% select(ward, at_hh_inc), by="ward") %>% 
  mutate(diff_affordable_real_2021 = at_hh_inc-affordable_income_2021) %>% 
  select(ward, avg_sale_price_2021, at_hh_inc, diff_affordable_real_2021)

affordable_homeownership_1718 <- 
  sale_price_2020_2017 %>% 
  st_drop_geometry() %>% 
  mutate(downpayment = avg_sale_price_1718*0.2,
         P = avg_sale_price_1718 - downpayment,
         amortization = 25,
         mortgage_rate = 0.0175) %>% 
  mutate(r = mortgage_rate/12,
         n = amortization*12) %>% 
  mutate(monthly_mortgage_payments = P*r*(((1+r)^n)
                                          /
                                            (((1+r)^n)-1)
  )
  ) %>% 
  mutate(maintenance_cost = 700,
         total_mortgage_payments = (monthly_mortgage_payments+maintenance_cost)*12,
         affordable_income_1718 = total_mortgage_payments/0.3) %>% 
  left_join(., st_drop_geometry(EW_housing) %>% select(ward, at_hh_inc), by="ward") %>% 
  mutate(diff_affordable_real_1718 = at_hh_inc-affordable_income_1718) %>% 
  select(ward, avg_sale_price_1718, at_hh_inc, diff_affordable_real_1718)

diff_picton_1718 <- 
  affordable_homeownership_1718 %>% 
  filter(ward=="Picton") %>% 
  pull(diff_affordable_real_1718) %>% 
  {.*-1} %>% 
  scales::dollar(10) 

```

Based on the average sale prices for the past years, it was possible to estimate the average household income it would take to become a homeowner in Prince Edward County in an affordable manner. We completed the exercise using average sale prices for the 2017-2018 and 2020-2021 periods to highlight the recent market changes in the county. The calculations were based on a 25-year mortgage at a 1.75% interest rate and a 20% mortgage down payment (although 20% down payment can be considered a rare feat, with most people having small down payments and needing to insure their mortgages). Monthly mortgage payments and homeownership maintenance costs (property taxes, utilities) were calculated to provide a yearly homeownership total costs, from which an affordable homeownership threshold was determined. The affordable homeownership threshold represents the minimum household income required to have housing costs remain at 30% of income or below. These thresholds for both 2017-2018 and 2020-2021 were then compared to the 2016 census after-tax household income, by ward (2016 being the most recent data available). The differences between the affordable thresholds and the actual household incomes are displayed in Table \@ref(tab:tab-2-2). We can see that, for both time periods, the average after-tax household income in each ward is not sufficient to make homeownership affordable in the County (with North Marysburgh in 2017-2018 being the only exception). In the 2020-2021 period, there are five wards for which households would require more than $50,000 to make current homeownership market conditions affordable for them, whereas the highest difference in 2017-2018 was Picton with `r diff_picton_1718`.





``` {r tab-2-2, include = TRUE}

library(kableExtra)

affordable_homeownership_1718 %>% 
  left_join(., affordable_homeownership_2021 %>% select(-at_hh_inc), by = "ward") %>% 
  select(ward, avg_sale_price_1718, avg_sale_price_2021,
         at_hh_inc, diff_affordable_real_1718, diff_affordable_real_2021) %>% 
  mutate(avg_sale_price_1718 = scales::dollar(avg_sale_price_1718, 10),
         avg_sale_price_2021 = scales::dollar(avg_sale_price_2021, 10),
         at_hh_inc = scales::dollar(at_hh_inc, 10),
         diff_affordable_real_1718 = scales::dollar(diff_affordable_real_1718, 10),
         diff_affordable_real_2021 = scales::dollar(diff_affordable_real_2021, 10)) %>% 
  arrange(desc(diff_affordable_real_2021)) %>% 
  set_names(c("Ward", "Average sale price, 2017-2018", "Average sale price, 2020-2021", 
              "After-tax household income, 2016 census", "Difference with affordable income threshold, 2017-2018", 
              "Difference with affordable income threshold, 2020-2021")) %>% 
  kbl(caption = "Difference between household incomes and affordable homeownership threshold, for 2017-2018 and 2020-2021",
      align = "lrrrrr") %>% 
  kable_styling(latex_options="scale_down") 
  
```


# Being a renter in Prince Edward County

```{r para_7, cache = TRUE, cache.lazy = FALSE, cache.extra = mtime(here("output", "str_processed.qsm"))}

rent_sept <- qread("output/rent_sept.qs", nthreads = availableCores())
  
p_thirty_renter_well <- 
  EW_housing %>% 
  st_drop_geometry %>% 
  arrange(desc(p_thirty_renter)) %>% 
  slice(1) %>% 
  pull(p_thirty_renter) %>%   
  scales::percent(accuracy = 0.1)

p_thirty_renter_picton <- 
  EW_housing %>% 
  st_drop_geometry %>% 
  arrange(desc(p_thirty_renter)) %>% 
  slice(2) %>% 
  pull(p_thirty_renter) %>%   
  scales::percent(accuracy = 0.1)

p_thirty_renter_hallo <- 
  EW_housing %>% 
  st_drop_geometry %>% 
  arrange(desc(p_thirty_renter)) %>% 
  slice(3) %>% 
  pull(p_thirty_renter) %>%   
  scales::percent(accuracy = 0.1)

avg_rent_bach <- 
  rent_sept %>% 
  group_by(bedrooms) %>% 
  summarize(avg_rent = mean(rent)) %>% 
  filter(bedrooms == 0) %>% 
  pull(avg_rent) %>% 
  scales::dollar(accuracy = 1)

avg_rent_one <- 
  rent_sept %>% 
  group_by(bedrooms) %>% 
  summarize(avg_rent = mean(rent)) %>% 
  filter(bedrooms == 1) %>% 
  pull(avg_rent) %>% 
  scales::dollar(accuracy = 1)

avg_rent_two <- 
  rent_sept %>% 
  group_by(bedrooms) %>% 
  summarize(avg_rent = mean(rent)) %>% 
  filter(bedrooms == 2) %>% 
  pull(avg_rent) %>% 
  scales::dollar(accuracy = 1)

avg_rent_three <- 
  rent_sept %>% 
  group_by(bedrooms) %>% 
  summarize(avg_rent = mean(rent)) %>% 
  filter(bedrooms == 3) %>% 
  pull(avg_rent) %>% 
  scales::dollar(accuracy = 1)

avg_rent_pec_sept_2021 <- 
  mean(rent_sept$rent) %>% 
  scales::dollar(accuracy = 1) 

census_avg_rent <- 
  paste("$936")

towns <- c("Picton", "Wellington", "Bloomfield")

EW_rent <- 
  EW_housing %>% 
  st_drop_geometry() %>% 
  mutate(ward = ifelse(!ward %in% towns, "Township", ward)) %>% 
  group_by(ward) %>% 
  summarise(avg_census_rent = weighted.mean(average_rent, renter),
            avg_hh_inc = weighted.mean(at_hh_inc, dwellings))

rent_diff_table <- 
  rent_sept %>% 
  group_by(ward) %>% 
  summarize(sept_avg_rent = mean(rent)) %>% 
  left_join(., EW_rent, by ="ward") %>% 
  mutate(affordable_rent = (avg_hh_inc/12)*0.30,
         rent_diff = affordable_rent - sept_avg_rent) %>% 
  mutate(ward = ifelse(ward == "Township", "Townships", ward)) %>% 
  select(ward, sept_avg_rent, avg_hh_inc, affordable_rent, rent_diff) %>% 
  arrange(rent_diff)

rent_diff_picton <- 
  rent_diff_table %>% 
  filter(ward == "Picton") %>% 
  pull(rent_diff) %>% 
  {. *-1} %>% 
  scales::dollar(accuracy = 1)

rent_diff_well <- 
  rent_diff_table %>% 
  filter(ward == "Wellington") %>% 
  pull(rent_diff) %>% 
  {. *-1} %>% 
  scales::dollar(accuracy = 1)
  
  
  
```

``` {r tab-4-4, include = TRUE}

library(kableExtra)

rent_diff_table %>% 
    mutate(sept_avg_rent = scales::dollar(sept_avg_rent, 1),
         avg_hh_inc = scales::dollar(avg_hh_inc, 10),
         affordable_rent = scales::dollar(affordable_rent, 1),
         rent_diff = scales::dollar(rent_diff, 1)) %>% 
  set_names(c("Ward", "Average rent, Sept. 2021", "After-tax household income, 2016 census", 
              "Affordable rent threshold", "Difference with affordable rent threshold")) %>% 
  kbl(caption = "Difference between Sept. 2021 average rents and affordable rent thresholds",
      align = "lrrrrr") %>% 
  kable_styling(latex_options="scale_down") 
  
```

``` {r make_fig_2_8}

affordability_map_data <- 
  affordable_homeownership_1718 %>% 
  left_join(., affordable_homeownership_2021 %>% select(-at_hh_inc), by = "ward") %>% 
  select(ward, avg_sale_price_1718, avg_sale_price_2021,
         at_hh_inc, diff_affordable_real_1718, diff_affordable_real_2021) |> 
  pivot_longer(c(diff_affordable_real_1718, diff_affordable_real_2021),
               names_to = "years") |> 
  mutate(years = if_else(str_detect(years, "1718"), "2017-2018", "2020-2021"))

figure_2_8_fun <- function(regular = "", condensed = "") {
  
EW |> 
  left_join(affordability_map_data) |> 
  ggplot() +
  geom_sf(data = province, colour = "transparent", fill = "grey93") +
  geom_sf(aes(fill = value), colour = "white", size = 0.1) +
  geom_sf(data = water, fill = "white", colour = "transparent") +
  facet_wrap(vars(years)) +
  scale_fill_steps2(low = col_palette[6],
                    high = col_palette[3], limits = c(-90000, 90000),
                    breaks = 10000 * c(-9, -6, -3, 0, 3, 6, 9),
                    labels = scales::dollar)  +
  guides(fill = guide_colourbar(title = "Average\naffordability gap",
                                title.vjust = 1)) + 
  gg_bbox(EW) +
  theme_void() +
  theme(text = element_text(family = regular, face = "plain"),
        legend.title = element_text(family = regular, face = "bold",
                                    size = 7),
        legend.title.align = 0.9,
        legend.text = element_text(family = regular, size = 5),
        panel.border = element_rect(colour = "white", size = 2),
        strip.text = element_text(face = "bold"),
        legend.position = "bottom", legend.key.width = unit(1.8, "lines"))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_8.pdf"), 
         # plot = figure_1_2_fun("Futura", "Futura Condensed"), 
         plot = figure_2_8_fun(), 
         width = 8, height = 3.5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_8.pdf"))
}

```


``` {r fig-2-8, include = TRUE, fig.cap = '(ref:fig-2-8)', fig.align = "center"}

figure_2_8_fun()

```


The renter situation in Prince Edward County is different than that of homeowners. First of all, renters make up only 16.9% of all households in the County. However, almost half (48.9%) of renters are in a situation of housing stress. The ward with the most renters' housing stress is Wellington, with `r p_thirty_renter_well` of renters spending more than 30% of their household income on rent, followed by Picton with `r p_thirty_renter_picton` and Hallowell with `r p_thirty_renter_hallo`. As of October 2017, the calculated rental vacancy rate was 0.81% (Prince Edward County 2019). In the past years, renters have experienced tightening conditions in part due to the increased competition renters have with seasonal tourism. The pressure in the homeownership market has put increasing pressure on the County's rental stock. There have been accounts of bidding wars in the rental market in response to the limited units available. The workforce is struggling to find rents that fit their budget, even with hourly pays of 20 to $25 per hour. The pandemic has only heightened this situation, with the largest year-over-year increase in average rent occurring from June 2020 to June 2021, with a 52% increase. As of September 2021, the average rent for a bachelor unit was `r avg_rent_bach` while the average rent for a one-bedroom was `r avg_rent_one`. The average rents for two-bedrooms and three-bedrooms were `r avg_rent_two` and `r avg_rent_three`, respectively. The total average rent of `r avg_rent_pec_sept_2021 ` in September 2021 stands in great contrast with the 2016 census' registered average rent of `r census_avg_rent`.

In order to consider rent as affordable, a given household must not spend more than 30% of their income on shelter costs. With collected rents from Picton, Wellington, Bloomfield and the townships, it was possible to establish the affordability thresholds for renters per geographic locations. Table \@ref(tab:tab-4-4) summarizes these findings. In Picton, the average after-tax household income is not sufficient to make rent affordable in Prince Edward County: renters spend on average `r rent_diff_picton` more on rent than the affordable rent threshold. This number in Wellington is `r rent_diff_well`. The difference between affordable rents and actual average market rents needs to be taken as conservative estimates. The after-tax household income used for this calculation includes incomes from both owner and renter households. Renter households earn less on average than owner households, meaning that the household income used for this calculation might be inflated and overrepresented by that of the homeowners, which are also a majority of households in Prince Edward County.





```{r new_objects_2}

FREH <- 
  daily %>% 
  # 180 days after VRBO
  filter(date >= as.Date("2017-06-01") + days(180)) %>% 
  group_by(date) %>% 
  summarize(across(c(FREH_6), sum))

FREH_EW <- 
  daily %>% 
  filter(date >= start_2019) %>% 
  group_by(ward, date) %>% 
  summarize(FREH = sum(FREH_6)) %>% 
  mutate(date = case_when(str_starts(date, "2019") ~ 2019,
                         str_starts(date, "2020") ~ 2020,
                         str_starts(date, "2021") ~ 2021)) %>% 
  group_by(ward, date) %>% 
  summarize(FREH = round(mean(FREH))) 
  

FREH_DA <- 
  daily %>% 
  filter(date == max(daily$date)) %>% 
  left_join(select(st_drop_geometry(property), property_ID, GeoUID)) %>% 
  group_by(GeoUID) %>% 
  summarize(FREH = sum(FREH_6))

GH_EW <- 
  GH %>% 
  filter(date >= start_2019) %>% 
  mutate(geometry = st_centroid(geometry)) %>% 
  st_join(EW) %>% 
  st_drop_geometry() %>% 
  group_by(ward, date) %>% 
  summarize(GH = sum(housing_units, na.rm = TRUE)) %>% 
  as_tibble() %>% 
  mutate(date = case_when(str_starts(date, "2019") ~ 2019,
                         str_starts(date, "2020") ~ 2020,
                         str_starts(date, "2021") ~ 2021)) %>% 
  group_by(ward, date) %>% 
  summarize(GH = round(mean(GH))) 

GH_DA <- 
  GH %>% 
  filter(date == max(daily$date)) %>% 
  mutate(geometry = st_centroid(geometry)) %>% 
  st_join(DA) %>% 
  st_drop_geometry() %>% 
  group_by(GeoUID) %>% 
  summarize(GH = sum(housing_units, na.rm = TRUE)) %>% 
  as_tibble()

FREH_total <- 
  daily %>% 
  filter(date >= "2017-06-01") %>% 
  group_by(date) %>% 
  summarize(across(c(FREH_6), sum))

GH_total <-
  GH %>%
  st_drop_geometry() %>%
  # filter(status != "B") %>% 
  group_by(date) %>%
  summarize(GH = sum(housing_units)) %>%
  mutate(GH = slide_dbl(GH, mean, .before = 29))

housing_loss <-
  FREH_total %>%
  select(date, FREH_6) %>% 
  left_join(GH_total, by = "date") %>%
  rename(`Entire home/apt` = FREH_6, `Private room` = GH) %>%
  pivot_longer(c(`Entire home/apt`, `Private room`), 
               names_to = "Listing type",
               values_to = "Housing units") %>% 
  mutate(`Listing type` = factor(`Listing type`, 
                                 levels = c("Private room", "Entire home/apt")))  

housing_loss_EW <- 
  EW %>% 
  left_join(FREH_EW) %>% 
  left_join(GH_EW) %>% 
  mutate(GH = if_else(is.na(GH), 0, GH),
         housing_loss_pct = (FREH + GH) / dwellings)

housing_loss_DA <- 
  DA %>% 
  left_join(FREH_DA) %>% 
  left_join(GH_DA) %>% 
  mutate(GH = if_else(is.na(GH), 0L, GH),
         housing_loss_pct = (FREH + GH) / dwellings)

EW_housing_table <- 
  EW %>% 
  st_drop_geometry() %>% 
  left_join(FREH_EW) %>% 
  left_join(GH_EW) %>%
  mutate(GH = if_else(is.na(GH), 0, GH)) %>% 
  group_by(ward) %>% 
  summarize(
    dwellings = mean(dwellings),
    housing_loss_2019 = sum(FREH[date == 2019]) + sum(GH[date == 2019]),
    housing_loss_2021 = sum(FREH[date == 2021]) + sum(GH[date == 2021]),
    change_2019_2021 = (housing_loss_2021 - housing_loss_2019) / housing_loss_2019,
    housing_loss_pct_2021 = housing_loss_2021 / dwellings)
  
```

```{r exec_summ_2}

# Avg housing loss for 2021
housing_loss_2021 <- 
# FREH in 2021
{{FREH %>% 
  filter(date >= start_2021) %>% 
  summarize(mean(FREH_6)) %>% 
  pull() %>% 
  round(digit = -1)} +
# GH in 2021
{GH %>% 
  st_drop_geometry() %>% 
  filter(date >= start_2021) %>% 
  group_by(date) %>% 
  summarize(h_u = sum(housing_units)) %>%
  pull(h_u) %>% mean() %>% 
  round(digit = -1)}}


# Avg housing loss for 2019
housing_loss_2019 <- 
  {{FREH %>% 
      filter(date >= start_2019, date <= end_2019) %>% 
      summarize(mean(FREH_6)) %>% pull()} +
      {GH %>% st_drop_geometry() %>% 
      filter(date >= start_2019, date <= end_2019) %>% 
        group_by(date) %>% summarize(h_u = sum(housing_units)) %>%
        pull(h_u) %>% mean()}} %>% 
  round(digit = -1) %>% 
  prettyNum(",")

# Absolute numbers of change in dedicated STRs from 2019 to 2021
housing_loss_change_absolute <- 
  {{{FREH %>% 
      filter(date >= start_2019, date <= end_2019) %>% 
      summarize(mean(FREH_6)) %>% pull()} +
      {GH %>% st_drop_geometry() %>% 
      filter(date >= start_2019, date <= end_2019) %>% 
        group_by(date) %>% summarize(h_u = sum(housing_units)) %>%
        pull(h_u) %>% mean()}} - 
      {{FREH %>% 
      filter(date >= start_2021) %>% 
      summarize(mean(FREH_6)) %>% pull()} +
      {GH %>% st_drop_geometry() %>% 
      filter(date >= start_2021) %>% 
        group_by(date) %>% summarize(h_u = sum(housing_units)) %>%
        pull(h_u) %>% mean()}}} %>% 
  round(digit = -1) %>% 
  prettyNum(",")


# 2019 to 2021 increase in housing loss
housing_loss_change <- 
  {{{FREH %>% 
      filter(date >= start_2021) %>% 
      summarize(mean(FREH_6)) %>% pull()} +
      {GH %>% st_drop_geometry() %>% 
      filter(date >= start_2021) %>% 
        group_by(date) %>% summarize(h_u = sum(housing_units)) %>%
        pull(h_u) %>% mean()}} /
      {{FREH %>% 
      filter(date >= start_2019, date <= end_2019) %>% 
      summarize(mean(FREH_6)) %>% pull()} +
      {GH %>% st_drop_geometry() %>% 
      filter(date >= start_2019, date <= end_2019) %>% 
        group_by(date) %>% summarize(h_u = sum(housing_units)) %>%
        pull(h_u) %>% mean()}}} %>% 
  {. - 1} %>% 
  {. * -1} %>% 
  round(3) %>% 
  scales::percent(0.1)


housing_loss_pct_dwelling_2021 <- 
  {{{FREH %>% 
      filter(date >= start_2021) %>% 
      summarize(mean(FREH_6)) %>% pull()} +
      {GH %>% st_drop_geometry() %>% 
      filter(date >= start_2021) %>% 
        group_by(date) %>% summarize(h_u = sum(housing_units)) %>%
        pull(h_u) %>% mean()}} /
      sum(EW$dwellings)} %>% 
  round(3) %>% 
  scales::percent(0.1)

housing_loss_pct_EW_2021 <- 
  EW %>% 
  left_join(FREH_EW) %>% 
  left_join(GH_EW) %>% 
  filter(date == "2021") %>% 
  mutate(GH = if_else(is.na(GH), 0, GH),
         housing_loss_per_dwelling = (FREH + GH) / dwellings,
         housing_loss_per_dwelling = round(housing_loss_per_dwelling, 3)) %>% 
  st_drop_geometry()

housing_loss_pct_EW_2019 <- 
  EW %>% 
  left_join(FREH_EW) %>% 
  left_join(GH_EW) %>% 
  filter(date == "2019") %>% 
  mutate(GH = if_else(is.na(GH), 0, GH),
         housing_loss_per_dwelling = (FREH + GH) / dwellings,
         housing_loss_per_dwelling = round(housing_loss_per_dwelling, 3)) %>% 
  st_drop_geometry()

housing_loss_pct_picton_2019 <- 
  housing_loss_pct_EW_2019 %>% 
  filter(ward %in% c("Picton")) %>% 
    pull(housing_loss_per_dwelling) %>% 
  scales::percent(0.1)

housing_loss_pct_picton_2021 <- 
  housing_loss_pct_EW_2021 %>% 
  filter(ward == "Picton") %>% 
  pull(housing_loss_per_dwelling) %>% 
  scales::percent(0.1)

housing_loss_pct_wellington_2021 <- 
  housing_loss_pct_EW_2021 %>% 
  filter(ward == "Wellington") %>% 
  pull(housing_loss_per_dwelling) %>% 
  scales::percent(0.1)

housing_loss_pct_bloomfield_2021 <- 
  housing_loss_pct_EW_2021 %>% 
  filter(ward == "Bloomfield") %>% 
  pull(housing_loss_per_dwelling) %>% 
  scales::percent(0.1)


```




## STR-induced housing loss

Prince Edward County’s (PEC) housing market has been under considerable stress in the past years, with housing prices and rents rising, and rental vacancy rates falling. These are symptoms of a market where the supply of housing is insufficient to meet demand. One possible explanation for both the insufficient supply and elevated demand for housing in PEC is the growth in short-term rentals. Tourists compete with residents for housing—adding demand to the local housing market—while landlords are able to shift their properties out of the conventional housing market to become dedicated STRs—reducing the supply of conventional housing. Research has found that renting a housing unit on the STR market frequently offers landlords greater potential revenue than conventional leases (Wachsmuth & Weisler 2018). Multiple studies have also found that Airbnb and other STR platforms increase housing costs (Barron, Kung, & Proserpio 2017; Horn & Merante 2017; Garcia-Lopez et al. 2019).

One of the major considerations when gauging the impacts of short-term rentals (STRs) on a specific location, therefore, is the extent to which STRs are removing long-term housing from the market. This process can occur either directly, where tenants of a unit are evicted or not replaced at the end of a lease and the unit is converted to a STR, or indirectly by absorbing new construction or investment properties which otherwise would have gone onto the long-term market. In a highly seasonal market like PEC, we can expect a number of housing units dedicated to the STR market only in the summer months, and then rented monthly in the longer-term market, or occupied by its owner, during the low season. To obtain the exact number of units that have been occupied as STRs, landlords or units would need to be individually surveyed, which is infeasible because STR hosts are mostly anonymous on major STR platforms such as Airbnb and VRBO. Instead, we use the daily activity of listings, alongside structural characteristics such as listing type and location, to estimate which listings are operating as dedicated STRs and are therefore not available as conventional long-term housing.

``` {r make_fig_2_10}

figure_2_10_fun <- function(regular = "", condensed = "") {
  
  seasonal_FREH %>% 
    ggplot() +
    geom_bar(aes(year_season, n, fill = season), stat= "identity")+
    theme(plot.title = element_text(size=10),
          legend.title = element_blank())+
  scale_fill_manual("legend", 
                    values = c("Year-round" = col_palette[3],
                               "Summer" = col_palette[1],
                               "Winter" = col_palette[2]))+
  scale_y_continuous(name = NULL, label = scales::comma) +
  theme_minimal()+
  xlab("")+
  ylab("")+
  theme(legend.title = element_blank(),
        legend.position = "bottom", 
        panel.grid.minor.x = element_blank(),
        text = element_text(face = "plain", family = regular),
        legend.text = element_text( size = 10, family = regular))

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_10.pdf"), 
         plot = figure_2_10_fun("Futura", "Futura Condensed"), 
         width = 8, height = 5, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_10.pdf"))
}

```


```{r para_1_2}

# Change in listings 2020
active_yoy_change <- 
  daily %>% 
  filter(housing, status != "B", date >= start_2019, 
         !c(date >= start_2020 & date <= end_2020)) %>% 
  group_by(year_2021 = str_starts(date, "2021")) %>% 
  summarize(active_listings = n() / yday(max(date)),
            avg_daily_revenue = sum(price[status == "R"]) / yday(max(date)), .groups = "drop") %>% 
  summarize(across(c(active_listings, avg_daily_revenue), ~{(.x[2] - .x[1]) / .x[1]}), .groups = "drop")

# YOY listing change
active_yoy_listings <- 
  active_yoy_change$active_listings %>% 
  {. * -1} %>% 
  scales::percent(accuracy = 0.1)

# FREH summer seasons pre-covid
summer_FREH_avg_pre <- 
seasonal_FREH %>% 
  filter(season == "Summer",
         str_detect(year_season, "2018|2019")) %>% 
  summarize(mean(n)) %>% 
  pull() %>% 
  round(digit = -1)

# How many summer FREH / all dwellings
summer_plateau_on_dwellings <- 
{summer_FREH_avg_pre / sum(EW$dwellings)} %>% 
  scales::percent(0.1)

# FREH summer seasons
summer_FREH_avg_2021 <- 
seasonal_FREH %>% 
  filter(season == "Summer",
         str_detect(year_season, "2021")) %>% 
  summarize(mean(n)) %>% 
  pull() %>% 
  round(digit = -1)

# How many summer FREH / all dwellings
summer_2021_on_dwellings <- 
{summer_FREH_avg_2021 / sum(EW$dwellings)} %>% 
  scales::percent(0.1)
  

```

As we saw in the previous chapter, PEC has a highly seasonal market. Some owner-occupiers might leave in the summer to take advantage of the high demand for STR, while they occupy their home in winter. A landlord can also take advantage of the STR market in the summer, and rent out their unit in the winter on a more longer-term market. We explored these possibilities by separating seasons: Summer months range from May to September included, and winter months from October to April. The number of full-time entire-homes active on the STR market in winter is at the same level than the FREH indicator. However, in the summer months, the number of full-time entire-home STR was around `r summer_FREH_avg_pre` in the summers of 2018 and 2019, what seems to be a plateau in PEC as no growth has been seen between these two years. This number was equivalent to `r summer_plateau_on_dwellings` of all dwellings in PEC. In the summer of 2021, the number of full-time STR was `r summer_FREH_avg_2021`, which is a significant increase on the 2020 level, but still below the pre-Covid level. It is the equivalent of `r summer_2021_on_dwellings` of all dwellings in PEC. Figure \@ref(fig:fig-2-10) showcases the beginning of a recovery for the commercially-operated STRs.  

``` {r fig-2-10, include = TRUE, fig.cap = '(ref:fig-2-10)', fig.align = "center"}

figure_2_10_fun()

```
(ref:fig-2-10) _Housing units operating on a full-time basis on the STR market of the Prince Edward County, per season_

```{r para_3_2}

after_180days_vrbo <- as.Date("2017-06-01") + days(180)

# End-of-year summaries
housing_loss_summaries <- 
  daily %>% 
  filter(housing, status != "B", listing_type %in% c("Entire home/apt",
                                                     "Private room")) %>% 
  group_by(date) %>% 
  summarize(eh = mean(FREH_6[listing_type == "Entire home/apt"]),
            pr = mean(GH[listing_type == "Private room"])) %>% 
  mutate(across(c(eh, pr), slide_dbl, mean, .before = 30)) %>% 
  filter(date >= after_180days_vrbo)

eh_housing_loss <- 
  housing_loss_summaries %>% 
  filter(date >= start_2021) %>% 
  pull(eh) %>% mean() %>% 
  scales::percent(0.1)

pr_housing_loss <- 
  housing_loss_summaries %>% 
  filter(date >= start_2021) %>% 
  pull(pr) %>% mean() %>% 
  scales::percent(0.1)

eh_housing_loss_pre_covid <- 
  housing_loss_summaries %>% 
  filter(date < start_2021) %>% 
  pull(eh) %>% mean() %>% 
  scales::percent(0.1)

pr_housing_loss_pre_covid <- 
  housing_loss_summaries %>% 
  filter(date < start_2021) %>% 
  pull(pr) %>% mean() %>% 
  scales::percent(0.1)


# Table for figure
housing_loss_share <- 
  daily %>% 
  filter(housing, 
         status != "B", 
         listing_type %in% c("Entire home/apt", "Private room")) %>% 
  group_by(date) %>% 
  summarize(
    `Entire home/apt` = mean(FREH_6[listing_type == "Entire home/apt"]),
    `Private room` = mean(GH[listing_type == "Private room"])) %>% 
  filter(date >= after_180days_vrbo) %>% 
  pivot_longer(-date, names_to = "Listing type", 
               values_to = "housing_loss_pct") %>% 
  group_by(`Listing type`) %>% 
  mutate(housing_loss_pct = slide_dbl(housing_loss_pct, mean, .before = 13))

avg_change_2019_2021 <- 
EW_housing_table %>% 
  summarize(
    dwellings = sum(dwellings),
    housing_loss_2019 = sum(housing_loss_2019),
    housing_loss_2021 = sum(housing_loss_2021),
    change_2019_2021 = (housing_loss_2021 - housing_loss_2019) / housing_loss_2019,
    housing_loss_pct_2021 = housing_loss_2021 / dwellings) %>% 
  mutate(ward = "PEC") %>% pull(change_2019_2021) %>% 
  scales::percent(accuracy = 0.1)


```


Table \@ref(tab:tab-4-1) summarizes STR-induced housing loss patterns by ward. It demonstrates that the County-wide trend of shrinking dedicated STRs due to the pandemic holds in all wards. The decline between pre-pandemic and 2021 levels in STR-induced housing loss has been evenly distributed between virtually all wards, with an average of `r avg_change_2019_2021`.

``` {r tab-4-1-2, include = TRUE}

library(kableExtra)

EW_housing_table %>% 
  summarize(
    dwellings = sum(dwellings),
    housing_loss_2019 = sum(housing_loss_2019),
    housing_loss_2021 = sum(housing_loss_2021),
    change_2019_2021 = (housing_loss_2021 - housing_loss_2019) / housing_loss_2019,
    housing_loss_pct_2021 = housing_loss_2021 / dwellings) %>% 
  mutate(ward = "PEC") %>% 
  bind_rows(EW_housing_table) %>% 
  relocate(ward) %>% 
  select(-dwellings) %>% 
  mutate(across(c(change_2019_2021, housing_loss_pct_2021), scales::percent, accuracy = 0.1)) %>%
  arrange(desc(housing_loss_2021)) %>%
  rename(Ward = ward,
         `Housing loss (2021)` = housing_loss_2021,
         `Housing loss (2019)` = housing_loss_2019,
         `Growth 2019-2021 (%)` = change_2019_2021,
         `% of housing lost (2021)` = housing_loss_pct_2021) %>% 
  kbl(caption = "STR-induced housing loss by ward in PEC",
      align = "lrrrr") %>%
  kable_styling(latex_options = "scale_down") %>%
  row_spec(1, background = paste0(col_palette[2], "50"))

```

``` {r make_fig_2_12}

figure_2_12_fun <- function(regular = "", condensed = "") {
  
  left_map <- 
    housing_loss_EW %>% 
    filter(date=="2021") %>% 
    ggplot() +
    geom_sf(data = province, colour = "transparent", fill = "grey93") +
    geom_sf(aes(fill = housing_loss_pct), colour = "white") +
    geom_sf(data = water, fill = "white", colour = "transparent") +
    scale_fill_gradientn(colors = col_palette[c(4, 3, 5)], 
                         na.value = "grey80",
                         limits = c(0, 0.03), oob = scales::squish, 
                         labels = scales::percent)  +
    guides(fill = guide_colourbar(title = "% housing\nlost to STR",
                                  title.vjust = 1)) + 
    gg_bbox(housing_loss_DA) +
    theme_void() +
    theme(text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold", 
                                      size = 7),
          legend.title.align = 0.9,
          legend.text = element_text(family = regular, size = 5))
  
  right_map <- 
    housing_loss_DA %>% 
    ggplot() +
    geom_sf(data = province, colour = "transparent", fill = "grey93") +
    geom_sf(aes(fill = housing_loss_pct), colour = "transparent") +
    geom_sf(data = water, fill = "white", colour = "transparent") +
    scale_fill_gradientn(colors = col_palette[c(4, 3, 5)], 
                         na.value = "grey80",
                         limits = c(0, 0.05), oob = scales::squish, 
                         labels = scales::percent)  +
    guides(fill = guide_colourbar(title = "% housing\nlost to STR",
                                  title.vjust = 1)) + 
    gg_bbox(housing_loss_DA) +
    theme_void() +
    theme(text = element_text(family = regular, face = "plain"),
          legend.title = element_text(family = regular, face = "bold", 
                                      size = 7),
          legend.title.align = 0.9,
          legend.text = element_text(family = regular, size = 5))
  
  left_map + right_map + plot_layout(guides = 'collect') & 
    theme(legend.position = "bottom")

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_2_12.pdf"), 
         plot = figure_2_12_fun("Futura", "Futura Condensed"), 
         width = 8, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_2_12.pdf"))
}

```

The `r housing_loss_2021` housing units taken off of PEC’s housing market in 2021 are `r housing_loss_pct_dwelling_2021` of the total amount of housing in the city, and this housing loss has been decentralized in all parts of the county. Figure \@ref(fig:fig-4-4) shows the proportion of each ward or dissemination area’s housing stock which was operated as a dedicated short-term rental in 2021. In Picton, `r housing_loss_pct_picton_2021` of all housing units were operating as dedicated STRs in 2021. The figure is `r housing_loss_pct_wellington_2021` for Wellington and `r housing_loss_pct_bloomfield_2021` for Bloomfield.


``` {r fig-2-12, include = TRUE, fig.cap = '(ref:fig-2-12)', fig.align = "center"}

figure_2_12_fun()

```

(ref:fig-2-12) _The percentage of housing units converted to dedicated STRs in PEC, by ward (L) and dissemination area (R)_





## Market supply's seasonal characteristics meets COVID-19


TKTKT MOVE THIS TO THE HOUSING IMPACTS CHAPTER

```{r para_3_3}


monthly_fulltime_str <-  function(start_date, end_date, cut = 25) {
daily %>% 
  filter(date >= start_date, date <= end_date, status != "B") %>% 
  group_by(month = lubridate::month(date, label =T, abbr = F)) %>% 
  count(property_ID) %>% 
  filter(n>=cut) %>%
  count(month, name = "fulltime_properties") %>% 
  mutate(month = str_to_sentence(month))
}

precovid <- monthly_fulltime_str("2019-01-01", "2020-01-01") %>% 
  rename(precovid_fulltime = fulltime_properties)

first_year_covid <- monthly_fulltime_str(max(daily$date)-months(12)+1, max(daily$date)+1) %>% 
  rename(covid_fulltime = fulltime_properties)

variation_df <- 
  left_join(precovid, first_year_covid) %>% 
  mutate(variation = (covid_fulltime - precovid_fulltime) / precovid_fulltime)

var_less_most_busy <- 
  scales::percent((max(precovid$precovid_fulltime) -
                     min(precovid$precovid_fulltime))/
                    min(precovid$precovid_fulltime))

correlation <- cor(variation_df$variation, variation_df$covid_fulltime) %>% 
  round(digits = 2)

```

``` {r tab-3-1, include = TRUE}

library(kableExtra)

variation_df %>% 
  mutate(variation = scales::percent(variation)) %>% 
  rename(Month = month,
         "2019" = precovid_fulltime,
         "Last 12 months" = covid_fulltime,
         "Variation (%)" = variation) %>% 
  kbl(caption = "Full-time STR on monthly basis",
      align = "lrrrrr") %>% 
  kable_styling(latex_options="scale_down") %>%
  column_spec(2,
              background = spec_color(variation_df$precovid_fulltime[1:12], alpha = 0.4, end = 0.7)) %>% 
    column_spec(3,
              background = spec_color(variation_df$covid_fulltime[1:12], alpha = 0.4, end = 0.7))

```

Table \@ref(tab:tab-3-1) shows the average number of properties that were, on a monthly basis, dedicated to the STR market. To be considered as dedicated STR on a monthly basis, a property needs to have at least 25 days of activity (either available or reserved) during the month. In 2019, the number of dedicated STR on a monthly basis ranged between `r min(precovid$precovid_fulltime)` and `r max(precovid$precovid_fulltime)`. The table demonstrates a strong seasonality pattern, as there is a difference of `r var_less_most_busy` between the most and the less busy months of 2019. 

The pandemic led to a major decrease in the number of dedicated monthly STR in Prince Edward County. In the last 12 months of data, from September 2020 through August 2021, we have seen constant decrease in the number of STR operating on a monthly full-time basis compared to 2019 levels. This can mean one of two things: either there were fewer bookings, or hosts blocked their calendars or deleted their listings. The latter explanation is more valid when considering the facts on the demand side of the market.

<!-- We found a very strong positive correlation (r = `r correlation`) between the number of full-time STR (monthly) during the first year after the outbreak, and the variation column. Indeed, the busiest month of that year were also those with the smallest decrease in the number of full-time STR on the territory. For example, the monthly peak of full-time STR after the outbreak was in September, and this month has seen a `r scales::percent(variation_df$variation[09], accuracy = 0.02)` decrease compared to the previous year. However, in the less busy month after the pandemic outbreak, February 2021, there was a decrease of `r scales::percent(variation_df$variation[02], accuracy = 0.02)` compared to the previous year. -->


\newpage
# Registration analysis

<style type="text/css">
  body{
  font-family: Futura, Helvetica, Arial;
}
</style>

<br>

```{r setup, include = FALSE, echo = FALSE}

library(here)
source(here("R", "01_startup.R"))

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# Function for checking file modifications
mtime <- function(files) lapply(Sys.glob(files), function(x) file.info(x)$mtime)

# Set this to TRUE to output PDF figures
build_figures <- FALSE

qload(here("output", "/geometry.qsm"))
qload(here("output", "/str_processed.qsm"))
STA <- qread(here("output", "/STA.qs"))


```


``` {r objects, include = T}

library(kableExtra)

start_reg <- as.Date("2019-11-04")
end_reg <- as.Date("2020-09-04")

# Get properties active during the period when the registration was into effect
reg_property <- 
  property %>% 
  filter(last_active >= start_reg) %>% 
  filter(created <= end_reg) %>% 
  st_transform(32618)

n_reg_property <- 
  reg_property %>% 
  nrow() %>% 
  prettyNum(",")

total_licenses_all <- 
  STA %>% 
  st_drop_geometry() %>% 
  nrow()

valid_STA <-
  STA %>% 
  st_drop_geometry() %>% 
  filter(!is.na(expiry)) %>% 
  filter(status== "Active" | status == "Expired") %>% 
  nrow()

n_valid_STA_bc <- 
  STA %>% 
  st_drop_geometry() %>% 
  filter(!is.na(expiry)) %>% 
  filter(status== "Active" | status == "Expired") %>% 
  filter(created <= end_reg) %>% 
  nrow()

# Number of licenses per ward 
valid_STA_bc <- 
  STA %>% 
  filter(!is.na(expiry)) %>% 
  filter(status== "Active" | status == "Expired") %>% 
  filter(created <= end_reg)


# Find property_IDs within the buffer of each license
ids <- 
  valid_STA_bc %>% 
  st_buffer(dist = 200) %>% 
  st_intersection(.,reg_property) %>% 
  st_drop_geometry() %>% 
  group_by(id) %>% 
  summarize(property_IDs = list(property_ID))

ids_sta_pid <- 
  ids %>% 
  nrow()

unique_PIDs <- 
  valid_STA_bc %>% 
  st_buffer(dist = 200) %>% 
  st_intersection(.,reg_property) %>% 
  st_drop_geometry() %>% 
  distinct(property_ID, .keep_all = TRUE) %>% 
  nrow()

# Number of license application by ward
picton_n_license <- 
  valid_STA_bc %>% 
  st_join(EW, .) %>% 
  st_drop_geometry() %>% 
  count(ward) %>% 
  arrange(desc(n)) %>% 
  slice(1) %>% 
  pull(n)

hallo_n_license <- 
  valid_STA_bc %>% 
  st_join(EW, .) %>% 
  st_drop_geometry() %>% 
  count(ward) %>% 
  arrange(desc(n)) %>% 
  slice(2) %>% 
  pull(n)

well_n_license <- 
  valid_STA_bc %>% 
  st_join(EW, .) %>% 
  st_drop_geometry() %>% 
  count(ward) %>% 
  arrange(desc(n)) %>% 
  slice(3) %>% 
  pull(n)

total_n_license <- 
  valid_STA_bc %>% 
  st_drop_geometry() %>% 
  nrow()


```

``` {r tab-5-1, include = TRUE}

library(kableExtra)

STA_bc %>% 
  st_join(EW, .) %>% 
  count(ward) %>% 
  st_drop_geometry() %>% 
  add_row(ward = "Prince Edward County",
          n = n_valid_STA_bc) %>% 
  arrange(desc(n)) %>% 
  rename(Ward = ward,
         `Number of STA licenses emitted` = n) %>% 
  kbl(caption = paste0("Number of active STA licenses by ward, 4 Nov. 2019 to 4 Sept. 2021"),
      align = "lrrrr") %>%
  kable_styling(latex_options = "scale_down") %>% 
  row_spec(1, background = paste0(col_palette[2], "50"))

  
```

On 9 October 2018, Prince Edward County's city council approved a by-law allowing the registration of short-term accommodations (STA) on its territory. The new licensing program requires STA hosts to acquire one license per accommodation, to be renewed annually. The license fees depend on the number of guest room within the accommodation. The density of STAs operating within the county is set for each zone or area of the County, based on the zoning by-law. The percentage of STAs out of total existing dwelling units is set at 15%, with varying radius thresholds depending on the zones. The County recognizes four different types of STAs: traditional B&Bs, where owner lives on site; partial or entire principal residence STAs; partial or entire secondary residence STAs; and on-farm tourist homes. The licensing system came into effect in November 2019. The Covid-related travel restrictions started in the month of March 2020, with a moratorium on STA licensing established by the County on 30 September 2020. The STA registration was reinstated in the County for traditional B&Bs and principal residence STA on 22 June 2021, leaving other types of STAs accommodation still enable to be granted a license. The following chapter provides an analysis of Prince Edward County's STA licensing system in relation to short-term rentals.

# Overview of STA licenses

Since the coming into effect of the licensing system, a total of `r total_licenses_all` license applications were received. Out of the total applications, `r valid_STA` were approved, with `r n_valid_STA_bc` of them occurring prior to the moratorium on STA licenses. The ward that received the most applications was Picton with `r picton_n_license`, followed by Hallowell with `r hallo_n_license` license applications, and Wellington with `r well_n_license` (Table \@ref(tab:tab-5-1)). `r ids_sta_pid` of the `r valid_STA_bc` short-term accommodations with valid licenses had one or more STR property within a 200-meter buffer of their address (Airbnb and VRBO obfuscate listing locations by shifting them randomly up to 200 m). A total of `r unique_PIDs` active during the period of operation of the licensing system were located within the `r ids_sta_pid` STA buffers (a total of `r n_reg_property` properties were active on STR platforms during the same time period). Those matches will be further explored below.

```{r STA_portrait, include = T}



```


```{r, include = T}


```


```{r, include = T}


```


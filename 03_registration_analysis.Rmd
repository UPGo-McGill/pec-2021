# Registration analysis

<style type="text/css">
  body{
  font-family: Futura, Helvetica, Arial;
}
</style>

<br>

```{r setup, include = FALSE, echo = FALSE}

library(here)
source(here("R", "01_startup.R"))

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# Function for checking file modifications
mtime <- function(files) lapply(Sys.glob(files), function(x) file.info(x)$mtime)

# Set this to TRUE to output PDF figures
build_figures <- TRUE

qload(here("output", "/geometry.qsm"))
qload(here("output", "/str_processed.qsm"))
STA <- qread(here("output", "/STA.qs"))

```
``` {r objects, include = TRUE}

start_reg <- as.Date("2019-11-04")
end_reg <- as.Date("2020-09-04")
start_mora <- as.Date("2020-09-05")
end_mora <- as.Date("2021-06-22")

# Get properties active during the period when the registration was into effect
reg_property <- 
  property %>% 
  filter(scraped >= start_reg) %>% 
  st_transform(32618)

n_reg_property <- 
  reg_property %>% 
  nrow() %>% 
  prettyNum(",")

total_licenses_all <- 
  STA %>% 
  st_drop_geometry() %>% 
  nrow()

p_registration_compliance <- 
  (total_licenses_all/ reg_property %>% nrow()) %>% scales::percent(accuracy = 0.1)

valid_STA <-
  STA %>% 
  st_drop_geometry() %>% 
  filter(!is.na(expiry)) %>% 
  filter(status== "Active" | status == "Expired") %>% 
  nrow()

n_valid_STA_bc <- 
  STA %>% 
  st_drop_geometry() %>% 
  filter(!is.na(expiry)) %>% 
  filter(status == "Active" | status == "Expired") %>% 
  filter(created <= end_reg) %>% 
  nrow()

# Number of licenses per ward 
valid_STA_bc <- 
  STA %>% 
  filter(!is.na(expiry)) %>% 
  filter(status== "Active" | status == "Expired") %>% 
  filter(created <= end_reg)


# Find property_IDs within the buffer of each license
ids <- 
  valid_STA_bc %>% 
  st_buffer(dist = 200) %>% 
  st_intersection(.,reg_property) %>% 
  st_drop_geometry() %>% 
  group_by(id) %>% 
  summarize(property_IDs = list(property_ID))

ids_sta_pid <- 
  ids %>% 
  nrow()

unique_PIDs <- 
  valid_STA_bc %>% 
  st_buffer(dist = 200) %>% 
  st_intersection(.,reg_property) %>% 
  st_drop_geometry() %>% 
  distinct(property_ID, .keep_all = TRUE) %>% 
  nrow()

# Number of license application by ward
picton_n_license <- 
  valid_STA_bc %>% 
  st_join(EW, .) %>% 
  st_drop_geometry() %>% 
  count(ward) %>% 
  arrange(desc(n)) %>% 
  slice(1) %>% 
  pull(n)

hallo_n_license <- 
  valid_STA_bc %>% 
  st_join(EW, .) %>% 
  st_drop_geometry() %>% 
  count(ward) %>% 
  arrange(desc(n)) %>% 
  slice(2) %>% 
  pull(n)

well_n_license <- 
  valid_STA_bc %>% 
  st_join(EW, .) %>% 
  st_drop_geometry() %>% 
  count(ward) %>% 
  arrange(desc(n)) %>% 
  slice(3) %>% 
  pull(n)

total_n_license <- 
  valid_STA_bc %>% 
  st_drop_geometry() %>% 
  nrow()


```

On 9 October 2018, Prince Edward County's city council approved a bylaw regulating STAs in its territory. The bylaw require STA hosts to acquire one license per accommodation, to be renewed annually, with license fees depending on the number of guestrooms within the accommodation. The County recognizes four different types of STAs: traditional B&Bs, where the owner lives on site; partial or entire principal-residence STAs; partial or entire secondary-residence STAs; and on-farm tourist homes. The bylaw does not set any restrictions on any of these categories, but it sets a maximum density of STAs for each zone or area of the County, and limits the total number of STAs County-wide to 15% of existing dwelling units. The licensing system came into effect in November 2019; as of that date, all STAs needed to be registered with the County. Covid-related travel restrictions were imposed in March 2020, and the County issued a moratorium on STA licensing on 30 September 2020. STA registration was reinstated for traditional B&Bs and principal-residence STAs on 22 June 2021, but the moratorium has remained in place for secondary-residence STAs, which therefore are currently unable to be licensed. The following chapter provides an overview of compliance with the STA licensing system, and the possible impact of the licensing moratorium on the reduced supply of STAs during the pandemic.


## STA license uptake and compliance

```{r daily_compliance}

dates <- list()

for(i in 1:nrow(STA)){
  if (!is.na(STA$expiry[i])) {
      dates[[i]] <- list(as.Date(
    STA[i,]$created:STA[i,]$expiry, origin = "1970-01-01"))
  }
}

active_license <- 
tibble(date = as.Date(unlist(dates), origin = "1970-01-01")) %>% 
  count(date) %>% 
  mutate(group = "Active Licenses")

compliance_perc <- 
daily %>% 
  filter(status != "B",
         date >= min(active_license$date)) %>% 
  count(date, name = "strs") %>% 
  left_join(tibble(date = as.Date(unlist(dates), origin = "1970-01-01")) %>% 
  count(date, name = "licenses")) %>% 
  filter(licenses > 1) %>% 
  arrange(date) %>% 
  mutate(perc = if_else(licenses / strs > 1, 1, licenses / strs)) %>% 
  summarize(mean(perc)) %>% 
  pull() %>% 
  scales::percent(0.1)


```

```{r make_fig_3_1}

figure_3_1_fun <- function(regular = "", condensed = "") {

daily %>% 
  filter(status != "B",
         date >= min(active_license$date)) %>% 
  count(date) %>% 
  mutate(group = "STAs") %>% 
  bind_rows(active_license) %>% 
  arrange(date) %>% 
  group_by(group) %>%
  mutate(n = slide_dbl(n, mean, .before = 6, .complete = TRUE)) %>%
  ungroup() %>%
  mutate(label = if_else(date == "2020-03-01", group, NA_character_)) %>% 
  ggplot() +
  geom_line(aes(date, n, colour = group), size = 1) +
  geom_label(aes(date, n, label = label, colour = group)) +
  scale_color_manual(values = c(col_palette[2], col_palette[1])) +
  xlim(c(min(active_license$date), max(daily$date))) +
  theme_minimal() +
  ylab("") +
  xlab("") +
  theme(legend.title = element_blank(), legend.position = "none",
        panel.grid.minor.x = element_blank())
  
}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_1.pdf"), 
         plot = figure_3_1_fun(), 
         width = 9, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_1.pdf"))
}

```

Since the start of the registration in November 2019, a total of `r n_reg_property` listings have been posted on Airbnb or Vrbo in Prince Edward County. During the same time period, there have been `r total_licenses_all` license applications. In theory, each of listings should be registered, which suggests an overall compliance rate of `r p_registration_compliance`. In reality compliance is likely somewhat better than this, since there will be some duplicate listings on STA platforms which only correspond to a single STA registration (although we have attempted to detect and remove any such cases already), but broadly speaking it is possible to conclude that a weak majority of STA hosts have either complied or are in the process of complying with the registration system. A somewhat more positive perspective emerges from comparing the number of active STAs each day with the number of active licenses on that same day (Figure \@ref(fig:fig-3-1)). On average each day since the registration system began, `r compliance_perc` of active listings were potentially operating with an active license. 

``` {r fig-3-1, include = TRUE, fig.cap = '(ref:fig-3-1)', fig.align = "center"}

figure_3_1_fun()

```
(ref:fig-3-1) _Active STA licenses in circulation compared to active STRs_

Out of the `r total_licenses_all` total applications received by the County, `r valid_STA` were approved, with `r n_valid_STA_bc` of them occurring prior to the moratorium on STA licenses. The ward that received the most applications was Picton with `r picton_n_license`, followed by Hallowell with `r hallo_n_license`, and Wellington with `r well_n_license` (Table \@ref(tab:tab-3-1)). `r ids_sta_pid` of the `r total_n_license` short-term accommodations with valid licenses had one or more STR property within a 200-meter buffer of their address (Airbnb and Vrbo obfuscate listing locations by shifting them randomly up to 200 m on their websites), which strongly suggests that most licensed properties are in fact hosting an active STA. 

``` {r tab-3-1, include = TRUE}

library(kableExtra)

STA %>% 
  filter(!is.na(expiry)) %>% 
  filter(status== "Active" | status == "Expired") %>% 
  filter(created <= end_reg) %>%
  st_join(EW, .) %>% 
  count(ward) %>% 
  st_drop_geometry() %>% 
  add_row(ward = "Prince Edward County",
          n = n_valid_STA_bc) %>% 
  arrange(desc(n)) %>% 
  rename(Ward = ward,
         `STA licenses issued` = n) %>% 
  kbl(caption = paste0("Number of active STA licenses by ward, 4 Nov. 2019 to 4 Sept. 2021"),
      align = "lrrrr") %>%
  kable_styling(latex_options = "scale_down") %>% 
  row_spec(1, background = paste0(col_palette[2], "50"))
  
```


```{r STA_portrait, include = TRUE}

# Entire apt vs not entire apt
n_entire_apt <- 
  valid_STA_bc %>% 
  st_drop_geometry() %>% 
  filter(!is.na(entire_apt)) %>% 
  count(entire_apt) %>% 
  filter(entire_apt == TRUE) %>% 
  pull(n)

n_not_entire_apt <- 
  valid_STA_bc %>% 
  st_drop_geometry() %>% 
  filter(!is.na(entire_apt)) %>% 
  count(entire_apt) %>% 
  filter(entire_apt == FALSE) %>% 
  pull(n)

n_created_reg <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(housing == TRUE) %>% 
  filter(created >= start_reg, created <= end_mora) %>% 
  group_by(created >= start_mora) %>% 
  summarize(n = n()) %>% 
  set_names(c("during_mora", "n")) %>% 
  filter(during_mora == FALSE) %>% 
  pull(n)

n_created_mora <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(housing == TRUE) %>% 
  filter(created >= start_reg, created <= end_mora) %>% 
  group_by(created >= start_mora) %>% 
  summarize(n = n()) %>% 
  set_names(c("during_mora", "n")) %>% 
  filter(during_mora == TRUE) %>% 
  pull(n)

n_created_post_mora <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(housing == TRUE) %>% 
  filter(created >= end_mora) %>% 
  nrow()

```

Out of the `r n_valid_STA_bc` STAs operating with a license during the 10 months in which the registration system was functioning, `r n_entire_apt` licenses were for entire-home properties, or housing units entirely operated as a STA. Most licensed accommodations (`r n_not_entire_apt`) were not entire housing units, but rather a portion of a property or a traditional short-term accommodation, such as a hotel or a camp site. One third (`r scales::percent(mean(STA$bedrooms == 3), 0.1)`) of licenses were issued for accommodations with 3 bedrooms. Close to a quarter (`r scales::percent(mean(STA$bedrooms == 2), 0.1)`) were for 2-bedroom accommodations and more than a quarter (`r scales::percent(mean(STA$bedrooms >= 4), 0.1)`) were for 4-or-more-bedroom accommodations. 


## The effect of the STA registration system on the STR market

```{r make_fig_3_2}

figure_3_2_fun <- function(regular = "", condensed = "") {
  
created_dates <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(created >= "2019-01-01") %>% 
  mutate(period = case_when(
    created < start_reg ~ "pre-reg",
    created < start_mora ~ "reg",
    created < end_mora ~ "moratorium",
    created >= end_mora ~ "post-moratorium"
  )) %>% 
  group_by(period) %>% 
  summarize(first_date = min(created),
            last_date = max(created), 
            tot_n = n(),
            avg = n() / as.numeric(max(created) - min(created) + 1))

property %>% 
  st_drop_geometry() %>% 
  count(created) %>% 
  mutate(period = case_when(
    created < start_reg ~ "pre-reg",
    created < start_mora ~ "reg",
    created < end_mora ~ "moratorium",
    created >= end_mora ~ "post-moratorium"
  )) %>% 
  filter(created >= start_2019) %>% 
  ggplot() +
  annotate("rect", xmin = start_reg, xmax = end_reg, fill = col_palette[1],
           ymin = -Inf, ymax = Inf, alpha = 0.2) +
  annotate("rect", xmin = start_mora, xmax = end_mora, fill = col_palette[2],
           ymin = -Inf, ymax = Inf, alpha = 0.2) +
  geom_line(aes(created, n, colour = period), size = 0.4, alpha = 0.2) +
  geom_label(aes(x = mean(c(start_reg, start_mora)), y = 8,
                label = "STA registration\nin effect", fill = "white"), 
             colour = col_palette[1], inherit.aes = FALSE, hjust = 0.5) +
  geom_label(aes(x = mean(c(start_mora, end_mora)), y = 8,
                label = "STA registration\nmoratorium", fill = "white"), 
             colour = col_palette[2], inherit.aes = FALSE, hjust = 0.5) +
  geom_segment(aes(x = first_date, xend = last_date, y = avg, yend = avg,
                   colour = period, group = period), data = created_dates,
               lwd = 2) +
  scale_x_date(name = NULL) +
  scale_y_continuous(name = NULL, limits = c(0, 10)) +
  scale_colour_manual(values = col_palette[c(2, 3, 3, 1)]) +
  scale_fill_manual(values = "white") +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank())

}

if (build_figures) {
  ggsave(here("output", "figures", "figure_3_2.pdf"), 
         plot = figure_3_2_fun(), 
         width = 9, height = 4.2, units = "in", useDingbats = FALSE)
  
  extrafont::embed_fonts(here("output", "figures", "figure_3_2.pdf"))
}

```

The STA registration system operated from November 2019 to September 2020, up until Prince Edward County's city council voted on a STA registration moratorium amidst the Covid-19 pandemic (Countylive 2020). No new short-term rental accommodations were technically allowed to be created in Prince Edward County from the end of September 2020. The STA registration moratorium was lifted in the end of June 2021 for bed & breakfasts and owner-occupied STRs only (Countylive 2021). Looking at Figure \@ref(fig:fig-3-2), we can see the number of new properties created on Airbnb and/or VRBO per day, both during the STA registration period and the STA registration moratorium. The number of listings being created started to decrease at the end of 2019. During the 10-month STA registration period, a total of `r n_created_reg` new STR listings operating out of housing units were created. In the following 7-month moratorium, `r n_created_mora` new listings were created, with an additional `r n_created_post_mora` in the partial partial moratorium period, spanning from June 2021 to the end of August (the end of the available data). Both the registration and the moratorium did not seem to have a direct effect on the creation of new STRs, which has remained similar in both periods studied. However, we can see that a resurgence of new listings being created occurred during the 2021 peak season.

``` {r fig-3-2, include = TRUE, fig.cap = '(ref:fig-3-2)', fig.align = "center"}

figure_3_2_fun()

```
(ref:fig-3-2) _Number of new STR properties created by day, 7-day rolling average_

```{r STA_STR_analysis, include = T}

STA_by_status <- 
  STA %>%
  st_buffer(., 200) %>% 
  filter(created >= "2020-09-05") %>% 
  st_join(property %>% filter(created >= "2020-09-05")) %>% 
  st_drop_geometry() %>% 
  group_by(id, status, entire_apt) %>% 
  summarize(strs = list(property_ID)) 

n_STA_post_mora <- 
  STA_by_status %>% 
  nrow()

p_pending_post_mora <- 
  STA_by_status %>% 
  group_by(status) %>% 
  summarize(n = n(), perc = n/n_STA_post_mora) %>% 
  filter(status == "Pending") %>% 
  pull(perc) %>% 
  scales::percent(accuracy = 0.1)

p_active_post_mora <- 
  STA_by_status %>% 
  group_by(status) %>% 
  summarize(n = n(), perc = n/n_STA_post_mora) %>% 
  filter(status == "Active") %>% 
  pull(perc) %>% 
  scales::percent(accuracy = 0.1)

p_entire_home <- 
  STA_by_status %>% 
  group_by(entire_apt) %>% 
  summarize(n = n(), perc = n/n_STA_post_mora) %>% 
  filter(entire_apt == TRUE) %>% 
  pull(perc) %>% 
  scales::percent(accuracy = 0.1)

PID_STA <- 
  STA_by_status %>% 
  filter(!is.na(strs)) %>% 
  nrow()

p_STA_PID_active <- 
  STA_by_status %>% 
  filter(!is.na(strs)) %>% 
  group_by(status) %>% 
  summarize(n=n(), perc = n/PID_STA) %>% 
  filter(status == "Active") %>% 
  pull(perc) %>% 
  scales::percent(accuracy = 0.1)

PIDs_post_mora <- 
  STA %>%
  st_buffer(., 200) %>% 
  filter(created >= "2020-09-05") %>% 
  st_join(property %>% filter(created >= "2020-09-05")) %>% 
  st_drop_geometry() %>% 
  filter(!is.na(property_ID)) %>% 
  distinct(property_ID, .keep_all=TRUE) %>% 
  pull(property_ID)

PIDS_post_mora_total <- 
  daily %>% 
  filter(property_ID %in% PIDs_post_mora) %>% 
  group_by(property_ID) %>% 
  summarize(n_total = n())

PIDS_post_mora_status <- 
  daily %>% 
  filter(property_ID %in% PIDs_post_mora) %>% 
  group_by(property_ID, status) %>% 
  summarize(n_status = n()) %>% 
  left_join(., PIDS_post_mora_total, by = "property_ID") %>% 
  mutate(perc = n_status / n_total)

grouped_status_PIDS_post_mora <- 
  PIDS_post_mora_status %>% 
  group_by(status) %>% 
  summarize(perc = mean(perc, na.rm=TRUE))

p_R_post_mora <- 
  grouped_status_PIDS_post_mora %>% 
  filter(status == "R") %>% 
  pull(perc) %>% 
  scales::percent(accuracy = 0.1)

p_A_post_mora <- 
  grouped_status_PIDS_post_mora %>% 
  filter(status == "A") %>% 
  pull(perc) %>% 
  scales::percent(accuracy = 0.1)

p_B_post_mora <- 
  grouped_status_PIDS_post_mora %>% 
  filter(status == "B") %>% 
  pull(perc) %>% 
  scales::percent(accuracy = 0.1)

```

Out of the `r n_STA_post_mora` license applications that were received since the moratorium, one third (`r p_entire_home`) were for STAs operated out of an entire housing unit, with the remainder being owner-occupied STAs or traditional STA accommodations, such as B&Bs. About half (`r p_pending_post_mora`) of these applications were still pending and`r p_active_post_mora` of the applications have been approved. We have managed to identify `r PID_STA` applications out of the `r n_STA_post_mora` (more than half) whose 200-m buffers comprised at least one new property being created on STR platforms following the STA license application. Despite the registration moratorium, most of these newly-created properties were active during the moratorium, and yet only `r p_STA_PID_active` of the license applications found within the buffer have been approved. On average, the STR listings found within the properties having applied after the moratorium have been reserved `r p_R_post_mora` of the nights since their creation, available for reservations `r p_A_post_mora` of the nights, and blocked for reservations `r p_B_post_mora` of the time. 

## How is the STA market related to Prince Edward County's housing market?

The STA registration database enabled the analysis of the license applications with the house sales that occurred from 2016 to today. This acts a an indicator of the contribution of short-term rental to the County's current housing situation. Have properties been sold to then apply to become a STA? Or conversely, have properties been converted into STAs, and then sold on the market as short-term rental investment properties? 

```{r, include = T}

home_sales <- qread(here("output", "home_sales.qs"),
                              nthreads = availableCores())

sold_before_created <- 
home_sales %>% 
  st_drop_geometry() %>% 
  left_join(STA, by = "address") %>% 
  filter(!is.na(id)) %>%
  filter(sale_date <= created) %>% 
  count(address) %>% 
  nrow()

per_sold_before_created <- 
{sold_before_created / nrow(STA)} %>% 
  scales::percent(0.1)

sold_before_created_covid <- 
home_sales %>% 
  st_drop_geometry() %>% 
  left_join(STA, by = "address") %>% 
  filter(!is.na(id)) %>%
  filter(sale_date <= created,
         sale_date >= "2020-03-14") %>% 
  count(address) %>% 
  nrow()

per_sold_before_created_covid <- 
{sold_before_created_covid / nrow(STA)} %>% 
  scales::percent(0.1)

created_before_sale <- 
home_sales %>% 
  st_drop_geometry() %>% 
  left_join(STA, by = "address") %>% 
  filter(!is.na(id)) %>%
  filter(sale_date >= created) %>% 
  count(address) %>% 
  nrow()

total_sales <- 
  home_sales %>% 
  st_drop_geometry() %>% 
  mutate(year = year(sale_date)) %>% 
  count(year) %>% 
  set_names(c("year", "total"))

survival_factor <- 
  property %>% 
  st_drop_geometry() %>% 
  filter(scraped > created, str_starts(property_ID, "ab-")) %>% 
  group_by(year_created = year(created)) %>% 
  summarize(still_active = mean(scraped >= "2019-11-01")) %>% 
  filter(year_created >= 2016)

proportion_home_sales_STA <-
  home_sales %>% 
  st_drop_geometry() %>% 
  inner_join(STA, by = "address") %>% 
  filter(sale_date <= created) %>% 
  mutate(year = year(sale_date)) %>% 
  count(year) %>% 
  left_join(total_sales, by = "year") %>% 
  mutate(perc = n/total,
         perc_adjusted = perc/(total_licenses_all/ reg_property %>% nrow())) %>% 
  left_join(survival_factor, by = c("year" = "year_created")) %>% 
  mutate(perc_adj_2 = perc_adjusted / still_active)

```


There are `r sold_before_created` housing units that were sold since 2016 that then applied for a STA license during the application period. Out of all the `r total_licenses_all` license applications received by the county, about a third (`r per_sold_before_created`) of them were for housing units that were bought after January 2016. More recently, `r sold_before_created_covid` (`r per_sold_before_created_covid` of all license applications) were for houses bought after March 2020, when Covid hit and fueled the surge in housing demand and sale prices. Registrations being linked to newly bought housing units shows that a number of units are bought with the purpose of turning them in STRs. There was also a number of STA license applications (`r created_before_sale`) that were received for properties that were then sold shortly after. Considering that STA licensing is granfathered even through property sales, those housing units were most likely sold as an investment property operating as a short-term rental.
